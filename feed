<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.2.2">Jekyll</generator><link href="https://void-shana.moe//feed" rel="self" type="application/atom+xml" /><link href="https://void-shana.moe//" rel="alternate" type="text/html" /><updated>2022-06-04T21:59:22+08:00</updated><id>https://void-shana.moe//feed</id><title type="html">VOID001â€™s WOWO</title><subtitle>Thinking, Coding, Improving</subtitle><entry><title type="html">ä¸€ä¸ªç”±é”™è¯¯çš„ä½¿ç”¨ String Piece å¯¼è‡´çš„ Use After Free é—®é¢˜æ’æŸ¥</title><link href="https://void-shana.moe//posts/string-piece-uaf" rel="alternate" type="text/html" title="ä¸€ä¸ªç”±é”™è¯¯çš„ä½¿ç”¨ String Piece å¯¼è‡´çš„ Use After Free é—®é¢˜æ’æŸ¥" /><published>2022-06-04T00:00:00+08:00</published><updated>2022-06-04T00:00:00+08:00</updated><id>https://void-shana.moe//posts/string-piece-uaf</id><content type="html" xml:base="https://void-shana.moe//posts/string-piece-uaf"><![CDATA[<h1 id="tldr">TL;DR</h1>

<ul>
  <li>æ„é€  <code class="language-plaintext highlighter-rouge">StringPiece</code> çš„æ—¶å€™è¦ä¿è¯ä»–åº•å±‚çš„ string ç”Ÿå‘½å‘¨æœŸæ¯” <code class="language-plaintext highlighter-rouge">StringPiece</code> é•¿</li>
  <li>Address Sanitizer is your friend</li>
  <li>From my friend: äººç”Ÿè‹¦çŸ­ï¼Œè¯·ç”¨ Clang</li>
</ul>

<h1 id="background">Background</h1>

<p>StringPiece (or <code class="language-plaintext highlighter-rouge">absl::string_view</code> <code class="language-plaintext highlighter-rouge">std::string_view</code>) ä»–ä»¬éƒ½æ˜¯ä¸ºäº†è®©å¼€å‘è€…å¯ä»¥è®¿é—®è€Œä¸æŒæœ‰(own) ä¸€ä¸ªå­—ç¬¦ä¸²è€Œå‡†å¤‡çš„ä¾¿åˆ© utilityï¼Œä½†æ˜¯é”™è¯¯çš„ä½¿ç”¨ä»–ä»¬å¯èƒ½ä¼šå¯¼è‡´å¾ˆå±é™©çš„å†…å­˜é—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç </p>

<p>ï¼ˆä»¥ absl::string_view åœ¨ C++14 ä¸Šçš„å®ç°ä¸ºå‡†ï¼‰</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span> <span class="cpf">"absl/strings/string_view.h"</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="o">&gt;</span> <span class="n">StringViewPair</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s1</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s2</span><span class="p">;</span>
  <span class="n">s1</span> <span class="o">=</span> <span class="s">"Good Morning Evil </span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="s">"Good Evening Evil </span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">StringViewPair</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%p %p %p %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s1</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s2</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è¿™æ®µä»£ç çœ‹èµ·æ¥ç¨€æ¾å¹³å¸¸ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ª string s1, s2, åœ¨å †ä¸Šåˆ†é…äº†ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç©ºé—´ï¼Œç„¶åä½¿ç”¨è¿™ä¸¤ä¸ª string ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code class="language-plaintext highlighter-rouge">std::make_pair</code> æ„é€ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">absl::string_view</code> çš„ pair,</p>

<p>è¿è¡Œè¿™æ®µä»£ç ï¼Œä¼šå‘ç°è¾“å‡ºçš„å†…å®¹å‡ºç°äº†ä¹±ç /ä¸å®Œæ•´ç­‰é—®é¢˜ï¼Œ</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">(</span>ã£ãƒ»Ï‰ãƒ»<span class="o">)</span>ã£ ./demo                                                                                                                                                                                                                                                                                                 remote âš›
XÑ–
</code></pre></div></div>

<p>è¿™é‡Œçš„è¾“å‡ºå’Œæˆ‘ä»¬çš„å­—ç¬¦ä¸²å®Œå…¨å¯¹ä¸ä¸Šï¼Œæ•é”çš„è¯»è€…å¯èƒ½çœ‹åˆ°è¿™é‡Œå·²ç»æƒ³åˆ°äº†æ˜¯ pair.first / pair.second çš„ data æŒ‡å‘çš„å†…å­˜å‡ºç°äº†é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å…ˆæŠŠå„ä¸ª str çš„ data æŒ‡é’ˆéƒ½æ‰“å‡ºæ¥çœ‹çœ‹ï¼ŒæŒ‰ç…§æˆ‘ä»¬çš„æƒ³æ³•ä»¥åŠ <code class="language-plaintext highlighter-rouge">absl::string_view</code> çš„å®ç°ï¼Œè¿™ä¸ª <code class="language-plaintext highlighter-rouge">StringViewPair</code> åº”è¯¥å­˜äº† s1, s2 çš„åº•å±‚æŒ‡é’ˆï¼Œä½†æ˜¯æ‰“å°å‡ºæ¥çš„å­—ç¬¦ä¸²å´æ˜¯ dirty çš„</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">string_view</span> <span class="p">{</span>
<span class="c1">// ...</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Allocator</span><span class="p">&gt;</span>
  <span class="n">string_view</span><span class="p">(</span>  <span class="c1">// NOLINT(runtime/explicit)</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Allocator</span><span class="o">&gt;&amp;</span> <span class="n">str</span>
          <span class="n">ABSL_ATTRIBUTE_LIFETIME_BOUND</span><span class="p">)</span> <span class="k">noexcept</span>
      <span class="c1">// This is implemented in terms of `string_view(p, n)` so `str.size()`</span>
      <span class="c1">// doesn't need to be reevaluated after `ptr_` is set.</span>
      <span class="c1">// The length check is also skipped since it is unnecessary and causes</span>
      <span class="c1">// code bloat.</span>
      <span class="o">:</span> <span class="n">string_view</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">SkipCheckLengthTag</span><span class="p">{})</span> <span class="p">{}</span>
<span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="debugging">Debugging</h1>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢çš„ sample ä»£ç ä¸­æ·»åŠ ä¸€è¡Œä»£ç  (ä¸Šé¢çš„ sample ä¸­å·²æ·»åŠ )</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"%p %p %p %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s1</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s2</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</code></pre></div></div>

<p>åœ¨æˆ‘æœ¬åœ°çš„è¾“å‡ºå¦‚ä¸‹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x60300000efe0 0x60300000efb0 0x60300000ef80 0x60300000ef50
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç° <code class="language-plaintext highlighter-rouge">s1.data()</code> å’Œ <code class="language-plaintext highlighter-rouge">pair.first.data()</code> ä»–ä»¬ä¸¤ä¸ªçš„å†…å­˜åœ°å€å¹¶ä¸ç›¸åŒï¼Œè¿™è¯´æ˜ï¼Œåœ¨ make pair çš„æ—¶å€™ï¼Œå¯èƒ½å‘ç”Ÿäº†å†…å­˜æ‹·è´ï¼Œé€šè¿‡æŸ¥é˜… <a href="https://en.cppreference.com/w/cpp/utility/pair/make_pair">cppreference</a> æˆ‘ä»¬å¾—åˆ°äº†å¦‚ä¸‹çš„è§£é‡Š</p>

<blockquote>
  <p>The deduced types <code class="language-plaintext highlighter-rouge">V1</code> and <code class="language-plaintext highlighter-rouge">V2</code> are <a href="http://en.cppreference.com/w/cpp/types/decay">std::decay</a><T1>::type and [std::decay](http://en.cppreference.com/w/cpp/types/decay)<T2>::type (the usual type transformations applied to arguments of functions passed by value) unless application of [std::decay](https://en.cppreference.com/w/cpp/types/decay) results in [std::reference_wrapper](http://en.cppreference.com/w/cpp/utility/functional/reference_wrapper)<X> for some type `X`, in which case the deduced type is `X&amp;`.</X></T2></T1></p>

</blockquote>

<p>çœ‹èµ·æ¥ï¼Œmake_pair åœ¨è¿›è¡Œç±»å‹æ¨æ–­çš„æ—¶å€™ï¼Œä¼šå°†å‚æ•°ç±»å‹æ¨æ–­åï¼ŒæŒ‰ç…§å€¼çš„æ–¹å¼ä¼ é€’ï¼Œè€ŒéæŒ‰ç…§å¼•ç”¨çš„æ–¹å¼ä¼ é€’ï¼Œå› è€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå†…å­˜å‘ç”Ÿäº†æ‹·è´</p>

<p>åˆ†æ C++ å†…å­˜ç›¸å…³é—®é¢˜çš„åˆ©å™¨å°±æ˜¯ <strong>AddressSanitizer</strong> (ASAN), æˆ‘ä»¬æŒ‚ä¸Š ASAN è·‘è¿™ä¸ªç¨‹åºæ¥çœ‹ç»“æœå¦‚ä½•ï¼Œåœ¨æ„å»ºå‚æ•°ä¸­æ·»åŠ  <code class="language-plaintext highlighter-rouge">-fsanitize=address</code> åå†æ¬¡è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œå¾—åˆ°äº†å¦‚ä¸‹çš„è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x60300000efe0 0x60300000efb0 0x60300000ef80 0x60300000ef50
=================================================================
==2649769==ERROR: AddressSanitizer: heap-use-after-free on address 0x60300000ef80 at pc 0x7f951d7295ce bp 0x7ffde4a9d470 sp 0x7ffde4a9cc20
READ of size 2 at 0x60300000ef80 thread T0
    #0 0x7f951d7295cd  (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8a5cd)
    #1 0x7f951d729d8a in vprintf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ad8a)
    #2 0x7f951d729e47 in __interceptor_printf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ae47)
    #3 0x55c93507994e in main /data04/playground/cpp/string-piece-uaf/main.cc:19
    #4 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
    #5 0x55c935079669 in _start (/data04/playground/cpp/string-piece-uaf/build/demo+0x2669)

0x60300000ef80 is located 0 bytes inside of 20-byte region [0x60300000ef80,0x60300000ef94)
freed by thread T0 here:
    #0 0x7f951d7621f0 in operator delete(void*) (/usr/lib/x86_64-linux-gnu/libasan.so.3+0xc31f0)
    #1 0x55c935079e54 in std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt;::~pair() /usr/include/c++/6/bits/stl_pair.h:194
    #2 0x55c9350798b3 in main /data04/playground/cpp/string-piece-uaf/main.cc:16
    #3 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)

previously allocated by thread T0 here:
    #0 0x7f951d761bf0 in operator new(unsigned long) (/usr/lib/x86_64-linux-gnu/libasan.so.3+0xc2bf0)
    #1 0x7f951d018116 in void std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::_M_construct&lt;char*&gt;(char*, char*, std::forward_iterator_tag) (/usr/lib/x86_64-linux-gnu/libstdc++.so.6+0x120116)
    #2 0x7ffde4a9d5cf  (&lt;unknown module&gt;)
    #3 0x5  (&lt;unknown module&gt;)

SUMMARY: AddressSanitizer: heap-use-after-free (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8a5cd)
Shadow bytes around the buggy address:
  0x0c067fff9da0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9db0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9dc0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9dd0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9de0: fa fa fa fa fa fa fa fa fa fa fd fd fd fa fa fa
=&gt;0x0c067fff9df0:[fd]fd fd fa fa fa 00 00 00 07 fa fa 00 00 00 07
  0x0c067fff9e00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==2649769==ABORTING
</code></pre></div></div>

<p>å¯¹äºä¸ç†Ÿæ‚‰ ASAN çš„è¯»è€…ï¼Œä¸Šé¢çš„è¾“å‡ºæœ€åˆçœ‹å¯èƒ½æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œæˆ‘ä»¬æ¥å…³æ³¨ä¸€ä¸‹é‡ç‚¹éƒ¨åˆ†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==2649769==ERROR: AddressSanitizer: heap-use-after-free on address 0x60300000ef80 at pc 0x7f951d7295ce bp 0x7ffde4a9d470 sp 0x7ffde4a9cc20
</code></pre></div></div>

<p>é¦–å…ˆæœ€å‰é¢åˆ—å‡ºäº†è¿›ç¨‹IDï¼Œç„¶åæ˜¯é”™è¯¯çš„ç±»å‹ <code class="language-plaintext highlighter-rouge">heap-use-after-free</code> æ˜¯ä¸€ä¸ªå †ä¸Šå†…å­˜åœ¨é‡Šæ”¾ååˆè¢«ä½¿ç”¨çš„é”™è¯¯ï¼Œå…·ä½“çš„åœ°å€æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯ <code class="language-plaintext highlighter-rouge">pair.first.data()</code> ï¼Œç»§ç»­æŸ¥çœ‹ ASAN çš„è¾“å‡º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>READ of size 2 at 0x60300000ef80 thread T0
    #0 0x7f951d7295cd  (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8a5cd)
    #1 0x7f951d729d8a in vprintf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ad8a)
    #2 0x7f951d729e47 in __interceptor_printf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ae47)
    #3 0x55c93507994e in main /data04/playground/cpp/string-piece-uaf/main.cc:19
    #4 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
    #5 0x55c935079669 in _start (/data04/playground/cpp/string-piece-uaf/build/demo+0x2669)

</code></pre></div></div>

<p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå¿½ç•¥ Stack Trace ä¿¡æ¯ï¼Œæ¥çœ‹ä¸¤ä¸ªå…³é”®ç‚¹</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>READ of size 2 at 0x60300000ef80 thread T0
</code></pre></div></div>

<p>è¯´æ˜äº†ï¼Œè¿™ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">heap-use-after-free</code> é—®é¢˜çš„è§¦å‘æ˜¯ç”±è¯»å–è¿™ä¸ªå†…å­˜è€Œå¯¼è‡´çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå†…å­˜åœ¨å“ªé‡Œè¢«é‡Šæ”¾äº†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x60300000ef80 is located 0 bytes inside of 20-byte region [0x60300000ef80,0x60300000ef94)
freed by thread T0 here:
    #0 0x7f951d7621f0 in operator delete(void*) (/usr/lib/x86_64-linux-gnu/libasan.so.3+0xc31f0)
    #1 0x55c935079e54 in std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt;::~pair() /usr/include/c++/6/bits/stl_pair.h:194
    #2 0x55c9350798b3 in main /data04/playground/cpp/string-piece-uaf/main.cc:16
    #3 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
</code></pre></div></div>

<p>æ ¹æ®è¿™ä¸ª Call Traceï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¯¹åº”åˆ°ï¼Œåœ¨ä»£ç  <code class="language-plaintext highlighter-rouge">main.cc</code>  L16 çš„ä½ç½®ï¼Œè¿™ä¸ª basic string ï¼ˆä¹Ÿå°±æ˜¯ <code class="language-plaintext highlighter-rouge">std::string</code> å°±è¢«é‡Šæ”¾æ‰äº†ã€‚</p>

<h1 id="analyze">Analyze</h1>

<p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æœ€åˆçš„ä»£ç ç‰‡æ®µï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†, <code class="language-plaintext highlighter-rouge">std::make_pair</code> ä¼š copy ä¸¤ä¸ª string <code class="language-plaintext highlighter-rouge">s1</code> <code class="language-plaintext highlighter-rouge">s2</code>å¹¶ä¸”äº§ç”Ÿä¸€ä¸ª <code class="language-plaintext highlighter-rouge">std::pair&lt;std::string, std::string&gt;</code> å°†ä»–ä»¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç­‰å·å·¦è¾¹çš„ <code class="language-plaintext highlighter-rouge">StringViewPair</code> ï¼Œè€Œç­‰å·å·¦è¾¹çš„ StringViewPair ä¸ own è¿™ä¸¤å—å†…å­˜ï¼Œåªæ˜¯ä¿å­˜ä¸€ä¸ªåˆ°ä»–ä»¬çš„ Referenceï¼Œå› è€Œï¼Œå½“è¿™ä¸ªæ„é€ ç»“æŸåï¼Œç­‰å·å³è¾¹çš„ <code class="language-plaintext highlighter-rouge">std::pair&lt;std::string, std::string&gt;</code> å°±è¢«é‡Šæ”¾æ‰ï¼Œå› è€Œè¿™ä¸¤ä¸ªæ‹·è´å‡ºæ¥çš„ <code class="language-plaintext highlighter-rouge">std::string</code> çš„å†…å­˜ä¹Ÿéšä¹‹è¢«é‡Šæ”¾æ‰ï¼ˆå¦‚ ASAN çš„è¾“å‡ºï¼‰</p>

<p>å› æ­¤å°±å¯¼è‡´äº† heap use after free é—®é¢˜çš„å‘ç”Ÿ</p>

<h1 id="solution">Solution</h1>

<h2 id="1">#1</h2>

<p>å› ä¸º C++ ä»…èƒ½æ ¹æ®å³å€¼è¿›è¡Œç±»å‹æ¨æ–­ï¼Œä¸åƒ Rust é‚£æ ·èªæ˜ï¼Œå¯ä»¥æ ¹æ®å³å€¼ä»¥åŠè¯¥å˜é‡çš„ä½¿ç”¨æ–¹å¼è¿›è¡Œç±»å‹æ¨æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„è§£æ³•ä¹‹ä¸€å°±æ˜¯ï¼Œåœ¨ make pair çš„æ—¶å€™ç»™å‡ºç±»å‹</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StringViewPair</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="o">&lt;</span><span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
</code></pre></div></div>

<p>è¿™æ ·ï¼Œåœ¨ make pair çš„æ—¶å€™å°±ä¼šå¾—çŸ¥æˆ‘ä»¬éœ€è¦çš„æ˜¯ <code class="language-plaintext highlighter-rouge">std::pair&lt;absl::string_view, absl::string_view&gt;</code> è€Œé <code class="language-plaintext highlighter-rouge">std::pair&lt;std::string, std::string&gt;</code> , ä»è€Œç›´æ¥æ ¹æ®æ‰€ç»™çš„å‚æ•°è°ƒç”¨ <code class="language-plaintext highlighter-rouge">absl::string_view</code> æ„é€ å‡½æ•°ï¼Œå°† s1, s2 è½¬ä¸º <code class="language-plaintext highlighter-rouge">const std::string&amp;</code> ä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œé¿å…äº†å°† s1 s2 æ‹·è´å‡ºä¸€ä¸ªä¸´æ—¶çš„å­—ç¬¦ä¸²</p>

<h2 id="2">#2</h2>

<p>ä½†æ˜¯ä¸Šé¢è¿™ç§æ”¹æ³•ä¼šè®©ä½ çš„ Linter æŠ±æ€¨èµ·æ¥</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build/explicit_make_pair: For C++11-compatibility, omit template arguments from make_pair OR use pair directly OR if appropriate, construct a pair directly
</code></pre></div></div>

<p>å› è€Œè¿™é‡Œè¿˜æœ‰ä¸€ç§æ›´ä¸ºç¾è§‚çš„æ”¹æ³•ï¼Œå‚è€ƒ cppreference ä¸Šé¢å¯¹äº <code class="language-plaintext highlighter-rouge">make_pair</code> çš„æè¿°ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">std::ref</code> å°†ä¸¤ä¸ªå¯¹è±¡ <code class="language-plaintext highlighter-rouge">s1</code> <code class="language-plaintext highlighter-rouge">s2</code>è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">std::string&amp;</code> ï¼ˆå®é™…ä¸Šæ˜¯è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">reference_wrapper&lt;std::string&gt;</code> ï¼‰ï¼Œä»è€Œå®ç°ç›¸åŒçš„æ•ˆæœå¹¶ä¸”é¿å…äº† Linter çš„è­¦å‘Š</p>

<h1 id="misc">Misc</h1>

<p>æœ¬æ–‡ä¸­å±•ç°çš„è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯ StringPiece / string_view çš„ä¸€ä¸ªä½¿ç”¨é™·é˜±ï¼Œå¹¶ä¸”ç›®å‰æ²¡æœ‰å¾ˆå¥½çš„ç¼–è¯‘æœŸæ£€æŸ¥å‡ºè¿™ç§é—®é¢˜çš„æ–¹æ³•</p>

<p><a href="https://github.com/isocpp/CppCoreGuidelines/issues/1038">https://github.com/isocpp/CppCoreGuidelines/issues/1038</a></p>

<p>Github ä¸Šå¯¹äºæ­¤é—®é¢˜çš„è®¨è®ºï¼Œæœ€ç»ˆæ­¢äº</p>

<blockquote>
  <p>the use-after-free potential withÂ <code class="language-plaintext highlighter-rouge">string_view</code>
Â is accounted for in the Lifetime profile, even if there may be bugs or limitations in preliminary implementations that mean it is not diagnosed.</p>

</blockquote>

<p>å› è€Œï¼Œåœ¨ C++ å¼€å‘ä¸­ï¼Œ<strong>å°† address sanitizer æ—¶åˆ»ä¿æŒå¼€å¯ï¼Œæ˜¯å¾ˆé‡è¦çš„</strong>ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å‘ç°å¾ˆå¤šç¼–è¯‘æœŸæ— æ³•æ£€æŸ¥å‡ºçš„é—®é¢˜</p>

<p>é‚£ä¹ˆåˆ°è¿™é‡Œäº†ï¼Œæœ¬æ–‡è¿˜æœ‰ä¸€ä¸ªç»“è®ºæ²¡æœ‰è§£é‡Š</p>

<blockquote>
  <p>From my friend: äººç”Ÿè‹¦çŸ­ï¼Œè¯·ç”¨ Clang</p>

</blockquote>

<p>å¯¹ä¸€äº›å¥‡æ€ªçš„ GCC Clang è¡¨ç°æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç»§ç»­é˜…è¯»ï¼Œå•çº¯æ¥äº†è§£ StringPiece pitfall çš„æœ‹å‹å¯ä»¥åœ¨è¿™é‡Œåœä¸‹äº†ï¼Œä¸‹é¢è¦ä»‹ç»çš„å†…å®¹å¯èƒ½æ¯”è¾ƒé»‘æš—</p>

<h2 id="darkness-moment">Darkness Moment</h2>

<p>ä¸ºäº†ç»§ç»­æˆ‘ä»¬çš„æ—…ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å¤§å®¶æœ‰å¤šç§ç¼–è¯‘å™¨ï¼Œè¿™æ—¶å€™å°±åº”è¯¥æ‹¿å‡º godbolt åœ¨çº¿ç¼–è¯‘å™¨å¹³å°äº†</p>

<p>å› ä¸ºæˆ‘æ²¡èƒ½å¤Ÿåœ¨ godbolt é‡ŒæˆåŠŸå¼•ç”¨ absl å¹¶æ„å»ºå‡ºäºŒè¿›åˆ¶ï¼Œåœ¨ godbolt é‡Œå°† absl::string_view æ›¿æ¢ä¸ºäº† leveldb çš„ <code class="language-plaintext highlighter-rouge">Slice</code> ï¼Œå› ä¸ºå„ç±» <code class="language-plaintext highlighter-rouge">string_view</code> çš„å®ç°ï¼Œå°¤å…¶æ˜¯æ„é€ å‡½æ•°çš„å®ç°éƒ½å¾ˆç±»ä¼¼ï¼Œå› è€Œæˆ‘ä»¬çš„é—®é¢˜åœ¨ <code class="language-plaintext highlighter-rouge">Slice</code> ä¸Šä¹Ÿå¯ä»¥å¾—åˆ°å¤ç°</p>

<p><a href="https://godbolt.org/z/rcvs55zfa">https://godbolt.org/z/rcvs55zfa</a></p>

<p>ä¸Šé¢è¿™ä¸ªé“¾æ¥é‡Œæ”¾äº†ç±»ä¼¼äºæˆ‘ä»¬æœ¬æ–‡ä¸­æè¿°çš„ use after free é—®é¢˜çš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°åœ¨ GCC çš„æŸäº›ç‰¹å®šç‰ˆæœ¬ä¸‹ï¼ŒASAN ç«Ÿç„¶æ²¡æœ‰æŠ¥é”™</p>

<p><img src="/assets/imgs/string-piece-uaf1.png" alt="" /></p>

<p>è€Œå½“æˆ‘ä»¬ç¨åŠ ä¿®æ”¹ L117, å»æ‰ â€œ\nâ€ ä¹‹åï¼Œ asan åˆè¾“å‡ºäº†</p>

<p><img src="/assets/imgs/string-piece-uaf2.png" alt="" /></p>

<p>ç»è¿‡ä¸€ç•ªæ’æŸ¥ï¼Œå‘ç°ï¼Œæ˜¯ç”±ä¸¤ä¸ªåŸå› å¯¼è‡´çš„</p>

<ol>
  <li>æŸäº›ç‰ˆæœ¬çš„ GCCï¼ˆå¦‚ 6.3ï¼‰ä¼šå°† <code class="language-plaintext highlighter-rouge">printf("%s\n");</code> åœ¨ç¼–è¯‘æ—¶è½¬å˜ä¸ºå¯¹ <code class="language-plaintext highlighter-rouge">puts</code> çš„è°ƒç”¨(å¯ä»¥æŸ¥çœ‹ godbolt çš„æ±‡ç¼–ä»£ç è¿›è¡Œç¡®è®¤)</li>
  <li>è€Œ 6.3 çš„ GCC çš„ libasan.so æ°å¥½æ²¡æœ‰å¯¹ <code class="language-plaintext highlighter-rouge">puts</code> è¿›è¡Œ hook</li>
</ol>

<p>å› è€Œå¯¼è‡´äº†ä¸Šè¿°æƒ…å†µçš„å‘ç”Ÿï¼Œä¹Ÿå°±è¯´æ˜äº† ASAN å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæƒ³è¦é¿å…ä¸€åˆ‡å†…å­˜é—®é¢˜ï¼Œè¿˜æ˜¯è¦é ç¨‹åºå‘˜è‡ªèº«çš„æœ¬äº‹ï¼ˆğŸ¤¦â€â™€ï¸ï¼‰</p>

<p>åŒæ—¶æˆ‘ä»¬è¿˜æ³¨æ„åˆ°åœ¨ L114 è¡Œæœ‰ä¸€ä¸ªæ³¨é‡Šï¼Œå½“ä½¿ç”¨ GCC ç‰ˆæœ¬ä½äº 5.0 æ—¶ï¼ˆå¦‚ 4.9.3ï¼‰è¿™ä¸ªå­—ç¬¦ä¸²æ ¹æœ¬ä¸ä¼šè¢« Copyï¼Œç»“æœå°±å¯¼è‡´äº† <code class="language-plaintext highlighter-rouge">s1</code> å’Œ <code class="language-plaintext highlighter-rouge">pair.first</code> æŒ‡å‘äº†ç›¸åŒçš„å­—ç¬¦ä¸²åœ°å€ç©ºé—´ã€‚è¿™æ˜¯å› ä¸ºåœ¨ GCC 5.0 ä»¥ä¸‹ï¼Œå¯¹äºå­—ç¬¦ä¸²æ‹·è´çš„ä¼˜åŒ–ï¼ŒGCC ä½¿ç”¨çš„æ˜¯ COWï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä»£ç åœ¨åˆ›å»ºäº† <code class="language-plaintext highlighter-rouge">pair.first</code> åæ²¡æœ‰å¯¹å­—ç¬¦ä¸²æœ‰ä»»ä½•å†™æ“ä½œï¼Œå› è€Œä»–ç›´æ¥å’Œ <code class="language-plaintext highlighter-rouge">s1</code> å…±ç”¨äº†å†…å­˜ï¼Œä¹Ÿå°±æ²¡æœ‰ heap-use-after-free è¿™ä¸ªé—®é¢˜äº†ã€‚</p>

<h1 id="ending">Ending</h1>

<p>æœ¬æ–‡çš„äº§å‡ºç¦»ä¸å¼€å‡ ä¸ªæœ‹å‹çš„å¸®åŠ©ï¼Œæ„Ÿè°¢ Weiï¼Œå¯æ€œç­‰æœ‹å‹å¸®å¿™ä¸€èµ· Debug å¥‡æ€ªçš„ ASAN ä¸èƒ½ work çš„é—®é¢˜ï¼ˆçœŸçš„ Debug äº†ä¸¤å¤©æ‰æ‰¾å‡ºé—®é¢˜ã€‚ã€‚ï¼Œæœ¬æ¥è¿™ä¸ªåšå®¢åªéœ€è¦åŠå¤©æ—¶é—´å°±å†™å‡ºæ¥äº†ï¼Œç»“æœæäº†ä¸¤å¤©ï¼‰</p>]]></content><author><name></name></author><summary type="html"><![CDATA[TL;DR]]></summary></entry><entry><title type="html">ä½¿ç”¨ sync point å¯¹å¤šçº¿ç¨‹åº”ç”¨è¿›è¡Œå¯æ§çš„å¹¶å‘æµ‹è¯•</title><link href="https://void-shana.moe//posts/sync-point" rel="alternate" type="text/html" title="ä½¿ç”¨ sync point å¯¹å¤šçº¿ç¨‹åº”ç”¨è¿›è¡Œå¯æ§çš„å¹¶å‘æµ‹è¯•" /><published>2022-04-09T22:00:27+08:00</published><updated>2022-04-09T22:00:27+08:00</updated><id>https://void-shana.moe//posts/sync-point</id><content type="html" xml:base="https://void-shana.moe//posts/sync-point"><![CDATA[<blockquote>
  <p>åœ¨æµ‹è¯•å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæ„é€ ä¸€äº›å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ test case ç”¨æ¥æµ‹è¯•æ˜¯å¦æœ‰ race condition æˆ–è€… unexpected behavior å‡ºç°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¼€å‘è€…å¯èƒ½ä¼šå°†å¤šä¸ª function å¹¶å‘æ‰§è¡Œ N æ¬¡ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æœ€ç»ˆç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œè¿™å¯èƒ½å¯¹äºå¤§å¤šæ•°æƒ…å†µæ˜¯è¶³å¤Ÿçš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å·²ç»é€šè¿‡æ’æŸ¥é—®é¢˜å‘ç°äº†ä¸€ä¸ªå› ä¸º race çš„åŸå› å¯¼è‡´çš„ Bug çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆéš¾é€šè¿‡ä¸Šè¿°é€šå¸¸çš„æ–¹æ³•å»é‡ç°å®ƒã€‚ä¸ºäº†èƒ½å¤Ÿæ„é€ å‡ºè¿è¡Œé¡ºåºå®Œå…¨å¯æ§çš„å¹¶å‘åœºæ™¯æµ‹è¯• caseï¼Œrocksdb  å®ç°äº†ä¸€å¥—æµ‹è¯•å·¥å…· SyncPointï¼Œä»¥æ­¤æ¥è§£å†³ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡ä»‹ç» rocksdb SyncPoint çš„ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠå…¶å®ç°åŸç†ã€‚</p>
</blockquote>

<h1 id="syncpoint-api">SyncPoint API</h1>
<p>é¦–å…ˆä»‹ç» SYNC POINT çš„ API æ¥å£, æ¥å£å®šä¹‰åœ¨ <code class="language-plaintext highlighter-rouge">test_util/sync_point.h</code> å†…ï¼š</p>

<pre><code class="language-C++">void LoadDependency(const std::vector&lt;SyncPointPair&gt;&amp; dependencies);
void SetCallBack(const std::string&amp; point,
                const std::function&lt;void(void*)&gt;&amp; callback);
void EnableProcessing();
void DisableProcessing();
void Process(const Slice&amp; point, void* cb_arg = nullptr);
</code></pre>

<p>SyncPoint è¢«ä½œä¸ºä¸€ä¸ªå•ä¾‹å®šä¹‰åœ¨æ•´ä¸ª Project å†…ï¼Œå¹¶æä¾›å¦‚ä¸‹å‡ ä¸ªå®å®šä¹‰ç®€åŒ–ç”¨æˆ·çš„ä½¿ç”¨ï¼š</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT(name)</code>: åœ¨ä»£ç ä¸­å®šä¹‰ä¸€ä¸ª SyncPoint</li>
  <li><code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT_CALLBACK(name, cbarg)</code>: åœ¨ä»£ç ä¸­å®šä¹‰ä¸€ä¸ªå¯ä»¥è¿›è¡Œå›è°ƒçš„ SYNC POINT, å›è°ƒå‡½æ•° <code class="language-plaintext highlighter-rouge">cb</code> é€šè¿‡ <code class="language-plaintext highlighter-rouge">SetCallback</code> æ³¨å†Œç»™è¯¥ SyncPoint, å¹¶ä¸”åœ¨è¿™ä¸ªå®è¢«æ‰§è¡Œçš„æ—¶å€™ä»¥ <code class="language-plaintext highlighter-rouge">cb(cbarg)</code> çš„å½¢å¼è°ƒç”¨</li>
  <li><code class="language-plaintext highlighter-rouge">TEST_IDX_SYNC_POINT(name, idx)</code>: åªæ˜¯å°† <code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT</code> ä¸­çš„ â€œnameâ€ æ¢æˆäº† â€œnameâ€ + â€œidxâ€ çš„å­—ç¬¦ä¸², å…¶ä»–å®ç°ä¸ <code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT</code> å®Œå…¨ç›¸åŒ</li>
</ul>

<p>æˆ‘ä»¬ç»“åˆä¸‹é¢çš„ä¾‹å­ä»‹ç»ä¸‹ SyncPoint API çš„ä½¿ç”¨æ–¹æ³•</p>

<h1 id="examples">Examples</h1>

<h2 id="1-ä½¿ç”¨-syncpoint-å®ç°å¤šçº¿ç¨‹ä»£ç æŒ‰ç…§å›ºå®šé¡ºåºæ‰§è¡Œ">1. ä½¿ç”¨ SyncPoint å®ç°å¤šçº¿ç¨‹ä»£ç æŒ‰ç…§å›ºå®šé¡ºåºæ‰§è¡Œ</h2>

<p>ä¸ºäº†ç®€åŒ–å®ç°ä»¥åŠçªå‡º SyncPoint çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬é€‰ç”¨ä¸€ä¸ª Hello World ä¾‹å­æ¥ä»‹ç» SyncPoint: ä½¿ç”¨ä¸¤ä¸ªå¹¶å‘è¿è¡Œçš„ Thread æŒ‰é¡ºåºè¾“å‡º 1 - 4 çš„æ•°å­—</p>

<pre><code class="language-CPP">void Fun1() {
   printf("1\n");
   TEST_SYNC_POINT("SyncPointDemo::Fun1:1");
   TEST_SYNC_POINT("SyncPointDemo::Fun1:4");
   printf("4\n");
}

void Fun2() {
    TEST_SYNC_POINT("SyncPointDemo::Fun2:2");
    printf("2\n");
    printf("3\n");
    TEST_SYNC_POINT("SyncPointDemo::Fun2:3");
}
</code></pre>

<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæ˜¯ä¸¤ä¸ªæ‰“å°å‡½æ•° Fun1, Fun2. åœ¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ä¸­è®¾ç½®äº†æ€»å…± 4 ä¸ª SyncPoint, æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦ç¼–å†™æµ‹è¯•æ¥å®šä¹‰ SyncPoint ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼ˆå…ˆåé¡ºåºï¼‰ï¼š</p>

<pre><code class="language-CPP">TEST(SyncPointDemoTest, SequentialPrintNumbers) {
    ROCKSDB_NAMESPACE::SyncPoint::GetInstance()-&gt;EnableProcessing(); 
    ROCKSDB_NAMESPACE::SyncPoint::GetInstance()-&gt;LoadDependency(
        {{"SyncPointDemo::Fun1:1", "SyncPointDemo::Fun2:2"}, 
         {"SyncPointDemo::Fun2:3", "SyncPointDemo::Fun1:4"}});
    std::thread t1(Fun1);
    std::thread t2(Fun2);
    t1.join();
    t2.join();
    SyncPoint::GetInstance()-&gt;DisableProcessing();
}
</code></pre>

<p>å…³æ³¨è¿™é‡Œçš„ <code class="language-plaintext highlighter-rouge">LoadDependency</code> å‡½æ•°ï¼Œä»–æ¥å—ä¸€ç³»åˆ—çš„ <code class="language-plaintext highlighter-rouge">SyncPointPair</code>, æ¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">SyncPointPair</code> <code class="language-plaintext highlighter-rouge">{u, v}</code> å¯ä»¥çœ‹ä½œæ˜¯ä¸€æ¡æœ‰å‘è¾¹ ` [u] -&gt; [v] ` è¡¨æ˜ <code class="language-plaintext highlighter-rouge">u</code> å‘ç”Ÿåœ¨ <code class="language-plaintext highlighter-rouge">v</code> ä¹‹å‰ã€‚ åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸ºäº†æ–¹ä¾¿åœ¨æµ‹è¯•é‡Œå¼•ç”¨é¢„å…ˆå®šä¹‰å¥½çš„å¤§é‡ SyncPoint ï¼Œæˆ‘ä»¬ä¼šå¯¹æ¯ä¸€ä¸ª SyncPoint èµ‹äºˆæœ‰æ„ä¹‰çš„åå­—ã€‚è¿™é‡Œæˆ‘ä»¬å°±é€šè¿‡ <code class="language-plaintext highlighter-rouge">LoadDependency</code> æ„å»ºäº†å¦‚ä¸‹çš„ä¾èµ–å…³ç³»</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[SyncPointDemo::Fun1:1] -&gt; [SyncPointDemo::Fun2:2]
[SyncPointDemo::Fun2:3] -&gt; [SyncPointDemo::Fun1:4]
</code></pre></div></div>

<p>è€Œå› ä¸ºåœ¨åŒä¸€ä¸ª Thread å†…ï¼Œ <code class="language-plaintext highlighter-rouge">SyncPointDemo::Fun2:2</code> ä¸€å®šä¼šåœ¨ <code class="language-plaintext highlighter-rouge">SyncPointDemo::Fun2:3</code> ä¹‹å‰ï¼Œæ‰€ä»¥å››ä¸ª SyncPoint çš„ä¾èµ–å…³ç³»å›¾ä¸ºä¸€æ¡é“¾</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[SyncPointDemo::Fun1:1] -&gt; [SyncPointDemo::Fun2:2] -&gt; [SyncPointDemo::Fun2:3] -&gt; [SyncPointDemo::Fun1:4]
</code></pre></div></div>

<p>å› è€Œï¼Œç¨‹åºçš„æœ€ç»ˆè¾“å‡ºå—åˆ° SyncPoint çš„æ§åˆ¶ï¼Œä¼šå§‹ç»ˆä¸º â€œ1\n2\n3\n4\nâ€ã€‚
<code class="language-plaintext highlighter-rouge">EnableProcessing</code> å‡½æ•°ä¼šå¼€å¯ SyncPoint çš„åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬åœ¨æµ‹è¯•å…¥å£å¤„ä¸è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œåˆ™ SyncPoint ä¸ä¼šç”Ÿæ•ˆï¼Œä¹Ÿå°±ä¼šçœ‹åˆ°ä¹±åºçš„è¾“å‡ºç»“æœã€‚åŒç† <code class="language-plaintext highlighter-rouge">DisableProcessing</code> åœæ­¢ <code class="language-plaintext highlighter-rouge">SyncPoint</code> çš„å¤„ç†ã€‚</p>

<h2 id="2-ä½¿ç”¨-test_sync_point_callback-å®ç°åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­æ§åˆ¶ç‰¹å®šå‡½æ•°çš„è¿”å›å€¼">2. ä½¿ç”¨ TEST_SYNC_POINT_CALLBACK å®ç°åœ¨æµ‹è¯•ç”¨ä¾‹ä¸­æ§åˆ¶ç‰¹å®šå‡½æ•°çš„è¿”å›å€¼</h2>

<p>åœ¨è¿è¡Œå„ç§å•å…ƒæµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›æµ‹è¯•ä¸€äº›å‡½æ•°çš„å¼‚å¸¸è¿”å›æƒ…å†µæ˜¯å¦èƒ½å¤Ÿè¢«æ­£ç¡®å¤„ç†ï¼Œè€Œä¸€ä¸ªå‡½æ•°çš„å¼‚å¸¸è¿”å›æƒ…å†µå¯èƒ½æœ‰å¤šç§ï¼Œå› è€Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ç§æ–¹ä¾¿çš„ç¼–ç æ‰‹æ®µ+æµ‹è¯•å·¥å…·æ¥æ³¨å…¥ä¸åŒçš„é”™è¯¯ç ï¼Œä¸‹é¢è¿™æ®µä¾‹å­å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ <code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT_CALLBACK</code> åœ¨ç‰¹å®šæµ‹è¯•ä¸­ç»™æŸå‡½æ•°æ³¨å…¥é”™è¯¯ç :</p>

<pre><code class="language-CPP">int do_somthing() {
    int retval = 0;

    // complex logic here
    ...

    // When executing to this point, the callback will be invoked with argument `retval`
    TEST_SYNC_POINT_CALLBACK("SyncPointDemo::retval_inject", &amp;retval);

    return retval;
}
</code></pre>

<p>å‡å®šæˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•° <code class="language-plaintext highlighter-rouge">do_something</code>, ä»–ä¼šå®Œæˆè‹¥å¹²å·¥ä½œåè¿”å› <code class="language-plaintext highlighter-rouge">int</code> ç±»å‹çš„é”™è¯¯ç ç»™è°ƒç”¨è€…ï¼Œè€Œè°ƒç”¨è€…ä¼šæ ¹æ®ä¸åŒçš„é”™è¯¯ç è¿›è¡Œä¸åŒçš„å¤„ç†ï¼Œæˆ‘ä»¬ç°åœ¨å¸Œæœ›åœ¨æµ‹è¯•ä¸­è¦†ç›–æ‰é”™è¯¯ç ï¼Œè®©å®ƒåœ¨æœ¬æµ‹è¯•ä¸­æ°¸è¿œè¿”å› <code class="language-plaintext highlighter-rouge">-1</code>, åˆ™ç¼–å†™å¦‚ä¸‹çš„æµ‹è¯•ä»£ç ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TEST(SyncPointDemoTest, CallbackSetErrorCode) {
    SyncPoint::GetInstance()-&gt;EnableProcessing();
    std::function&lt;void(void*)&gt; cb = [] (void *arg) -&gt; void {
      int *ptr = static_cast&lt;int *&gt;(arg);
      *ptr = -1;
    };
    SyncPoint::GetInstance()-&gt;SetCallBack("SyncPointDemo::retval_inject", cb);

    auto p = do_something();
    ASSERT_EQ(p, -1);
}
</code></pre></div></div>

<p>è¿™ä¸ªæµ‹è¯•ç¨‹åºä¼šé€šè¿‡æµ‹è¯•ï¼Œ<code class="language-plaintext highlighter-rouge">p</code> çš„å€¼è¢«æ”¹å†™ä¸º <code class="language-plaintext highlighter-rouge">-1</code>. æˆ‘ä»¬æ¥çœ‹ <code class="language-plaintext highlighter-rouge">SetCallback</code> è¿™ä¸ªå‡½æ•°ï¼Œå®ƒä¼šå¯¹ä¸€ä¸ªç»™å®šçš„ SyncPoint è®¾ç½® Callback è°ƒç”¨ï¼ŒCallback å‡½æ•°çš„ç­¾åä¸º <code class="language-plaintext highlighter-rouge">void(void *)</code>, å› è€Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ª lambda å‡½æ•° <code class="language-plaintext highlighter-rouge">cb</code> å¯¹é”™è¯¯ç è¿›è¡Œæ”¹å†™ï¼Œå½“ä¸Šè¿°å‡½æ•° <code class="language-plaintext highlighter-rouge">do_something</code> æ‰§è¡Œåˆ° <code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT_CALLBACK</code> çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ <code class="language-plaintext highlighter-rouge">cb</code> å¹¶ä¸”å°† <code class="language-plaintext highlighter-rouge">&amp;retval</code> å†…å­˜å¤„çš„å€¼ä¿®æ”¹ä¸º <code class="language-plaintext highlighter-rouge">-1</code>. ä»¥æ­¤æ–¹æ³•å®ç°äº†é”™è¯¯ç çš„æ³¨å…¥ã€‚</p>

<p>SyncPoint çš„çµæ´»æ€§ä½¿å¾—å®ƒçš„åŠŸèƒ½è¿œä¸æ­¢æˆ‘æ‰€ Demo çš„è¿™äº›ï¼Œrocksdb åœ¨æ„å»ºä¸€äº›ç‰¹å®šçš„ Transaction Sequence çš„æµ‹è¯•ç”¨ä¾‹ä¸­ä¹Ÿå¤§é‡çš„ä½¿ç”¨äº† Sync Pointï¼ŒåŒæ—¶ <code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT_CALLBACK</code> å®šä¹‰çš„ SyncPoint çš„é¡ºåºä¹Ÿæ˜¯å¯ä»¥ <code class="language-plaintext highlighter-rouge">LoadDependency</code> æ§åˆ¶çš„</p>

<h1 id="syncpoint-internals">SyncPoint Internals</h1>

<p>SyncPoint çš„åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹ä»–çš„å®ç°, ä»–çš„åŸºæœ¬åŸç†æ˜¯é€šè¿‡æ‹“æœ´æ’åºçš„æ–¹å¼, ä»å…¥åº¦ä¸º 0 çš„ SyncPoint æ‰§è¡Œå¹¶ä¸”éšç€æ‰§è¡Œçš„è¿‡ç¨‹ç§»é™¤å·²ç»æ‰§è¡Œå®Œæ¯•çš„ç‚¹ï¼Œé‡å¤æ­¤è¿‡ç¨‹ç›´åˆ°æ‰€æœ‰çš„ SyncPoint éƒ½è¢«æ‰§è¡Œå®Œæ¯•, å½“ä¸€ä¸ªç‚¹ä¸æ»¡è¶³æ‰§è¡Œæ¡ä»¶ï¼ˆå…¥åº¦ä¸º0ï¼‰çš„æ—¶å€™å°±é€šè¿‡ conditional variable å°†æ­¤çº¿ç¨‹ç½®ä¸º sleep çŠ¶æ€ã€‚</p>

<p>æ ¸å¿ƒå‡½æ•°ä¸º <code class="language-plaintext highlighter-rouge">LoadDependency</code> ä»¥åŠ <code class="language-plaintext highlighter-rouge">Process</code>, æˆ‘ä»¬ä¸Šé¢è¯´çš„æ‰€æœ‰ <code class="language-plaintext highlighter-rouge">TEST_SYNC_POINT_*</code> å®éƒ½æ˜¯æœ€ç»ˆå»è°ƒç”¨ <code class="language-plaintext highlighter-rouge">Process</code> å‡½æ•°ã€‚</p>

<h2 id="loaddependency">LoadDependency</h2>

<pre><code class="language-CPP">void SyncPoint::Data::LoadDependency(const std::vector&lt;SyncPointPair&gt;&amp; dependencies) {
  std::lock_guard&lt;std::mutex&gt; lock(mutex_);
  successors_.clear();
  predecessors_.clear();
  cleared_points_.clear();
  for (const auto&amp; dependency : dependencies) {
    successors_[dependency.predecessor].push_back(dependency.successor);
    predecessors_[dependency.successor].push_back(dependency.predecessor);
    point_filter_.Add(dependency.successor);
    point_filter_.Add(dependency.predecessor);
  }
  cv_.notify_all();
}
</code></pre>

<p><code class="language-plaintext highlighter-rouge">successor_</code> ä¸ <code class="language-plaintext highlighter-rouge">predecessor_</code> éƒ½æ˜¯ unordered_map, é€šè¿‡è¿™ä¸¤ä¸ª hash map å­˜å‚¨äº†ç‚¹ä¹‹é—´çš„å…³ç³», <code class="language-plaintext highlighter-rouge">successor_[x] = y</code> æ„å‘³ç€ <code class="language-plaintext highlighter-rouge">x -&gt; y</code> è¿™æ ·ä¸€æ¡è¾¹ï¼Œè€Œ <code class="language-plaintext highlighter-rouge">predecessor_[x] = y</code> æ„å‘³ç€ <code class="language-plaintext highlighter-rouge">y -&gt; x</code> è¿™æ ·ä¸€æ¡è¾¹. <code class="language-plaintext highlighter-rouge">point_filter</code> æˆ‘ä»¬æ”¾åˆ°åé¢æ¥è®².</p>

<h2 id="process">Process</h2>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ Process å‡½æ•°, å› ä¸ºå‡½æ•°è¾ƒé•¿ï¼Œå°±ä¸è´´è¿‡æ¥äº†, è¿™é‡Œæ”¾ä¸€ä¸ªæºç é“¾æ¥</p>

<p><a href="https://github.com/facebook/rocksdb/blob/678ba5e41cc7ae62a7d99a8307c2477f4de6d5d2/test_util/sync_point_impl.cc#L104">Source Code</a></p>

<p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ <code class="language-plaintext highlighter-rouge">point_filter_</code>, å®ƒæ˜¯ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">BloomFilter</code> ï¼Œç”¨æ¥è¿‡æ»¤æ‰ä¸€äº›å®Œå…¨ä¸å­˜åœ¨çš„ SyncPoint, æå‰ç»“æŸ <code class="language-plaintext highlighter-rouge">Process</code> æµç¨‹ä»¥å…ä¸å¿…è¦çš„ mutex lockã€‚
è·³è¿‡ Marker çš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">PredecessorsAllCleared</code> å‡½æ•°ï¼Œå®ƒä¼šå»æ£€æŸ¥æ˜¯å¦è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰å‰ç½®èŠ‚ç‚¹éƒ½å·²ç»æ‰§è¡Œå®Œæ¯•ï¼ˆæ‰§è¡Œå®Œæ¯•çš„èŠ‚ç‚¹ä¼šè¢«æ’å…¥åˆ° <code class="language-plaintext highlighter-rouge">cleared_points_</code> è¿™ä¸ªé›†åˆä¸­ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™è¯¥ SyncPoint çš„æ‰§è¡Œå°±ä¼šé˜»å¡åœ¨æ¡ä»¶å˜é‡ <code class="language-plaintext highlighter-rouge">cv</code> ä¸Š, å¦åˆ™å°±ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ã€‚
æ¥ä¸‹æ¥ä¼šæ ¹æ®æ³¨å†Œçš„ Callback å¯¹æ­¤ SyncPoint è°ƒç”¨ç›¸åº”çš„ Callbackã€‚ä¹Ÿå°±æ˜¯ä¸Šè¿°ä¾‹å­ 2 ä¸­è§£é‡Šçš„æµç¨‹ã€‚
æœ€åï¼Œå› ä¸ºè¿™ä¸ªç‚¹èƒ½å¤Ÿè¢«æ‰§è¡Œå·²ç»è¡¨æ˜å®ƒæ²¡æœ‰ä»»ä½•å‰ç½®èŠ‚ç‚¹æ²¡æœ‰è¢«æ‰§è¡Œï¼Œå®ƒè‡ªå·±ä¹Ÿå·²ç»æ‰§è¡Œå®Œæ¯•ï¼ŒæŠŠå®ƒè‡ªå·±åŠ å…¥åˆ° <code class="language-plaintext highlighter-rouge">cleared_points_</code> é‡Œï¼Œä»¥æ­¤ç®€åŒ–äº†æ‹“æ‰‘æ’åºä¸­éœ€è¦è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å…¥åº¦è¿™ä¸€è¿‡ç¨‹ï¼Œå¾ˆæ˜¯å·§å¦™</p>

<h2 id="misc">Misc</h2>

<p>å¦å¤–ï¼Œrocksdb ä»…ä¼šåœ¨ DEBUG æ¨¡å¼ä¸‹ç”Ÿæˆ SyncPoint ç›¸å…³çš„ä»£ç . ä¿è¯äº†ä»£ç åœ¨ Release æ¨¡å¼ä¸‹çš„æ€§èƒ½å®Œå…¨ä¸å—åˆ°å½±å“ã€‚</p>

<h1 id="final">Final</h1>

<p>æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•æ„é€ æ‰§è¡Œé¡ºåºç¡®å®šçš„å¹¶å‘æµ‹è¯•ç”¨ä¾‹ï¼Œä»‹ç»äº† rocksdb çš„ä¸€ç§ç¡®å®šæ€§è°ƒè¯•å·¥å…· SyncPoint ä»¥åŠå…¶ç”¨æ³•å’ŒåŸç†ã€‚åœ¨ Rocksdb å†…ï¼Œé™¤äº† SyncPoint è¿™ç§æµ‹è¯•å·¥å…·ï¼Œè¿˜æä¾›äº† FailPoint ä»¥åŠ KillPoint ç­‰ç”¨æ¥æ¨¡æ‹Ÿåœ¨ä»£ç æ‰§è¡Œåˆ°ç‰¹å®šæƒ…å†µä¸‹äº§ç”Ÿç‰¹å®šé”™è¯¯ï¼Œæ¥æ”¶åˆ°ç‰¹å®šä¿¡å·ç­‰æµ‹è¯•å·¥å…·ã€‚å¯¹äºå­˜å‚¨ç³»ç»Ÿçš„ä»£ç æ¥è¯´ï¼Œæ‹¥æœ‰è¶³é‡çš„å¯å›å½’çš„æµ‹è¯•ç”¨ä¾‹æ˜¯éå¸¸é‡è¦çš„ï¼ŒåŒæ—¶ä¸€ä¸ªå¤æ‚çš„å­˜å‚¨ç³»ç»Ÿæ¶‰åŠåˆ°äº‹åŠ¡ï¼Œå‰åå°çº¿ç¨‹äº¤äº’ç­‰å¤æ‚é€»è¾‘ï¼Œè€Œ RocksDB é€šè¿‡æä¾›ä¸Šè¿°å·¥å…·ä¸ºå¼€å‘è€…é™ä½äº†æµ‹è¯•ä»£ç çš„ç¼–å†™è´Ÿæ‹…ï¼Œä¹Ÿä¿è¯äº†ç³»ç»Ÿçš„å¯é æ€§ã€‚
åŒæ—¶æ„Ÿè°¢æˆ‘çš„åŒäº‹åœ¨å…¬å¸åˆ†äº«äº† SyncPoint è¿™æ ·çš„å·¥å…·ï¼Œå› ä¸ºæœ‰äº†åŒäº‹çš„ä»‹ç»æ‰ä¼šæœ‰æœ¬ç¯‡æ–‡ç« ï¼Œå¸Œæœ›è¿™ä¸ªç®€å•æ˜“ç”¨çš„å·¥å…·èƒ½å¤Ÿå¸®åŠ©æ›´å¤šå¼€å‘è€…å†™å‡ºæ›´åŠ å®Œå¤‡çš„æµ‹è¯•ã€‚</p>]]></content><author><name></name></author><summary type="html"><![CDATA[åœ¨æµ‹è¯•å¤šçº¿ç¨‹åº”ç”¨ç¨‹åºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæ„é€ ä¸€äº›å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ test case ç”¨æ¥æµ‹è¯•æ˜¯å¦æœ‰ race condition æˆ–è€… unexpected behavior å‡ºç°ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå¼€å‘è€…å¯èƒ½ä¼šå°†å¤šä¸ª function å¹¶å‘æ‰§è¡Œ N æ¬¡ï¼Œä»¥æ­¤æ¥åˆ¤æ–­æœ€ç»ˆç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸï¼Œè¿™å¯èƒ½å¯¹äºå¤§å¤šæ•°æƒ…å†µæ˜¯è¶³å¤Ÿçš„ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬å·²ç»é€šè¿‡æ’æŸ¥é—®é¢˜å‘ç°äº†ä¸€ä¸ªå› ä¸º race çš„åŸå› å¯¼è‡´çš„ Bug çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆéš¾é€šè¿‡ä¸Šè¿°é€šå¸¸çš„æ–¹æ³•å»é‡ç°å®ƒã€‚ä¸ºäº†èƒ½å¤Ÿæ„é€ å‡ºè¿è¡Œé¡ºåºå®Œå…¨å¯æ§çš„å¹¶å‘åœºæ™¯æµ‹è¯• caseï¼Œrocksdb å®ç°äº†ä¸€å¥—æµ‹è¯•å·¥å…· SyncPointï¼Œä»¥æ­¤æ¥è§£å†³ä¸Šé¢çš„è¿™ä¸ªé—®é¢˜ã€‚æœ¬æ–‡ä»‹ç» rocksdb SyncPoint çš„ä½¿ç”¨æ–¹æ³•ï¼Œä»¥åŠå…¶å®ç°åŸç†ã€‚]]></summary></entry><entry><title type="html">Recover My Blog</title><link href="https://void-shana.moe//posts/recover-my-blog" rel="alternate" type="text/html" title="Recover My Blog" /><published>2022-03-27T00:00:00+08:00</published><updated>2022-03-27T00:00:00+08:00</updated><id>https://void-shana.moe//posts/recover-my-blog</id><content type="html" xml:base="https://void-shana.moe//posts/recover-my-blog"><![CDATA[<h1 id="tldr">TL;DR</h1>

<p>æˆ‘çš„åšå®¢å› ä¸ºæ¬ è´¹ Gone äº†ï¼Œè°¢å¤©è°¢åœ°ï¼Œé€šè¿‡ Archive å’Œ Google Analytics æˆ‘æˆåŠŸæ¢å¤äº†ä¸»è¦çš„ Content å’Œ Comments</p>

<h1 id="todos">TODOs</h1>

<ul class="task-list">
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Recover my major content from archive</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Make Jekyll work again for my static blog</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" />Add comments plugin</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Add RSS feed</li>
  <li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" />Add tag and category support</li>
</ul>

<h1 id="background">Background</h1>

<p><img src="/assets/imgs/blog-is-gone.png" alt="pic" /></p>

<p>å‡ å¤©å‰ï¼Œæˆ‘å‘ç°æˆ‘çš„æœåŠ¡å™¨ RSS æ‹‰å–é•¿æœŸå¤±è´¥, å¿ƒæƒ³ï¼šè‚¯å®šæ˜¯æœåŠ¡å™¨æ¬ è´¹äº† ,äºæ˜¯å‡†å¤‡å»ç»­è´¹, ç»“æœæˆ‘ç™»é™†äº†æˆ‘æœåŠ¡å™¨çš„ Console é”™æ„•çš„å‘ç°ï¼Œæˆ‘çš„æœåŠ¡å™¨å·²ç»è¢« Terminated äº†ï¼Œæ„å‘³ç€æ•°æ®å…¨éƒ¨ Lost, æˆ‘æœåŠ¡å™¨ä¸Šè·‘çš„ TODOBot TTSBot ç­‰æ— æ³•æœåŠ¡äº†ä¸è¯´ï¼Œæ›´é‡è¦çš„æ˜¯æˆ‘çš„ Blog å’Œæˆ‘çš„ç½‘ç›˜çš„æ•°æ®éƒ½ä¸¢å¤±äº†ï¼Œè™½ç„¶æˆ‘çš„ Blog æœ‰å¤‡ä»½ï¼Œä½†æ˜¯å¤‡ä»½è®¾å¤‡ç›®å‰ä¸åœ¨èº«è¾¹ï¼ŒçŸ­æœŸå†…å› ä¸ºç–«æƒ…ä¹Ÿæ²¡æ³•æ‹¿åˆ°å¤‡ä»½ç›˜ã€‚é¡¿æ—¶æ„Ÿè§‰äº‹æƒ…ä¸å¦™ï¼Œå¥½åœ¨å°ä¼™ä¼´ä»¬å‘ç°ï¼Œå°½ç®¡æˆ‘çš„åšå®¢æœåŠ¡å™¨ Down äº†ï¼Œä½†æ˜¯æœ‰éƒ¨åˆ† Contentï¼ˆè®¿é—®æ¯”è¾ƒé¢‘ç¹çš„ï¼‰è¢« Archive å­˜ä¸‹æ¥äº†ï¼Œè¿™æ‰è®©æˆ‘ç¨ç¨æ¾ä¸€å£æ°”ã€‚å› ä¸ºçŸ­æœŸä¹‹å†…æ²¡æœ‰å†æ¬¡ç»­ä¸€ä¸ªæœåŠ¡å™¨çš„æ‰“ç®—ï¼Œè¿™æ¬¡å‡†å¤‡å°†åšå®¢å°±è¶è¿™ä¸ªæœºä¼šè¿ç§»åˆ°é™æ€ç«™ç‚¹ä¸Šã€‚</p>

<p>åŒæ—¶ï¼Œæˆ‘æƒ³èµ·æ¥ä¹‹å‰æˆ‘æœ‰ä¸€ä¸ª Github Page repo (ä¹Ÿå°±æ˜¯è¿™ä¸ª Page æ‰€åœ¨ Repo), æˆ‘å¯ä»¥å°†å®ƒé‡æ–°å¯ç”¨èµ·æ¥ï¼Œå¹¶ä¸”æŠŠçƒ­é—¨/é‡è¦æ–‡ç« åŠ å…¥åˆ°è¿™ä¸ª Repo ä¸­</p>

<p>äºæ˜¯å°±æœ‰äº†ä»Šå¤©çš„ <strong>ä» Archive &amp; Google Analytics æ¢å¤æˆ‘çš„åšå®¢</strong></p>

<h1 id="prepare">Prepare</h1>

<p><img src="/assets/imgs/ga-void-shana.jpg" alt="pic" />
<img src="/assets/imgs/archive-void-shana.png" alt="pic" /></p>

<p>é€šè¿‡ Archive å’Œ Google Analytics æˆ‘è·å¾—äº†åšå®¢çš„è®¿é—®ä¿¡æ¯å’Œå†å²æ•°æ®, åŒæ—¶ Google Analytics è™½ç„¶æ²¡æœ‰æä¾› API å¯ä»¥è·å–åˆ°è®¿é—®æœ€å¤šçš„ Pages, ä½†æ˜¯å¯å°†ç»Ÿè®¡æ•°æ®å¯¼å‡ºä¸º CSV, è¿™æ · æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®è¿™ä¸ªè¢«è®¿é—®çš„é¡µé¢åˆ—è¡¨ï¼Œæ¥ä» web archive ä¸Šå°½å¯èƒ½åœ°æ¢å¤ç›¸åº”çš„ Post äº†</p>

<p>æˆ‘å†™äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬ï¼Œè¯»å– CSV é‡Œçš„ URL å’Œ Impressions å€¼ï¼ŒæŒ‰ç…§ Impressions ç”±é«˜åˆ°ä½çš„é¡ºåºä¾æ¬¡å» Web Archive è·å–å†å²æ•°æ®: é€šè¿‡è®¿é—® <code class="language-plaintext highlighter-rouge">https://web.archive.org/{your_site_url_here}</code>, å³å¯è·å¾—è¿™ä¸ª URL å¯¹åº”çš„æœ€æ–°çš„ä¸€ä¸ª Archive å¿«ç…§ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰</p>

<h1 id="convert-to-markdown-with-frontmatters">Convert to Markdown with FrontMatters</h1>

<p>ç°åœ¨å¯ä»¥é€šè¿‡ Web Archive è·å–åˆ°ç½‘é¡µå¿«ç…§äº†ï¼Œå¯æ˜¯é™æ€ç«™ç‚¹ç”Ÿæˆå™¨å¦‚ GithubPages é»˜è®¤ä½¿ç”¨çš„ Jekyll, ç”¨çš„æ˜¯ Markdown è€Œä¸æ˜¯ Rich Text æˆ–è€… HTML, æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦ä¸€ä¸ªå·¥å…·å¯¹ Markdown è¿›è¡Œè½¬æ¢ï¼Œåœ¨ç½‘ä¸Šå¯ä»¥æ‰¾åˆ°å„ç§å®ç°çš„ HTML 2 Markdown converter, å› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„ Python ç¼–å†™è·å– Archive page è„šæœ¬ï¼Œè‡ªç„¶ä¹Ÿå°±é€‰ç”¨äº† Python çš„ä¸€ä¸ª Library: <a href="https://github.com/mixmark-io/turndown">turndown</a>. é€šè¿‡æ­¤æ’ä»¶å°†æ–‡ç«  HTML è½¬æˆ Markdownã€‚</p>

<p>ä½†æ˜¯ä»–è½¬æ¢å‡ºæ¥çš„æ–‡ç« å†…å®¹å¸¦æœ‰å¤§é‡æˆ‘ä¸éœ€è¦çš„ CSS å’Œ JS ç­‰æ–‡æœ¬ï¼ŒåŒæ—¶å› ä¸ºæˆ‘çš„ Wordpress Blog é¡µé¢ä¸Šæœ‰ç€å‹æƒ…é“¾æ¥ï¼Œåˆ†ç±»æ–‡æœ¬ï¼Œç­‰å¤šç§åŒºå—ï¼Œå¹¶ä¸é€‚åº” Markdown æ–‡æœ¬çš„å±•ç¤ºï¼Œéœ€è¦å»æ‰ä»–ä»¬ï¼Œåˆç®€å•çš„å†™äº†ä¸€ä¸ª purify_markdown çš„ function, ä»å·²æœ‰çš„ markdown å†…å®¹ä¸­æå–å‡º Post çš„æ—¶é—´ï¼Œæ ‡é¢˜ï¼Œå’Œæ­£æ–‡ï¼Œä»¥åŠè¯„è®º</p>

<p>å…¶ä¸­æ—¶é—´ï¼Œæ ‡é¢˜ç­‰ä¿¡æ¯æ˜¯ Jekyll è§£æ Post å¿…ä¸å¯å°‘çš„å†…å®¹ï¼Œè€Œæ­£æ–‡å’Œè¯„è®ºï¼Œæ˜¯æˆ‘æœ€å¸Œæœ›ç•™ä¸‹çš„ä¸¤éƒ¨åˆ†å†…å®¹. åœ¨è¿è¡Œè¿™ä¸ªè„šæœ¬çš„æ—¶å€™ï¼Œå¶ç„¶å‘ç° turndown å¯èƒ½æœ‰ä¸€äº› Bug: å¯¹äºä¸€éƒ¨åˆ† Comment å†…å®¹ï¼ŒConvert å‡ºæ¥çš„ Markdown å¯¹æ¯”åŸæ–‡ç¼ºå°‘äº†è‹¥å¹²è¡Œå†…å®¹</p>

<p>åŸæ–‡å†…å®¹:
<img src="/assets/imgs/recover-my-blog-bug0.jpg" alt="p" /></p>

<p>è½¬æ¢å:
<img src="/assets/imgs/recover-my-blog-bug1.jpg" alt="p" /></p>

<p>æœ€åï¼Œè¿™ä¸ªè„šæœ¬åœ¨æ¯ä¸ª Markdown çš„å¼€å¤´å¤„å¢åŠ  â€œFrontMatterâ€ ä¹Ÿå°±æ˜¯æ–‡ç« å…ƒæ•°æ®ï¼Œä½¿å¾—æ–‡ç« å¯ä»¥è¢« Jekyll Parse.</p>

<h1 id="compatibility-issues">Compatibility Issues</h1>

<p>é€šè¿‡ä¸Šä¸€ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†è¿™äº› Markdown æ–‡ä»¶ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯ç”Ÿæˆé™æ€ç«™ç‚¹ï¼Œåœ¨æœ¬åœ°æµ‹è¯• <code class="language-plaintext highlighter-rouge">jekyll serve</code> å‘ç°æŠ¥é”™</p>

<p><img src="/assets/imgs/recover-jekyll-exception.jpg" alt="p" /></p>

<p>è¿™ä¸ªé—®é¢˜çš„åŸå› æ˜¯å› ä¸ºæˆ‘çš„æ–‡æœ¬ä¸­æœ‰ä¸€äº›æ­£æ–‡å¸¦æœ‰ <code class="language-plaintext highlighter-rouge">{{  }}</code> (å¯¹ï¼Œæ¯”å¦‚æœ¬æ–‡ç°åœ¨ä¹Ÿå¸¦æœ‰äº† XD), é€šè¿‡æŸ¥é˜…èµ„æ–™å‘ç°å¯ä»¥é€šè¿‡æŒ‡å®šä¸€ä¸ª Flag(jekyll &gt; 4.0 æœ‰æ•ˆ) <code class="language-plaintext highlighter-rouge">render_with_liquid: false</code> æ¥å…³é—­æŸäº›æ–‡ç« å¯¹ Liquid çš„æ¸²æŸ“, ä½†æ˜¯ Github Page é»˜è®¤çš„ Jekyll ç‰ˆæœ¬è¿˜æ˜¯ &lt; 4.0 ä¸æ”¯æŒè¿™ä¸ª Flag çš„, äºæ˜¯æˆ‘åªå¥½æŠ›å¼ƒäº† Github åŸç”Ÿçš„ Github Page Generator, é‡‡ç”¨ Github Action è‡ªå®šä¹‰ç”Ÿæˆè§„åˆ™ï¼Œå¹¶ä¸”ä¸ºåç»­æ¢ç”¨å…¶ä»– Static Site Generator æä¾›æ¡ä»¶.</p>

<h1 id="miscs">Miscs</h1>

<p>ä½œä¸ºä¸€ä¸ªåšå®¢ï¼Œæˆ‘å¸Œæœ›ä»–æ˜¯èƒ½å¤Ÿè®©ä»–äººè¿›è¡Œ comment å¹¶ä¸”äº’åŠ¨çš„ï¼Œå› è€Œæˆ‘é€‰ç”¨äº† (giscus)[https://giscus.app/] ä½œä¸ºé™æ€ç«™ç‚¹åšå®¢çš„è¯„è®ºå·¥å…·, åŒæ—¶ä¿ç•™äº†å†å²è¯„è®ºåœ¨æ–‡ç« æ­£æ–‡ä¸­ã€‚</p>]]></content><author><name></name></author><summary type="html"><![CDATA[TL;DR]]></summary></entry><entry><title type="html">Customize Your Zsh Prompt</title><link href="https://void-shana.moe//posts/customize-your-zsh-prompt" rel="alternate" type="text/html" title="Customize Your Zsh Prompt" /><published>2019-06-02T00:00:00+08:00</published><updated>2019-06-02T00:00:00+08:00</updated><id>https://void-shana.moe//posts/customize-your-zsh-prompt</id><content type="html" xml:base="https://void-shana.moe//posts/customize-your-zsh-prompt"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="june-2-2019"><a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html" title="2:35 pm">June 2, 2019</a></h5>
<p><a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comments">4 comments</a></p>

<h2 id="screenshot">Screenshot</h2>

<p><img src="https://web.archive.org/web/20210514143128im_/https://img.vim-cn.com/e6/78d4e48a5339575a8227fa866adcb765b8b641.png" alt="This image has an empty alt attribute; its file name is 78d4e48a5339575a8227fa866adcb765b8b641.png" /></p>

<p>You may need â€œgood network conditionâ€ to preview this anime</p>

<p><img src="https://web.archive.org/web/20210514143128im_/https://img.vim-cn.com/e6/78d4e48a5339575a8227fa866adcb765b8b641.png" alt="" />Screenshot for my zsh prompt
Instructions
â€”â€”â€”â€”</p>

<p>I choose to use zsh <strong>promptinit</strong> system to write my own themes, which can be easily managed by zsh <code class="language-plaintext highlighter-rouge">prompt</code></p>

<h3 id="before-you-start">Before you start</h3>

<p>the <code class="language-plaintext highlighter-rouge">promptinit</code> uses autoload mechanism to load the theme file, so first we need to ensure the theme file <strong>locates inside fpath</strong>, if not, we should add the path containing your theme file into <code class="language-plaintext highlighter-rouge">fpath</code> array, just like the following (suggest my theme is in ~/.zsh/themes):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fpath=(~/.zsh/themes $fpath)
</code></pre></div></div>

<p><strong>Remember to put this line before any fpath &amp; autoload modification, e.g: if you are using grml-zsh-config, itâ€™s recommended to put this line into ~/.zsh.pre</strong></p>

<p>And then you should set the theme file name to <code class="language-plaintext highlighter-rouge">prompt_&lt;theme&gt;_setup</code>, this will be recognized by the zsh promptinit system. Then create a function named <code class="language-plaintext highlighter-rouge">prompt_&lt;theme&gt;_setup</code> inside your theme file. Your theme file now should have a basic skeleton like this (e.g: your theme name is moe).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prompt\_moe\_setup () {

}

prompt\_moe\_setup [[emailÂ protected]](/web/20210514143128/https://void-shana.moe/cdn-cgi/l/email-protection)
</code></pre></div></div>

<p>According to the <a href="#References">manpage</a> [1], You can declare the following functions for your prompt theme:</p>

<ul>
  <li>prompt_<theme>\_precmd: Add it into precmd hook(`add-zsh-hook precmd prompt_<theme>_precmd`) to enable theme precmd</theme></theme></li>
</ul>

<blockquote>
  <p>Quick reference to hook functions: zsh has some defined hook functions, such as <code class="language-plaintext highlighter-rouge">precmd</code>, <code class="language-plaintext highlighter-rouge">preexec</code>, etc, you can define an array with the string â€œ_functionsâ€ append, such as <code class="language-plaintext highlighter-rouge">precmd_functions</code>, You can try <code class="language-plaintext highlighter-rouge">echo $precmd_functions</code> to see whatâ€™s the content inside. And all the elements inside the array will be treated as functions, execute with the same context and argument as the basic function. If the function not found, just siliently ignore it, and continue to next one. for more information please refer to the <a href="#References-(1)">zsh doc functions section</a> [2]</p>

</blockquote>

<ul>
  <li>prompt_<theme>\_preview: Enable prompt preview via `prompt -p`</theme></li>
  <li>prompt_<theme>\_help: Enable help command via `prompt -h`</theme></li>
</ul>

<h3 id="customize-the-ps-rps">Customize the PS, RPS</h3>

<p>By convention, themes use for <code class="language-plaintext highlighter-rouge">PS1</code>, <code class="language-plaintext highlighter-rouge">PS2</code>, <code class="language-plaintext highlighter-rouge">RPS1</code>, etc. instead of <code class="language-plaintext highlighter-rouge">PROMPT</code>, <code class="language-plaintext highlighter-rouge">RPROMPT</code>. As the example above, inside <code class="language-plaintext highlighter-rouge">prompt_moe_setup</code> we can define <code class="language-plaintext highlighter-rouge">PS1</code>, <code class="language-plaintext highlighter-rouge">PS2</code>, etc. But what are <code class="language-plaintext highlighter-rouge">PS1</code>, <code class="language-plaintext highlighter-rouge">PS2</code>, <code class="language-plaintext highlighter-rouge">RPS1</code>?</p>

<ul>
  <li>PS1: The primary prompt string, displays just before the command input.</li>
  <li>PS2: When your command is not finished in one line, it will display in
the next following lines until your command is finsihed (e.g.: write a
multi-line while loop in zsh)</li>
  <li>RPS1: It will display at the right hand side when PS1 is displayed. (For
me, a right hand side RPS1 is useful to display error code information)</li>
</ul>

<p>There are also other prompt parameters(officially called parameters by zsh, but I think maybe variable is more intuitive) such as <code class="language-plaintext highlighter-rouge">PS3</code>,<code class="language-plaintext highlighter-rouge">PS4</code>, etc. but we donâ€™t really use it in common. For all the prompt variables, they all accept the same prompt escape sequence. The following are some commonly used escape sequence:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">%/</code> <code class="language-plaintext highlighter-rouge">%~</code>: Current working dir, Try them to see the difference.</li>
  <li><code class="language-plaintext highlighter-rouge">%m</code> <code class="language-plaintext highlighter-rouge">%M</code>: machine host name, either in short or full format.</li>
  <li><code class="language-plaintext highlighter-rouge">%B</code> <code class="language-plaintext highlighter-rouge">%b</code>: Begin / end <strong>bold</strong> text mode.</li>
  <li><code class="language-plaintext highlighter-rouge">%n</code>: $USERNAME variable</li>
</ul>

<p>For a full escape sequence reference please refer to the zsh-manual <a href="#References">Propmt Expansion</a> [3]. To debug your prompt string, you can simply use <code class="language-plaintext highlighter-rouge">print -rP &lt;STRING&gt;</code> to see the effect of your prompt, no need to reload zsh each time.</p>

<p>A trick of displaying error code information: I use <code class="language-plaintext highlighter-rouge">%(?..%F{red}\(?%f)</code> to display the error code in )RPS1, it will only show a red error code when the error code is not 0. The form <code class="language-plaintext highlighter-rouge">%(?.&lt;true-text&gt;.&lt;false-text&gt;)</code> is a conditional substring, means when the exit status of the last command is not 0, it will display the <code class="language-plaintext highlighter-rouge">&lt;false-text&gt;</code> else display <code class="language-plaintext highlighter-rouge">&lt;true-text&gt;</code>, we just leave the <code class="language-plaintext highlighter-rouge">&lt;true-text&gt;</code> blank so it wonâ€™t display anything when the command exit without any error.</p>

<h3 id="enable-version-control-info">Enable version control info</h3>

<p>It might be good to display the git info (or other vcs) along with your prompt. zsh has a powerful module vcs_info that can help you with this need.</p>

<p>For a quick start, you need to add the following lines into your theme file. (Still use the example above)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prompt\_opts=(subst percent)

function prompt\_moe\_precmd() {
    vcs\_info
}

</code></pre></div></div>

<p>Then append <code class="language-plaintext highlighter-rouge">\(vcs_info_msg_0_</code> into your prompt. Be careful that you should append the plain text <code class="language-plaintext highlighter-rouge">\)vcs_info_msg_0</code> instead of this variable, since the variable will be evaluated only when it is declared, while the plain mode is subjected to <a href="#References">Parameter Expansion</a> [3], that is, it will be evaluated each time the text displays. The following line is an example of adding vcs_info to your PS1:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS1="$PS1 \$vcs\_info\_msg\_0\_"

</code></pre></div></div>

<p>You might want also customize the <code class="language-plaintext highlighter-rouge">$vcs_info_msg_0_</code> prompt, such as changing the color, add / remove information displayed. You can achieve this with <code class="language-plaintext highlighter-rouge">zstyle</code>. Following are a list of common options:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">zstyle ':vcs_info:*' formats &lt;STRING&gt;</code>: Set the normal
vcs_info format string(when you are not in rebase, merge or other
actions it will display this one), you can get the current value by <code class="language-plaintext highlighter-rouge">zstyle | grep vcs_info -B1</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">zstyle ':vcs_info:*' actionformats &lt;STRING&gt;</code>: Set the vcs_info string when in rebase, merge or other actions.</li>
  <li><code class="language-plaintext highlighter-rouge">zstyle 'vcs_info:*' check-for-changes true/false</code>: Enable /
Disable checking for the uncommitted changes in current workdir, and if
there are uncommitted changes it will display either %u (for unstaged
changes) or %c (for staged changes). These to escape sequences can be
also configured by <code class="language-plaintext highlighter-rouge">zstyle</code></li>
  <li><code class="language-plaintext highlighter-rouge">zstyle ':vcs_info:*' unstagedstr &lt;STRING&gt;</code>: Set the string to display for %u</li>
</ul>

<p>Note that we use â€œ:vcs_info:*â€ above to match for all kinds of vcs systems as long as all repos to give them the settings. If you want to set different options for specified repos / vcs (e.g: Disable the check-for-changes for kernel repo since itâ€™s too big and cause delay), see the example below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zstyle ':vcs\_info:*:*:latest-linux-kernel' check-for-changes false

</code></pre></div></div>

<p>This will only disable check for unstaged change for repo with root directory named â€œlatest-linux-kernelâ€.</p>

<p>About a full reference about vcs_info usage and configuration, see <a href="#References">zsh documentation for vcs_info</a> [4]</p>

<h3 id="async-zsh-prompt">Async Zsh Prompt</h3>

<p>Although the vcs_info is useful, you may already found lags when turn on the the <code class="language-plaintext highlighter-rouge">check-for-changes</code> option, esp. in large repos. Itâ€™s annoying that the prompt doesnâ€™t display instantly after we press enter. One option is to disable the <code class="language-plaintext highlighter-rouge">check-for-changes</code> option for these huge repos, however itâ€™s just a workaround.</p>

<p>Fortunately, we have async zsh job support which can solve the problem. There are different kinds of async plugin we can use in zsh, for this blog we will use <a href="#References">zsh-async</a> [5].</p>

<p>zsh-async supports async jobs as well as callback handlers. Along with ZLE (<a href="#References">Zsh Line Editor</a> [6]) command <code class="language-plaintext highlighter-rouge">zle reset-prompt</code> we can achieve the async update of <code class="language-plaintext highlighter-rouge">PS1</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function prompt\_moe\_setup() {
    # Other codes ...    
    async\_start\_worker vcs\_updater\_worker
    async\_register\_callback vcs\_updater\_worker do\_update
}

function do\_update() {
    vcs\_info
    zle reset-prompt
}

function prompt\_moe\_precmd() {
    async\_job vcs\_updater\_worker
}


</code></pre></div></div>

<p>And then you have your async vcs_info now! But the code above is somehow glitchy, An optimized one can be found here: <a href="https://web.archive.org/web/20210514143128/https://gist.github.com/VOID001/588347b0ef4b3a14759579e8bf6acb23#file-prompt_moe_setup-L48">https://gist.github.com/VOID001/588347b0ef4b3a14759579e8bf6acb23#file-prompt_moe_setup-L48</a> (Still have some glitches but itâ€™s currently fine for me)</p>

<p>The code above does the following things:</p>

<ul>
  <li>In executing hook precmd, it starts an empty async task, which will return immediately.</li>
  <li>After the async job finished, it will execute the callback function: <code class="language-plaintext highlighter-rouge">do_update</code>.</li>
  <li>In <code class="language-plaintext highlighter-rouge">do_update</code>, we call vcs_info to update the
$vcs_info_msg_0_ (Note this will not block the prompt or any interaction
with current prompt). Then we use <code class="language-plaintext highlighter-rouge">zle reset-prompt</code> to reload current prompt.</li>
</ul>

<h2 id="ending">Ending</h2>

<p>Writing bash/zsh script is somehow painful for me so I previously stick to oh-my-zsh for a long time. However the zsh completion and git-prompt-info is so slow that always bother me. So I tried to switch to <code class="language-plaintext highlighter-rouge">grml-zsh-config</code> and define a custom prompt for me, what I found suprising is that writing (simple) zsh scripts are not as difficult as I think thanks to the well-documented zsh manpage and online manual. So I wrote this article as a â€œZsh Theme Creation Quick Start Guideâ€ for those who are dissatisfied with the oh-my-zsh themes and want to have a chance to create your own theme.</p>

<p>Thanks for <a href="https://web.archive.org/web/20210514143128/https://blog.lilydjwg.me/">@lilydjwg</a> for giving me lots of help when writing the theme. Thanks for @swordfeng for providing me with cute sample theme.</p>

<h2 id="references">References</h2>

<ul>
  <li><strong>(1)</strong> zshall(1) manual page: â€œPROMPT THEMESâ€</li>
  <li><strong>(2)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/Functions.html">http://zsh.sourceforge.net/Doc/Release/Functions.html</a></li>
  <li><strong>(3)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/Prompt-Expansion.html#Prompt-Expansion">http://zsh.sourceforge.net/Doc/Release/Prompt-Expansion.html#Prompt-Expansion</a></li>
  <li><strong>(4)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/User-Contributions.html#Version-Control-Information">http://zsh.sourceforge.net/Doc/Release/User-Contributions.html#Version-Control-Information</a></li>
  <li><strong>(5)</strong> <a href="https://web.archive.org/web/20210514143128/https://github.com/mafredri/zsh-async/">https://github.com/mafredri/zsh-async/</a></li>
  <li><strong>(6)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html#Zsh-Line-Editor">http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html#Zsh-Line-Editor</a></li>
</ul>

<hr />

<p><a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/category/linux/archlinux">archlinux</a>, <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/category/linux">Linux</a> <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/tag/linux">linux</a>, <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/tag/prompt">prompt</a>, <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/tag/zsh">zsh</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<ol>
  <li>
    <p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/d8fb8dde3de28b1d063f405a6007e1ac?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>naruto-ding</strong> says: 
<a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1049">January 13, 2020 at 2:00 am</a>
Hello,</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1052">January 14, 2020 at 3:44 pm</a>
 Hello naruto-ding,
 Glad you like it! But I am sorry to tell you that I donâ€™t have enough time to finish that series. That series of video is made when I was a senior student. The neu-os and the video tutorial is for teaching use of the â€œLinux Operating Systemâ€ course in my school. After I graduate I have many other things to work and study so I donâ€™t have the time to do that. I tried to ask the current maintainer of neu-os in my previous school to continue publishing some video tutorials but they are also very busy. Making one episode of the series tutorial will take me more than 12 hours â€“ 20 hours or even further, there are a lot of preparation needed such as the slides, the references, the sample code, etc.<br />
 However, in the future although I cannot update these OS tutorial videos, I will try to post some short videos (not in series) related to the operating system (such as ext4 file system, linux utility, command-line tools, etc). This kind of video will be less time consuming to made and to watch. Also I think it will provide some useful information for the audience.</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/d8fb8dde3de28b1d063f405a6007e1ac?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>naruto-ding</strong> says: 
<a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1050">January 13, 2020 at 2:10 am</a>
I realize the comments under each blog is quite slow. Hope to get the chance to consult with you for daily questions if it doesnâ€™t bother you too much. Maybe your email for further contact. (âœ¿â—¡â€¿â—¡)</p>

    <ol>
      <li>
        <p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1053">January 14, 2020 at 3:46 pm</a>
 Hello naruto-ding,<br />
 You can find my contact information here: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/void">https://void-shana.moe/void</a><br />
 Feel free to send me the email/in-site comments/questions about os via github issue <a href="https://web.archive.org/web/20210514143128/https://github.com/VOID001/neu-os">https://github.com/VOID001/neu-os</a>, I will be very happy to exchange thoughts with you.</p>
      </li>
      <li>
        <p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1053">January 14, 2020 at 3:46 pm</a>
 Hello naruto-ding,<br />
 You can find my contact information here: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/void">https://void-shana.moe/void</a><br />
 Feel free to send me the email/in-site comments/questions about os via github issue <a href="https://web.archive.org/web/20210514143128/https://github.com/VOID001/neu-os">https://github.com/VOID001/neu-os</a>, I will be very happy to exchange thoughts with you.</p>
      </li>
    </ol>
  </li>
</ol>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry><entry><title type="html">å°† vim ä½œä¸ºæ—¥å¸¸ç¬”è®°æœ¬ä½¿ç”¨</title><link href="https://void-shana.moe//posts/zh-taking-notes-with-vim" rel="alternate" type="text/html" title="å°† vim ä½œä¸ºæ—¥å¸¸ç¬”è®°æœ¬ä½¿ç”¨" /><published>2019-02-24T00:00:00+08:00</published><updated>2019-02-24T00:00:00+08:00</updated><id>https://void-shana.moe//posts/zh-taking-notes-with-vim</id><content type="html" xml:base="https://void-shana.moe//posts/zh-taking-notes-with-vim"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="february-24-2019"><a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html" title="4:27 pm">February 24, 2019</a></h5>
<p><a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comments">14 comments</a></p>

<p>æœ¬æ–‡é€šè¿‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ Vimwiki, perl graph-easy ä»¥åŠ git å°† vim é…ç½®ä¸ºæ—¥å¸¸çš„ç¬”è®°å·¥å…·ã€‚æ³¨: æœ¬æ–‡å†…å®¹åœ¨äºæä¾›ä¸€ç§ç¬”è®°è§£å†³æ–¹æ¡ˆï¼Œä¸åœ¨äºæ¯”è¾ƒå„ç§æ–¹æ³•çš„ä¼˜åŠ£ï¼Œå¦‚æœå¤§å®¶æœ‰å¿ƒä»ªçš„æ¨èæ–¹æ¡ˆï¼Œæ¬¢è¿æä¾›æ¢è®¨</p>

<h2 id="0x00-preface">0x00 Preface</h2>

<p>Note taking æ˜¯å¾ˆå¤šäººæ—¥å¸¸ä¼šè¿›è¡Œçš„æ´»åŠ¨ï¼Œå› è€Œä¸ºè‡ªå·±è¥é€ ä¸€ä¸ªè‰¯å¥½çš„ note taking ä½“éªŒååˆ†é‡è¦ã€‚è¯´é“ plain-text note æƒ³åˆ°çš„ç¬¬ä¸€ä¸ªå½“ç„¶æ˜¯ org-mode, å¯æ˜¯è™½ç„¶ org-mode æ˜¯ååˆ†å¥½çš„ç¬”è®°å·¥å…·ï¼Œä½†æˆ‘å¹¶ä¸æ˜¯å¾ˆæ„¿æ„ä¸ºäº† org-mode è€Œå»ä½¿ç”¨ emacs, åŒæ—¶ä½¿ç”¨ä¸¤ä¸ªç¼–è¾‘å™¨å¯¹å¤§è„‘åº”è¯¥æ˜¯ä¸€ä¸ªä¼¤å®³ï¼ˆå¤§é›¾ï¼Œæœ‰å…³ org-mode çš„ä½¿ç”¨ä»‹ç»å¯ä»¥çœ‹ <a href="https://web.archive.org/web/20210514125212/https://blog.poi.cat/post/write-a-programming-doc-with-org-mode">ç”¨ Org-mode å†™ç¼–ç¨‹æ–‡æ¡£</a> ï¼‰ã€‚å¦‚æœä½ ä¹Ÿåƒæˆ‘ä¸€æ ·æ˜¯ä¸€ä¸ª daily vim userï¼Œä¸€å®šä¼šå¸Œæœ›èƒ½ä½¿ç”¨ vim çš„æ–¹å¼æ¥åšç¬”è®°ã€‚ä½†æ˜¯å½“æˆ‘ä»¬æœç´¢ç›¸å…³ plugin çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥ä½¿ç”¨çš„ç¬”è®° plugin ååˆ†æœ‰é™ï¼Œä¸”æ²¡æœ‰è¾ƒå¥½çš„ä»‹ç»è¿™äº› plugin çš„æ–‡ç« ï¼Œå› è€Œå¯èƒ½è‡ªå·±å°è¯•è®¸ä¹…åæœ€ç»ˆæ”¾å¼ƒäº†ä½¿ç”¨ vim åšç¬”è®°ã€‚ï¼ˆ ä½œä¸ºæˆ‘ä¸ªäººè€Œè¨€ï¼Œæˆ‘æ›¾ç»æ”¾å¼ƒä½¿ç”¨ vim åšç¬”è®°çš„åŸå› å¦‚ä¸‹:</p>

<ul>
  <li>vim ç¬”è®°æ ¼å¼ä¸å¤Ÿç›´è§‚ï¼Œä¸èƒ½å¤Ÿè·å¾—å¾ˆå¥½çš„ preview æ•ˆæœ (å¦‚ç”¨ markdown æ ¼å¼åšç¬”è®°)</li>
  <li>vim ç¬”è®°ä¹‹é—´è·³è½¬ (navigation) å›°éš¾ï¼Œæ— æ³•çµæ´»çš„å¼•ç”¨å†…å®¹</li>
  <li>æ— æ³•åœ¨vim ç¬”è®°å†…ç”»å›¾</li>
  <li>vim ç¬”è®°ä¸èƒ½æ‰“ tagï¼Œä¹Ÿå°±ä¸å¯èƒ½æ”¯æŒä½¿ç”¨ tag æœç´¢ç›¸åº”ç¬”è®°</li>
  <li>ç¬”è®°éœ€è¦å­˜å‚¨åœ¨ä¸€ä¸ª directory é‡Œï¼Œæ²¡æœ‰ä¸€ä¸ªç›´è§‚çš„ç¬”è®° index ä¾›æˆ‘ä»¬ç®¡ç†ç¬”è®°ï¼ˆå¦‚ç»™æ ‡é¢˜æ·»åŠ æ³¨é‡Šï¼Œè‡ªç”±çš„æ·»åŠ åˆ é™¤ç¬”è®°ç­‰ï¼‰</li>
</ul>

<p>åç»­å— @tonyluj çš„æ¨èæˆ‘å°è¯•äº† <a href="https://web.archive.org/web/20210514125212/https://github.com/xolox/vim-notes">vim-notes</a>ã€‚è¯¥æ’ä»¶èƒ½å¤Ÿå¯¹ Markdown Notes è¿›è¡Œç®¡ç†ï¼ŒMarkdown ä½œä¸ºå¤§å®¶ç»å¸¸ä½¿ç”¨çš„æ ‡è®°è¯­è¨€ï¼Œå¾ˆç›´è§‚çš„è¢«æˆ‘é€‰åš plain text note çš„åŸºæœ¬ å¯æ˜¯åœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æˆ‘è§‰å¾—æœ‰ä¸€äº›ä¸æ˜“ç”¨çš„å› ç´ ï¼Œå¦‚ç¬”è®°æ–‡ä»¶åå¿…é¡»ä¸ºç¬”è®°ç¬¬ä¸€è¡Œå†…å®¹ï¼Œä½¿å¾—æˆ‘çš„ç¬”è®°æ–‡ä»¶å¤¹ä¸‹ç¬”è®°åç§°å‡ºç°ç©ºæ ¼ï¼Œå¼•å·ç­‰è½¬ä¹‰åçš„å­—ç¬¦ï¼Œé€ æˆè§‚æ„Ÿä¸Šçš„ä¸é€‚ï¼›å¦å¤– vim-notes çš„è·³è½¬åŠŸèƒ½ä¹Ÿä¸å¤Ÿå¼ºå¤§ï¼Œä¸æ”¯æŒåˆ›å»ºå¸¦æœ‰ description çš„ Linkï¼Œå› è€Œå½“ vim-notes é‡Œçš„ Link è¾ƒå¤šçš„æ—¶å€™ï¼Œç¬”è®°çš„å¯è¯»æ€§å°±é™ä½äº†ã€‚vim-notes æ”¯æŒæœç´¢åŠŸèƒ½ï¼Œå¯æ˜¯å¯¹æˆ‘è€Œè¨€ï¼Œå…¨æ–‡çš„æœç´¢åŠŸèƒ½ä¸å¦‚ä¸€ä¸ªæ–¹ä¾¿çš„ç´¢å¼•åŠŸèƒ½æ›´åŠ é€‚åˆï¼Œå› è€Œæˆ‘ä½¿ç”¨äº†ä¸€æ®µæ—¶é—´çš„ vim-notes åå°±æ”¾å¼ƒäº†</p>

<p>è€Œååœ¨ @lilydjwg ç™¾åˆä»™å­çš„æ¨èä¸‹ï¼Œæˆ‘å°è¯•äº† <a href="https://web.archive.org/web/20210514125212/https://github.com/vimwiki/vimwiki">vimwiki</a> ,è¿™ä¸ªæ’ä»¶çš„åå­—å¬èµ·æ¥ä¸åƒ note taking æ’ä»¶ (å¯¹æˆ‘æ¥è¯´æ˜¯è¿™æ ·çš„)ï¼Œè€Œä¸”åŒå…¶ä»– vim note taking plugin ä¸€æ ·ï¼Œä¹Ÿæ²¡æœ‰å¾ˆå¤šæ–‡ç« æ¥ä»‹ç» vimwiki çš„ä½¿ç”¨ä½“éªŒã€‚å› è€Œè¿™ä¹Ÿæ˜¯æœ¬ç¯‡æ–‡ç« çš„ç›®çš„ä¹‹ä¸€å•¦ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¤Ÿä¸ºå¤§å®¶ä»‹ç»ä¸€ç§èˆ’é€‚çš„ vim note taking ä½“éªŒ</p>

<h2 id="0x01-links">0x01 Links</h2>

<p>vimwiki ç¬¬ä¸€ä¸ªå¸å¼•æˆ‘ä¹Ÿæ˜¯ä»–çš„ä¸€ä¸ªä¸»è¦åŠŸèƒ½å°±æ˜¯ <strong>Link Navigation</strong>. Vimwiki åˆæ¬¡ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šå»ºç«‹ note(å®é™…ä¸Šæ˜¯ wiki, å› æœ¬æ–‡æè¿°åœºæ™¯ä¸º note taking ä¸‹é¢å…¨éƒ¨ä½¿ç”¨ note è€Œé wiki) directoryï¼Œ ç”¨äºä¿å­˜ä½ çš„æ‰€æœ‰ note ï¼ŒåŒå…¶ä»–æ’ä»¶ä¸åŒçš„æ˜¯ï¼Œä»–åœ¨åˆ›å»º note directory çš„åŒæ—¶ï¼Œè¿˜ä¼šåˆ›å»ºä¸€ä¸ªå«åš <strong>index note</strong> çš„æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯ä½ çš„ç¬”è®°çš„ç›®å½•å•¦ï¼ŒåŒæ—¶ï¼Œè¯¥æ–‡ä»¶å’Œä½ ç”¨ vimwiki åˆ›å»ºçš„å…¶ä»–ç¬”è®°æ–‡ä»¶æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œå¹¶ä¸”å¯ä»¥ä½¿ç”¨ Vim å†…å¿«æ·ç»„åˆ <Leader>ww æ‰“å¼€è¯¥æ–‡ä»¶ï¼ˆä¹Ÿå¯ä½¿ç”¨ `:VimwikiIndex`)ï¼Œ index note æ”¯æŒæ‰€æœ‰ vimwiki note syntax. è¿™æ˜¯æˆ‘çš„ note index çš„æˆªå›¾</Leader></p>

<p><img src="https://web.archive.org/web/20210514125212im_/https://void-shana.moe/wp-content/uploads/2019/02/shot-1024x616.png" alt="" />index page</p>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæ–‡æ¡£é‡Œæœ‰å¾ˆå¤š Link, è¿™äº› Link æœ‰çš„ Link åˆ°ä¸€ä¸ªç¬”è®°ï¼Œæœ‰çš„ Link åˆ°ä¸€ä¸ªå¤–éƒ¨ç½‘ç«™ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¯¹è¿™äº›ç¬”è®°è¿›è¡Œåˆ†ç±»ï¼ŒæŠŠä¸åŒçš„ç¬”è®°æ”¾åœ¨ä¸åŒçš„åˆ†ç±»ä¸‹ã€‚</p>

<blockquote>
  <p>link syntax</p>

  <table>
    <tbody>
      <tr>
        <td>[[link</td>
        <td>description]] å…¶ä¸­ description å¯ä»¥çœç•¥ï¼Œçœç•¥é»˜è®¤æ˜¾ç¤º link çš„å†…å®¹, æ·»åŠ  description ååˆ™åªæ˜¾ç¤º description. link å¯ä»¥ä¸º ç¬”è®°æ–‡ä»¶åï¼Œraw URLï¼Œfile URI (external files), anchor ååˆ†çµæ´»</td>
      </tr>
    </tbody>
  </table>
</blockquote>

<p>å¦‚ä¸Šæ–‡çš„ index page å…¶ä¸­çš„ Link çš„ raw format æ˜¯è¿™æ ·çš„: <code class="language-plaintext highlighter-rouge">[[lc-longest-palin-str|Longest Palindromic String]]</code>ï¼Œè·³è½¬åˆ°è¯¥ link çš„æ“ä½œä¹Ÿååˆ†ç®€å•ï¼Œ<strong>åªéœ€è¦åœ¨ Link ä¸Šç‚¹å‡»å›è½¦ï¼Œå°±ä¼šè·³è½¬åˆ°ç›¸åº”çš„å†…å®¹ï¼Œä½¿ç”¨ backspace å³å¯è¿”å›åˆ°ä¸Šä¸€å±‚</strong>ã€‚åˆ›å»º link çš„æ–¹å¼é™¤äº†æ‰‹åŠ¨è¾“å…¥ [[]] ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å°†å…‰æ ‡ç§»åŠ¨åˆ°ä¸€ä¸ªå•è¯ä¸Šç‚¹å‡»å›è½¦ï¼Œ vimwiki ä¼šè‡ªåŠ¨å°†å…¶è½¬æ¢ä¸ºä¸€ä¸ª linkï¼Œå¦‚æœè¯¥ link æŒ‡å‘çš„ note ä¸å­˜åœ¨ï¼Œè·³è½¬çš„æ—¶å€™ vimwiki ä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ note æ–‡ä»¶ä¾›ç¼–è¾‘ã€‚</p>

<p>Link å¯ä»¥ä¸ºå¤šç§æ ¼å¼ï¼Œå®ƒå¯ä»¥æ˜¯ä¸€ä¸ª URLï¼Œåœ¨ä½ ä½¿ç”¨ Enter è·³è½¬çš„æ—¶å€™å°†è¯¥ URL åœ¨ä½ çš„é»˜è®¤æµè§ˆå™¨æ‰“å¼€ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨æ–‡ä»¶ï¼Œæ¯”å¦‚ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼Œåœ¨è·³è½¬çš„æ—¶å€™ä¼šä½¿ç”¨åˆé€‚çš„è½¯ä»¶æ‰“å¼€è¯¥æ–‡ä»¶ (vimwiki ä½¿ç”¨ xdg-open) åŒæ—¶ Link æ”¯æŒ subdirectory, å¦‚ä¸Šé¢ index page é‡Œçš„<code class="language-plaintext highlighter-rouge">[ ] [[os/linux-kernel-rcu-000|Read Copy Update Mechanism]]</code> çš„ç¬”è®°æ–‡ä»¶é“¾æ¥åˆ° $NOTE_DIR/os/linux-kernel-rcu-000.mw è¿™ä¸ª noteã€‚Link ä¹Ÿæ”¯æŒ anchor ,å¯ä»¥åœ¨åŒä¸€ä¸ªç¬”è®°é‡Œè·³è½¬åˆ°ç›¸åº”çš„ anchor ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¯¥æ‰‹æ®µåœ¨ note å®ç°å¦‚ footnote ç­‰å®ç”¨åŠŸèƒ½ã€‚</p>

<h2 id="0x01-tags">0x01 Tags</h2>

<p>vimwiki çš„å¦ä¸€ä¸ªååˆ†å®ç”¨çš„åŠŸèƒ½æ˜¯ note tagging</p>

<blockquote>
  <p>tag syntax</p>

  <p>:tag1:tag2:~:tagn: æˆ–è€… :tag1: :tag2: ~ :tagn: æ”¯æŒæ¾æ•£æˆ–ç´§å¯†ä¸¤ç§æ ¼å¼</p>
</blockquote>

<p>æˆ‘ä»¬åœ¨å†™åšå®¢å’Œä½¿ç”¨ç°ä»£ç¬”è®°è½¯ä»¶çš„æ—¶å€™ï¼Œå¾€å¾€éƒ½å¸Œæœ›èƒ½å¤Ÿçµæ´»çš„ç»™ç¬”è®°æ‰“ tagï¼Œå› ä¸ºç¬”è®°æ˜¯é›¶æ•£çš„æƒ³æ³•çš„é›†åˆï¼Œä¸€ç¯‡ç¬”è®°å†…å®¹å¯èƒ½äº¤å‰å±äºå¤šä¸ª category ï¼Œé€šè¿‡ tagging æˆ‘ä»¬å¯ä»¥å°†ç¬”è®°åˆ†ç±»ç®¡ç†èµ·æ¥ ã€‚è€Œ vimwiki å¯¹ tagging çš„æ”¯æŒä¹Ÿæ˜¯ååˆ†å¥½çš„ï¼Œå®ƒä¸ä»…ä»…æ”¯æŒç»™æ–‡ç« æ‰“ tag ï¼Œè¿˜æ”¯æŒç»™æ–‡ç« çš„æ¯ä¸€ä¸ªæ ‡é¢˜æ‰“ tag ï¼Œå¹¶ä¸”æä¾›äº†ååˆ†æ–¹ä¾¿çš„ tag indexing and searching åŠŸèƒ½ï¼Œæˆ‘ä»¬ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸‹</p>

<p>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">:VimwikiGenerateTags</code> å¯ä»¥å¯¹ç°æœ‰çš„å…¨éƒ¨ tag ç”Ÿæˆ index ç¤ºä¾‹æ•ˆæœå¦‚ä¸‹</p>

<p><img src="https://web.archive.org/web/20210514125212im_/https://void-shana.moe/wp-content/uploads/2019/02/image-843x1024.png" alt="" />ä½¿ç”¨ Generate Tag ç”Ÿæˆçš„ Tag Index
ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">:VimwikiSearchTags</code> å¯ä»¥æœç´¢å«æœ‰æŸä¸ª tag çš„ noteï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">:VimwikiSearch</code>æœç´¢ note çš„å…¨æ–‡</p>

<h2 id="0x02-tables-and-graph">0x02 Tables and Graph</h2>

<p>vimwiki æ”¯æŒ markdown styled table syntax å¹¶å®ç°äº†è‡ªåŠ¨å¯¹é½ï¼ŒTab åˆ‡æ¢ cell ç­‰åŠŸèƒ½ï¼Œåœ¨ vimwiki é‡Œåˆ›å»ºè¡¨æ ¼çš„æ—¶å€™ï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">:VimwikiTable &lt;row&gt; &lt;col&gt;</code>åˆ›å»ºä¸€ä¸ªç©ºç™½çš„è¡¨æ ¼ï¼Œç„¶åè¿›å…¥ã€€insert mode, ç¼–è¾‘å•ä¸ª cell çš„å†…å®¹åç‚¹å‡» Tab ï¼Œè¡¨æ ¼ä¼šè‡ªåŠ¨å¯¹é½ï¼Œå¦‚æœç¼–è¾‘çš„ cell ä¸ºè¡¨æ ¼ä¸­æœ€åä¸€ä¸ª cell ï¼Œç‚¹å‡» Tabã€€åä¼šåˆ›å»ºæ–°ä¸€è¡Œä¾›ç»§ç»­ç¼–è¾‘ã€‚æ•ˆæœå¦‚ä¸‹ (å¦‚æœçœ‹ä¸åˆ°ä¸‹é¢çš„è§†é¢‘è¯´æ˜<em>ç½‘ç»œ</em>ä¸å¥½ï¼ˆx</p>

<p>åšç¬”è®°çš„æ—¶å€™æˆ‘ä»¬è¿˜éœ€è¦ç»˜åˆ¶ä¸€äº› digram å¦‚ UML å›¾ï¼Œæµç¨‹å›¾ï¼Œå…³ç³»å›¾ç­‰ã€‚vimwiki å¹¶æ²¡æœ‰æ”¯æŒè¿™æ ·çš„åŠŸèƒ½ï¼Œå› è€Œæˆ‘ä½¿ç”¨ <a href="https://web.archive.org/web/20210514125212/https://aur.archlinux.org/packages/perl-graph-easy/">graph-easy(AUR)</a> å®ç°äº†è¯¥åŠŸèƒ½ï¼Œgraph-easy æ”¯æŒç›´æ¥å°† <a href="https://web.archive.org/web/20210514125212/https://www.wikiwand.com/en/DOT_(graph_description_language)">DOT Language</a> è½¬æ¢ä¸º ascii digramï¼Œæˆ‘ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„ vim plugin å°†å…¶é›†æˆåˆ°äº† vim å†…ï¼Œæ•ˆæœå¦‚ä¸‹:</p>

<p>è¯¥æ’ä»¶å¯ä»¥é€šè¿‡ Vim çš„ Plugin Manager è¿›è¡Œå®‰è£… æ’ä»¶åœ°å€: <a href="https://web.archive.org/web/20210514125212/https://github.com/VOID001/graph-easy-vim">https://github.com/VOID001/graph-easy-vim</a></p>

<h2 id="0x03-generate-html">0x03 Generate HTML</h2>

<p>vimwiki å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†å†…å®¹å¯¼å‡ºä¸º HTML ï¼Œå‘½ä»¤ä¸º <code class="language-plaintext highlighter-rouge">:Vimwiki2HTML :VimwikiAll2HTML</code> <code class="language-plaintext highlighter-rouge">:Vimwiki2HTMLBrowse</code>ï¼Œåˆ†åˆ«ä¸ºç”Ÿæˆå•é¡µ HTML, å°† note directory ä¸‹å…¨éƒ¨æ–‡ä»¶ç”Ÿæˆ HTML ï¼Œç”Ÿæˆå•é¡µ HTML å¹¶æ‰“å¼€æµè§ˆå™¨æµè§ˆã€‚vimwiki ä¼šå°† HTML ç”Ÿæˆåœ¨ $NOTEDIR_html æ–‡ä»¶å¤¹ä¸‹ã€‚æ”¯æŒè‡ªå®šä¹‰ css file ç”Ÿæˆè‡ªå®šä¹‰æ ·å¼çš„ç¬”è®°ï¼Œé»˜è®¤çš„ HTML é£æ ¼æ˜¯è¿™æ ·çš„</p>

<p><img src="https://web.archive.org/web/20210514125212im_/https://void-shana.moe/wp-content/uploads/2019/02/image-1-1024x665.png" alt="" />:Vimwiki2HTML ç”Ÿæˆçš„ index page é»˜è®¤æ ·å¼
0x04 Configuration
â€”â€”â€”â€”â€”â€”</p>

<p>ä»¥ä¸Šå°±æ˜¯å¯¹ vimwiki ä¸»è¦åŠŸèƒ½çš„ä¸€ä¸ªç®€å•ä»‹ç»äº†ï¼Œæœ¬äººåˆšåˆšå¼€å§‹ä½¿ç”¨ï¼Œè¯¸å¦‚ Diary Calendar ä¹‹ç±»çš„åŠŸèƒ½è¿˜æ²¡æœ‰å¼€å§‹ä½¿ç”¨ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªåŠŸèƒ½å¯¹æˆ‘çš„ç”¨å¤„è¾ƒå°ï¼Œå› è€Œä¸å¯¹è¿™äº›åŠŸèƒ½è¿›è¡Œä»‹ç»ï¼Œä¸‹é¢ä»‹ç»ä¸‹ä½¿ç”¨ vimwiki çš„åŸºæœ¬ configuration</p>

<p>é»˜è®¤ vimwiki ä¼šå°† note directory åœ¨ ~/vimwiki ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é…ç½®æ¥æ›´æ”¹å®ƒ</p>

<blockquote>
  <p>g:vimwiki_list option</p>

  <p>vimwiki æ”¯æŒå¤šä¸ª note , æ¯ä¸€ä¸ª note çš„é…ç½®é¡¹æ˜¯ä¸€ä¸ª Objectï¼Œ å¤šä¸ª Object æ„æˆè¯¥ g:vimwiki_list option çš„ value.</p>

</blockquote>

<p>æˆ‘çš„é…ç½®å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>let g:vimwiki\_list = [{
            \ 'path': '~/Documents/Notes/', 'index': 'index', 'ext': '.mw',
            \ 'auto\_tags': 1,
            \ 'nested\_syntaxes': {'py': 'python', 'cpp': 'cpp', 'c':'c'}
            \ }]
nmap &lt;Leader&gt;tt &lt;Plug&gt;VimwikiToggleListItem

</code></pre></div></div>

<p>æœ‰å…³è¯¦ç»†çš„é…ç½®ï¼Œå‚è€ƒ :help vimwiki çš„ vimwiki-local-options sectionï¼Œè¿™é‡Œåªä»‹ç»å°‘é‡çš„åŸºæœ¬è®¾ç½®å‚æ•°</p>

<ul>
  <li>path: è¯¥ note çš„ directory</li>
  <li>ext: è¯†åˆ«ä¸º note çš„æ–‡ä»¶åç¼€ï¼Œä¸ºäº†å…¼å®¹ git gogs ç­‰çš„ syntax highlighting ä½¿ç”¨äº† mediawiki çš„åç¼€ (*.mw *.mediawiki)</li>
  <li>auto_tags: æ˜¯å¦è‡ªåŠ¨ç”Ÿæˆ tagï¼Œè®¾ç½®ä¸ºï¼‘è¡¨ç¤ºè‡ªåŠ¨ç”Ÿæˆï¼Œå³ note ä¸­å¦‚æœæœ‰ tag å°±ä¼šåŠ å…¥åˆ° vimwiki çš„ tag file ä¸­</li>
  <li>nested_syntaxes: è®¾ç½®æ”¯æŒçš„é«˜äº®ä»£ç å—ç±»å‹ï¼Œæ˜¯ key-value pairs</li>
</ul>

<h2 id="0x05-syntax">0x05 Syntax</h2>

<p>å¦‚æœä½ çœ‹åˆ°äº†è¿™é‡Œï¼Œè¯´æ˜ä½ æœ‰å¯èƒ½ä¼šå°è¯•ä¸‹ vimwiki å› è€Œæˆ‘ä»¬åœ¨è¿™é‡Œä»‹ç»ä¸‹å…¶åŸºæœ¬è¯­æ³•ã€‚</p>

<p>vimwiki æ”¯æŒå¤šç§è¯­æ³•ï¼ŒåŒ…æ‹¬è‡ªå·±çš„è¯­æ³• vimwiki, å¹¶ä¸”å¯¹ markdown å’Œ mediawiki æä¾›äº†æ”¯æŒ ï¼Œæˆ‘ä¸ªäººæ¨èä½¿ç”¨ vimwiki è¯­æ³•ï¼Œè¯¥è¯­æ³•å’Œ vimwiki çš„å„ç§åŠŸèƒ½å…¼å®¹æœ€å¥½ï¼Œå¹¶ä¸”åªæœ‰è¯¥æ ¼å¼æ”¯æŒ <code class="language-plaintext highlighter-rouge">:Vimwiki2HTML</code></p>

<p>ä»¥ä¸‹æ˜¯åŸºæœ¬æ–‡å­—æ•ˆæœè¯­æ³•:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  *bold text*
  \_italic text\_
  ~~strikeout text~~
  `code (no syntax) text`
  super^script^
  sub,,script,,
</code></pre></div></div>

<p>æ ‡é¢˜è¯­æ³•ä¸º <code class="language-plaintext highlighter-rouge">= TITLE =</code> ï¼Œè¯¥æ ‡é¢˜ä¸ºä¸€çº§æ ‡é¢˜ï¼ŒäºŒçº§æ ‡é¢˜åˆ™å˜ä¸ºä¸¤ä¸ª â€œ=â€: <code class="language-plaintext highlighter-rouge">The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog) SUB TITLE The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog)</code> ä»¥æ­¤ç±»æ¨</p>

<p>åˆ—è¡¨è¯­æ³•åŸºæœ¬åŒ Markdown ä¸€è‡´ æ³¨æ„éœ€è¦åœ¨æ¯ä¸€ä¸ª Item å’Œ Mark ä¹‹é—´æ·»åŠ  Space</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* This is a list item
*This is NOT a list item
1. order list item 1
2. ...

...  æ”¯æŒå¤šç§ mark è¿™é‡Œä¸å…¨éƒ¨åˆ—å‡º
</code></pre></div></div>

<p>pre-formatted text ä¸€èˆ¬ç”¨ä½œåœ¨ç¬”è®°å†…æ’å…¥ä»£ç ï¼Œä¿ç•™å…¶åŸæœ¬çš„æ ¼å¼ï¼Œå¹¶ä¸”ä½¿ç”¨ç›¸åº”è¯­æ³•çš„é«˜äº®ï¼Œä»–çš„è¯­æ³•å¦‚ä¸‹:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{{{lang
    // Code goes here
}}}
</code></pre></div></div>

<p>ä¸Šé¢ç”Ÿæˆ ascii graph çš„æ—¶å€™å¤§å®¶å·²ç»è§è¿‡è¿™ä¸ªè¯­æ³•äº†ï¼Œä¸ºäº†ä¿ç•™ ascii graph åŸæœ¬çš„ format ï¼Œæˆ‘å°†å…¶ä½œä¸ºä¸€ä¸ª pre-formatted code block å¤„ç†ã€‚</p>

<p>å…³äºå…¶ä»–æ²¡æœ‰æåˆ°çš„ syntax ï¼Œå¯ä»¥å‚è€ƒ <code class="language-plaintext highlighter-rouge">:help vimwiki</code> çš„ vimwiki-syntax section</p>

<h2 id="0x06-ending">0x06 Ending</h2>

<p>ä½¿ç”¨ vimwiki ä½¿æˆ‘è·å¾—äº†å¦‚ä½¿ç”¨ Modern Note Taking App ä¸€æ ·çš„ä½“éªŒï¼Œå¹¶ä¸”ä¿ç•™äº†æˆ‘çš„ vim ä½¿ç”¨ä¹ æƒ¯ï¼Œå› ä¸º vim çš„çµæ´»æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æå‡ note taking ä½¿ç”¨ä½“éªŒå®ç°è¯¸å¦‚ Cloud Sync, fuzzy tag finder ä¹‹ç±»çš„åŠŸèƒ½ï¼Œä¸çŸ¥é“å¤§å®¶åœ¨çœ‹å®Œæœ¬æ–‡åä¼šä¸ä¼šå»å°è¯•ä¸‹ vimwiki å‘¢ï¼Œå¸Œæœ›èƒ½å¤Ÿå¬åˆ°å¤§å®¶çš„ä½¿ç”¨å¿ƒå¾—ï¼ŒåŒæ—¶æ¬¢è¿å¤§å®¶åœ¨è¯„è®ºåŒºä»‹ç»è‡ªå·±æ˜¯å¦‚ä½•è®°å½•ç¬”è®°çš„ ğŸ™‚</p>

<hr />

<p><a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/category/linux">Linux</a>, <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/category/linux/vim">vim</a> <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/tag/archlinux">archlinux</a>, <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/tag/linux">linux</a>, <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/tag/vim">vim</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<ol>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/b7fd1168153a5d7fdd0f395a02a2a11d?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514125212/http://silverrainz.me/">SilverRainZ</a></strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-530">February 24, 2019 at 11:36 pm</a>
/me åœ¨ä½¿ç”¨ä¸€ä¸ªè¿˜æœªå­˜åœ¨çš„è‡ªå»ºç¬”è®°ç³»ç»Ÿï¼Œæ¯æ¬¡æƒ³å†™ç‚¹ä¸œè¥¿éƒ½å› ä¸ºã€Œæ— æ³•è§£å†³ä¾èµ–ã€è€Œå¤±è´¥ã€‚</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-532">February 24, 2019 at 11:39 pm</a>
 å¯ä»¥æ¥è¯•è¯•çœ‹ vimwiki å“¦ï¼Œä¹Ÿè®¸çœŸçš„èƒ½æˆä¸º LA æ—¥å¸¸ä½¿ç”¨çš„ç¬”è®°å·¥å…· XD</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/89874964e3e524c2cbc10e0087061f77?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514125212/https://junyixu.github.io/">Junix</a></strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-536">February 26, 2019 at 6:20 pm</a>
æ‰‹æœºä¸Šæƒ³æŸ¥çœ‹å¯ä»¥ç”¨ä»€ä¹ˆæ–¹æ³•å‘¢</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-540">February 27, 2019 at 8:42 pm</a>
 å¯ä»¥ç”¨ä¸€ä¸ª github å®¢æˆ·ç«¯ï¼Œåœ¨ vim è®¾ç½®æˆæ¯æ¬¡ä¿å­˜çš„æ—¶å€™ push åˆ° github ä¸Šï¼Œç„¶åä½¿ç”¨ Android Github Client (e.g: Fasthub) æ¥æŸ¥çœ‹</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-541">February 28, 2019 at 3:32 pm</a>
çªæ˜¯è§‰å¾—æˆ‘è‡ªå·±çš„ç¬”è®°æœ¬å·¥å…·æœ€å¥½ä¸è¦æ˜¯é‚£ç§ web editorï¼Œæ‰€ä»¥æ²¡é€‰æ‹©é‚£äº›æ–¹æ¡ˆ</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-545">March 5, 2019 at 10:10 pm</a>
æ ¹æ®ç™¾åˆçš„æŒ‡å¯¼ï¼Œçªç»™ vimwiki è®°äº‹æœ¬æ·»åŠ äº†è‡ªåŠ¨åŒæ­¥(ä¼ª)åŠŸèƒ½<br />
ç„¶åæŠŠé‡Œé¢çš„è·¯å¾„éƒ½æ›¿æ¢æˆä½ è‡ªå·±çš„è·¯å¾„å°±å¥½å•¦</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/89874964e3e524c2cbc10e0087061f77?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514125212/https://junyixu.github.io/">Junix</a></strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-778">August 5, 2019 at 5:43 pm</a>
 å› ä¸ºæ‡’å¾—å†å­¦ä¸€ç§è¯­æ³•ï¼Œå°±ç›´æ¥ç”¨markdown äº†ï¼Œå› ä¸ºé¢„è§ˆç›´æ¥ç”¨ vim çš„ markdown é¢„è§ˆæ’ä»¶ï¼Œmd è½¬æ¢æˆ html å¯ä»¥ç”¨ pandoc.</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/74242ff548975ef430c690678bd49615?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514125212/https://blog.naibabiji.com/">å¥¶çˆ¸ç¬”è®°</a></strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-582">April 29, 2019 at 12:53 am</a>
ä½ è¿™æ–‡ç« å¥½é•¿ï¼Œå¼•èµ·æˆ‘Braveæç¤ºæ— å“åº”å¥½å‡ æ¬¡ã€‚æˆ‘åªåœ¨vpsä¸Šç”¨è¿‡vimï¼Œéƒ½ä¸çŸ¥é“ä½ è¯´çš„æ˜¯ä¸æ˜¯å’Œæˆ‘è¯´çš„ä¸€æ ·ä¸œè¥¿ã€‚</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-583">April 29, 2019 at 8:56 am</a>
 Chrome &amp; Firefox çœ‹éƒ½æ²¡æœ‰é—®é¢˜</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/d219af79b45e5891507fda4c4c2139a0?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514125212/https://repostone.home.blog/">repostone</a></strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-594">May 8, 2019 at 4:48 pm</a>
çœ‹åšä¸»ä»€ä¹ˆæ—¶å€™å›æ¥ã€‚</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-595">May 8, 2019 at 5:03 pm</a>
 ä¸€ç›´åœ¨å“¦ï¼Œåªä¸è¿‡æœ€è¿‘æ²¡æœ‰ä»€ä¹ˆæœ‰è¶£çš„ä¸œè¥¿æ¥å†™ -A-</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/d3f616233073c2bf156aa1da5c7ec117?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>chenbxxx</strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-843">August 23, 2019 at 5:14 pm</a>
æœ‰æ²¡æœ‰Vimå¤„ç†ä¸­è‹±æ–‡åˆ‡æ¢çš„è·¯å­ -_&lt;</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/8824e74d66ee336c6352fcfe2d2dd380?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>muou333000</strong> says: 
<a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-1122">May 8, 2020 at 3:18 pm</a>
ä½ å¥½ï¼Œé—®ä¸‹ï¼šèƒ½æŠŠorgé‡Œé¢çš„æ–‡ä»¶è½¬åˆ°vimwikié‡Œé¢æ¥ä¹ˆï¼Ÿ</p>

    <ol>
      <li>
        <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-1217">June 21, 2020 at 3:57 pm</a>
 ä½ å¥½ï¼Œ æˆ‘æ²¡æœ‰å°è¯•è¿‡ï¼Œ ä¸è¿‡æˆ‘è®¤ä¸º org-mode è¡¨è¾¾çš„ä¿¡æ¯æ˜¯ vimwiki çš„è¶…é›†ï¼Œ convert åˆ° vimwiki ä¼šä¸¢å¤±ä¸€å®šçš„è¯­ä¹‰ï¼Œä¸è¿‡ convert åº”æ˜¯å¯è¡Œçš„</p>
      </li>
      <li>
        <p><img src="https://web.archive.org/web/20210514125212im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514125212/https://void-shana.moe/linux/zh-taking-notes-with-vim.html#comment-1217">June 21, 2020 at 3:57 pm</a>
 ä½ å¥½ï¼Œ æˆ‘æ²¡æœ‰å°è¯•è¿‡ï¼Œ ä¸è¿‡æˆ‘è®¤ä¸º org-mode è¡¨è¾¾çš„ä¿¡æ¯æ˜¯ vimwiki çš„è¶…é›†ï¼Œ convert åˆ° vimwiki ä¼šä¸¢å¤±ä¸€å®šçš„è¯­ä¹‰ï¼Œä¸è¿‡ convert åº”æ˜¯å¯è¡Œçš„</p>
      </li>
    </ol>
  </li>
</ol>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry><entry><title type="html">Running Arch Linux with customized kernel in QEMU</title><link href="https://void-shana.moe//posts/running-arch-linux-with-customized-kernel-in-qemu" rel="alternate" type="text/html" title="Running Arch Linux with customized kernel in QEMU" /><published>2019-01-31T00:00:00+08:00</published><updated>2019-01-31T00:00:00+08:00</updated><id>https://void-shana.moe//posts/running-arch-linux-with-customized-kernel-in-qemu</id><content type="html" xml:base="https://void-shana.moe//posts/running-arch-linux-with-customized-kernel-in-qemu"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="january-31-2019"><a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/linux/running-arch-linux-with-customized-kernel-in-qemu.html" title="7:16 pm">January 31, 2019</a></h5>
<p><a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/linux/running-arch-linux-with-customized-kernel-in-qemu.html#comments">3 comments</a></p>

<p>æœ¬æ–‡ä¸ºå†…æ ¸çˆ±å¥½è€…ä»¬ä»‹ç»ä¸€ä¸ªä¾¿åˆ©çš„è¿è¡Œå†…æ ¸çš„æ–¹å¼ï¼Œä½¿ç”¨ QEMU + virtio å¯åŠ¨ä¸€ä¸ªè£…è½½ç€è‡ªå®šä¹‰å†…æ ¸çš„ Arch Linuxã€‚</p>

<h3 id="0x00-æ„å»ºå†…æ ¸">0x00 æ„å»ºå†…æ ¸</h3>

<p>æˆ‘ä»¬ä½¿ç”¨ Arch Linux å‘è¡Œç‰ˆä½¿ç”¨çš„ .config ä½œä¸ºé…ç½®æ–‡ä»¶, å¯ä»¥çœå´å¾ˆå¤šè‡ªå·±é…ç½® Kernel Options çš„ç¹çå·¥ä½œã€‚å°†é…ç½®æ–‡ä»¶æ”¾å…¥ kernel source tree åï¼Œä½¿ç”¨ <code class="language-plaintext highlighter-rouge">make oldconfig</code> å°±å¯ä»¥é€šè¿‡ä¸€ä¸ªäº¤äº’çš„å‘½ä»¤è¡Œå°†æœ€æ–°çš„å†…æ ¸é‡Œçš„å¯é…ç½®å‚æ•°è¡¥å…¨åˆ°æˆ‘ä»¬ä½¿ç”¨çš„ Arch Linux çš„ .config æ–‡ä»¶ä¸­ã€‚</p>

<p>æˆ‘ä»¬æœ‰ä¸¤ç§æ–¹å¼è·å–åˆ° Arch Linux (å’Œå…¶ä»–å‘è¡Œç‰ˆ) çš„ .config æ–‡ä»¶:</p>

<ol>
  <li>ä½¿ç”¨ zcat è¯»å– <code class="language-plaintext highlighter-rouge">/proc/config.gz</code> çš„å†…å®¹å¹¶ä¸”ä¿å­˜ä¸º .config</li>
  <li>ç›´æ¥å¤åˆ¶ `/usr/lib/modules/$(uname -r)/build/.config</li>
  <li></li>
</ol>

<p>è‹¥è¦ä½¿ç”¨æ–¹æ³• 1 ï¼Œå†…æ ¸éœ€è¦å¼€å¯ <code class="language-plaintext highlighter-rouge">Enable access to .config through /proc/config.gz</code> è¿™ä¸€é€‰é¡¹éœ€è¦æˆ‘ä»¬å°† <code class="language-plaintext highlighter-rouge">IKCONFIG_PROC</code> è®¾ç½®ä¸º y ï¼ˆç›¸å…³ä¾èµ– option é¡¹ç›®ä¹Ÿéœ€è¦æ»¡è¶³ï¼‰</p>

<p>é…ç½®æ–‡ä»¶å‡†å¤‡å¥½åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æ„å»ºå†…æ ¸äº†ï¼Œå¦‚æœä½ ä¼šé¢‘ç¹æ„å»ºå†…æ ¸ï¼Œå»ºè®®ä½¿ç”¨ <a href="https://web.archive.org/web/20210514134020/https://ccache.samba.org/">ccache</a> æ¥ç¼“å­˜ç¼–è¯‘çš„ä¸­é—´ç›®æ ‡æ–‡ä»¶ â€œ*.oâ€ã€‚ccache å…·ä½“é…ç½®æ–¹æ³•è¿™é‡Œä¸å¤šåšä»‹ç»ï¼Œç®€å•è¯´ä¸‹ä½¿ç”¨æ–¹æ³•ï¼Œå¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨ gcc,cc,g++,c++ çš„å‰é¢åŠ ä¸Š ccache å³å¯ï¼Œe.g ä½¿ç”¨ ccahe ç¼–è¯‘å†…æ ¸çš„æ„å»ºå‘½ä»¤å¯ä»¥è¿™æ ·å†™: <code class="language-plaintext highlighter-rouge">make CC="ccache gcc" -j8</code>ã€‚æ³¨æ„ï¼šccache ä¸ä¼šæå‡é¦–æ¬¡ç¼–è¯‘çš„é€Ÿåº¦ï¼Œå®ƒä¼šå°†è¿™äº›ä¸­é—´æ–‡ä»¶ç¼“å­˜èµ·æ¥ï¼Œåœ¨åç»­çš„ recompilation ä¸­æ£€æŸ¥æ˜¯å¦æœ‰å¯ä»¥å‘½ä¸­ç¼“å­˜çš„ä¸­é—´æ–‡ä»¶ï¼Œæœ‰çš„è¯ç›´æ¥ä½¿ç”¨è€Œä¸ç”¨é‡æ–°ç¼–è¯‘ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æå‡äºŒæ¬¡ç¼–è¯‘çš„é€Ÿåº¦<br />
æ„å»ºå†…æ ¸åï¼Œæˆ‘ä»¬éœ€è¦è¿è¡Œ make modules_install ä¾› initramfs ä½¿ç”¨ç›¸åº”çš„ kernel moduleã€‚</p>

<h3 id="0x01-æ„å»ºåˆé€‚çš„-initramfs">0x01 æ„å»ºåˆé€‚çš„ initramfs</h3>

<p>(å»ºè®®ä»¥ä¸‹æ“ä½œåœ¨ä¸€ä¸ªå¹²å‡€çš„ working directory è¿›è¡Œ)</p>

<p>æˆ‘ä»¬å°†ä¼šä½¿ç”¨ QEMU æä¾›çš„ virtio device åŠŸèƒ½æ¥ map host OS çš„ filesystem image åˆ° guest OS é‡Œã€‚å› æ­¤æˆ‘ä»¬éœ€è¦ guest OS æ”¯æŒ virtio é©±åŠ¨ï¼Œå› ä¸ºæˆ‘ä»¬çš„ rootfs å°±æ˜¯ virtio device, æˆ‘ä»¬éœ€è¦åœ¨å†…æ ¸å¯åŠ¨çš„æ—¶å€™å°±åŠ è½½å¥½ virtio é©±åŠ¨ï¼Œè¿™é‡Œæœ‰ä¸¤ä¸ª approach: ç¬¬ä¸€ä¸ªå°±æ˜¯å°†è¯¥é©±åŠ¨ä½œä¸ºå†…æ ¸çš„ builtin è€Œé moduleï¼Œç¬¬äºŒä¸ª approach åˆ™æ˜¯åœ¨ initramfs é‡ŒåŠ è½½ç›¸åº”çš„é©±åŠ¨ã€‚</p>

<p>åœ¨å¯åŠ¨çš„æ—¶å€™ï¼ŒQEMU çš„ bootloader è£…è½½ kernel ä»¥åŠ initramfs åˆ°å†…å­˜ä¸­ï¼Œå¹¶å¯åŠ¨å†…æ ¸ï¼Œå†…æ ¸ä¼šå¯¹ initramfs çš„å­˜åœ¨è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå­˜åœ¨ initramfs åˆ™å°†å…¶ mount åˆ° / å¹¶è¿è¡Œ /init (å®Œæˆä¸€ç³»åˆ—å¤æ‚çš„ user-space åˆå§‹åŒ–å·¥ä½œ) è¿™ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿä¼šç”¨æˆ‘ä»¬åœ¨ kernel cmdline é‡ŒæŒ‡å®šçš„ root disk mount åˆ° / ã€‚</p>

<p>å…·ä½“è¿‡ç¨‹å¦‚ä¸‹, initramfs åŠ è½½åï¼Œæ‰§è¡Œ /init è„šæœ¬, /init ä¸­å°† root disk mount åˆ° initramfs çš„ /new_root ä¸Šï¼Œè€Œåé€šè¿‡ <code class="language-plaintext highlighter-rouge">switch_root</code> å°† mount tree çš„ root æ›¿æ¢ä¸º /new_root ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨ kernel cmdline é‡ŒæŒ‡å®šçš„ root diskã€‚åŒæ—¶ /init è„šæœ¬ä¹Ÿä¼šå¯¹é…ç½®åˆ° initramfs é‡Œçš„ kernel module è¿›è¡Œ modprobe (insmod)ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ initramfs å¯åŠ¨è£…è½½åˆé€‚çš„é©±åŠ¨åå¯åŠ¨å„ç§ä¸åŒçš„ root disk äº†( USB, RAID, dm-crypt, etc)ã€‚</p>

<p>å› è€Œæˆ‘ä»¬éœ€è¦æ„å»ºåˆé€‚çš„ initramfs ä½¿å¾—æˆ‘ä»¬çš„ virtio disk å¯ä»¥è¢«åŠ è½½ï¼Œæˆ‘ä»¬ä½¿ç”¨ Arch Linux å†…çš„ initramfs æ„å»ºå·¥å…· mkinitcpio è¿›è¡Œæ„å»ºã€‚mkinitcpio ä½¿ç”¨ .preset æ–‡ä»¶ç®¡ç†æ„å»ºç‰¹å®š initramfs çš„è§„åˆ™ï¼Œæˆ‘ä»¬ç¼–å†™è‡ªå®šä¹‰çš„ .preset æ–‡ä»¶ linux-dev.presetã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># mkinitcpio preset file for the 'linux-macbook' package

ALL\_config="./mkinitcpio.conf"
ALL\_kver="5.0.0-rc4-macbook+"

HOOKS=()
PRESETS=('default' 'fallback')

# default\_config="/etc/mkinitcpio.conf"
default\_image="initramfs-linux-dev.img"
# default\_options=""

# fallback\_config="/etc/mkinitcpio.conf"
fallback\_image="initramfs-linux-dev-fallback.img"
fallback\_options="-S autodetect"

</code></pre></div></div>

<p>ä¸Šé¢çš„ linux-dev.preset é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åªç”Ÿæˆ default è€Œä¸ç”Ÿæˆ fallback ram imageã€‚æ³¨æ„ ALL_kver è¦å’Œä½ ç¼–è¯‘å‡ºçš„å†…æ ¸çš„ kernel version ä¸€è‡´ï¼Œä¸ç„¶åœ¨ ramfs modprobe çš„æ—¶å€™ä¼šå› ä¸ºæ‰¾ä¸åˆ° /lib/modules/$(uname -r)/ å¯¼è‡´å†…æ ¸åœ¨ initramfs é˜¶æ®µåŠ è½½æˆ‘ä»¬é¢„å…ˆå®šä¹‰å¥½çš„é©±åŠ¨å¤±è´¥ã€‚<br />
ä¸ºäº†ä¿ç•™ç³»ç»ŸåŸæœ‰çš„ mkinitcpio.conf ä¸è¢«æ›´æ”¹ï¼Œæˆ‘ä»¬å¤åˆ¶äº† mkinitcpio.conf å‡ºæ¥å¹¶ä¸”åˆ¶å®š linux-dev.preset è·Ÿéšè¯¥å‰¯æœ¬çš„é…ç½®, mkinitcpio.conf æˆ‘ä»¬åªåšä¸€ç‚¹ä¿®æ”¹ï¼Œæ›´æ”¹ä¸‹åŠ è½½çš„ MODULES ä»¥åŠè°ƒç”¨çš„ HOOKS :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MODULES="virtio virtio\_blk virtio\_pci virtio\_net ext4 xfs radeon"
HOOKS="base udev autodetect modconf block filesystems keyboard fsck"

</code></pre></div></div>

<p>å¤§å®¶å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œä¿®æ”¹ç›¸åº”çš„ modules, å€¼å¾—æ³¨æ„çš„æ˜¯æˆ‘ä»¬åœ¨ MODULES é‡Œéœ€è¦åˆ¶å®š virtio ç³»åˆ—çš„é©±åŠ¨ç¨‹åºï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½å¤Ÿè®© kernel åœ¨ bootup process è¯†åˆ«å‡ºæˆ‘ä»¬çš„ virtio è®¾å¤‡ã€‚<br />
åšå¥½ä¸Šè¿°å‡†å¤‡åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç”Ÿæˆ initramfs äº†: <code class="language-plaintext highlighter-rouge">mkinitcpio -p ./linux-dev.preset</code> ã€‚æ‰§è¡Œåæˆ‘ä»¬å°±åœ¨å½“å‰ç›®å½•è·å¾—äº† initramfs-linux-dev.img è¿™æ ·ä¸€ä¸ª ramdisk cpio gzip compressed image<br />
ä»¥ä¸‹æ˜¯æˆ‘çš„ working directory åœ¨æ‰§è¡Œå®Œæ¯• initramfs ç”Ÿæˆåçš„æ–‡ä»¶åˆ—è¡¨:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â•°â”€(Â´ãƒ»Ï‰ãƒ»)ã¤  ls -al
total 42016
drwxr-xr-x  2 void001 void001      162 Jan 31 18:03 .
drwxrwxr-x 32 void001 void001     4096 Jan 31 15:55 ..
-rw-r--r--  1 void001 void001 31195709 Jan 31 18:01 initramfs-linux-dev-fallback.img
-rw-r--r--  1 void001 void001 11802418 Jan 31 18:00 initramfs-linux-dev.img
-rw-r--r--  1 void001 void001      403 Jan 31 11:30 linux-dev.preset
-rw-r--r--  1 void001 void001     2545 Jan 31 11:24 mkinitcpio.conf
-rwxr-xr-x  1 void001 void001      428 Jan 30 19:54 mk.sh
lrwxrwxrwx  1 void001 void001       24 Jan 30 19:54 vmlinuz-linux-dev -&gt; ../arch/x86/boot/bzImage

</code></pre></div></div>

<h3 id="0x02-å®‰è£…-arch-linux-åˆ°-filesystem-image">0x02 å®‰è£… Arch Linux åˆ° filesystem image</h3>

<p>æˆ‘ä»¬é¦–å…ˆé€šè¿‡ qemu-img åˆ›å»º root.img home.img ä¸¤ä¸ª disk image (ä¹Ÿå¯ä»¥åªåˆ›å»ºä¸€ä¸ªï¼Œæ ¹æ®ä¸ªäººå–œå¥½è‡ªè¡Œé€‰æ‹©ï¼‰<br />
ä» <a href="https://web.archive.org/web/20210514134020/https://archlinux.org/download">https://archlinux.org/download</a> è·å¾—ä¸€ä¸ª Latest ArchISOï¼Œç„¶åä½¿ç”¨å¦‚ä¸‹å‚æ•°å¯åŠ¨ QEMU:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-system-x86\_64 -cdrom /path/to/your/livecd.iso --enable-kvm -m 2048 -nic user,model=virtio-net-pci # æŒ‡å®š cdrom å†…å®¹ä¸º LiveCD, ä½¿ç”¨ KVM, é™åˆ¶ä½¿ç”¨å†…å­˜ 2048M (è¿‡å°ä¼šå¯¼è‡´ ramfs æ— æ³•å®Œå…¨è§£å‹åˆ° ram é‡Œå› è€Œæ— æ³•åŠ è½½ LiveCD),ä½¿ç”¨ virtio net device ä½œä¸ºç½‘ç»œè®¾å¤‡

# å¯é€‰å‚æ•°
-nographic # ä¸å¯åŠ¨å›¾å½¢ç•Œé¢ ï¼ˆå¼€å¯è¯¥é€‰é¡¹åå¯ä»¥é€šè¿‡å½“å‰ terminal æ¥ç®¡ Guest OS çš„ Serial output, éœ€è¦åœ¨ cmdline å¢åŠ ä¸€ä¸ªå‚æ•°)
-vnc :0 # å¼€å¯ VNC Server ç›‘å¬ 5900 ç«¯å£
</code></pre></div></div>

<p>å¦‚æœæˆ‘ä»¬æ²¡æœ‰æ·»åŠ é‚£äº›å¯é€‰å‚æ•°é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ QEMU çš„ monitor è¿›è¡Œ ArchLinux çš„å®‰è£…äº†ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹è¿™ä¸ª -nographic é¢å¤–å‚æ•°ã€‚<br />
æ ¹æ® QEMU.1(1) è¯´æ˜ï¼Œå¼€å¯ -nographic ä¹‹å QEMU ä¼šå°†ä¸²å£çš„è¾“å‡º redirect åˆ° terminal(console)ã€‚ä¸ºäº†è®©æˆ‘ä»¬çš„ LiveCD èƒ½å¤Ÿå°†å†…å®¹è¾“å‡ºåˆ° QEMU çš„ emulated Serial, æˆ‘ä»¬åœ¨ bootmenu çš„ kernel cmdline é‡Œæ·»åŠ : <code class="language-plaintext highlighter-rouge">console=ttyS0,38400</code> (38400 baud rate) ç„¶åå¯åŠ¨ LiveCD</p>

<p><img src="https://web.archive.org/web/20210514134020im_/https://void-shana.moe/wp-content/uploads/2019/01/image-1024x293.png" alt="" />ä¿®æ”¹ iso çš„ bootup cmdline</p>

<blockquote>
  <p>QEMU.1(1)</p>

  <p>-nographic<br />
 Normally, if QEMU is compiled with graphical window support, it displays output such as guest graphics, guest console, and the QEMU monitor in a window. With this option, you can totally<br />
 disable graphical output so that QEMU is a simple command line application. The emulated serial port is redirected on the console and muxed with the monitor (unless redirected elsewhere<br />
 explicitly). Therefore, you can still use QEMU to debug a Linux kernel with a serial console. Use C-a h for help on switching between the console and monitor.</p>
</blockquote>

<p>å®‰è£… Arch çš„è¿‡ç¨‹ä¸éœ€è¦å¤šä½™çš„è¯´æ˜ï¼Œå¦‚æœä½ æ˜¯ç¬¬ä¸€æ¬¡å®‰è£… Arch Linux çš„è¯è¯· <a href="https://web.archive.org/web/20210514134020/https://wiki.archlinux.org/index.php/Installation_guide">follow the archlinux wiki</a> å®‰è£…å¥½ä¹‹åï¼Œæˆ‘ä»¬çš„ root file system image å°±åˆ›å»ºå¥½äº†</p>

<h3 id="0x03-åœ¨-qemu-ä¸­è¿è¡Œ-arch-linux-å¹¶ä¸”ä½¿ç”¨è‡ªå®šä¹‰çš„å†…æ ¸">0x03 åœ¨ QEMU ä¸­è¿è¡Œ Arch Linux å¹¶ä¸”ä½¿ç”¨è‡ªå®šä¹‰çš„å†…æ ¸</h3>

<p>è‡³æ­¤æˆ‘ä»¬æ‰€æœ‰çš„å‡†å¤‡å·¥ä½œéƒ½åšå¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å¯åŠ¨ç¼–è¯‘å¥½çš„å†…æ ¸ï¼Œæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹çš„ QEMU å‚æ•°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash
BUILDROOT=/home/void001/Kernel-Hacking/latest-linux-kernel/build
KERNEL=${BUILDROOT}/vmlinuz-linux-dev
INITRAMFS=${BUILDROOT}/initramfs-linux-dev.img

qemu-system-x86\_64 -kernel ${KERNEL} \
    -initrd ${INITRAMFS} \
    -nic user,model=virtio-net-pci \
    -drive file=root.img,if=virtio,index=0 \
    -drive file=home.img,if=virtio,index=1 \
    -nographic \
    -m 2048 \
    -append "earlyprintk=ttyS0 rw root=UUID=7279a4af-7e4d-4aa0-8c19-e47da93eeb87-2333 console=ttyS0,38400 debug" \
    -vnc :0 \
    --enable-kvm

</code></pre></div></div>

<p>ç›¸æ¯”ä¸Šé¢çš„ ISO bootupï¼Œè¿™æ¬¡æˆ‘ä»¬æŒ‡å®šäº† kernel, initrd ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å¯¹åº”è‡ªå®šä¹‰å†…æ ¸æ–‡ä»¶ï¼Œå’Œæˆ‘ä»¬æ„å»ºå¥½çš„ initramfs-linux-dev.imgã€‚åŒæ—¶æˆ‘ä»¬ä½¿ç”¨ -drive åœ¨ guest OS é‡Œåˆ›å»ºä¸¤ä¸ª drive backendï¼Œinterface éƒ½æ˜¯ virtioï¼Œæˆ‘ä»¬å·²ç»åœ¨ initramfs é‡ŒåŠ è½½äº† virtio driver å› æ­¤ root filesystem å¯ä»¥è¢«æ­£ç¡®æ‰¾åˆ°å¹¶å¯åŠ¨ã€‚-append å‚æ•°å°†å…¶ value append åˆ° kernel cmdline æˆ‘ä»¬è¿™é‡ŒæŒ‡å®šäº† root disk (ç›´æ¥æŒ‡å®šä¸º /dev/vd* ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è¿‡æˆ‘è¿™é‡Œæœ‰ä¸¤ä¸ª drive ä¸ºäº†é¿å… /dev/vd* åœ¨æ¯æ¬¡å¯åŠ¨çš„æ—¶å€™åå­—å¯èƒ½å‘ç”Ÿå˜åŠ¨ï¼Œä½¿ç”¨ UUID æŒ‡å®šäº† root device)ã€‚ä½¿ç”¨ä¸Šé¢çš„å‘½ä»¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯åŠ¨ QEMU äº†ï¼Œæœ€åæˆ‘ä»¬çœ‹ä¸‹æ•ˆæœ:</p>

<p><img src="https://web.archive.org/web/20210514134020im_/https://void-shana.moe/wp-content/uploads/2019/01/image-1-1024x139.png" alt="" />å¯ä»¥çœ‹åˆ°è‡ªå®šä¹‰çš„ kernel message ä¿¡æ¯ï¼Œè¿™ä¸ªæ˜¯ä¿®æ”¹ ext4 çš„ module_init äº§ç”Ÿçš„ã€‚
<img src="https://web.archive.org/web/20210514134020im_/https://void-shana.moe/wp-content/uploads/2019/01/a-1024x538.png" alt="" />Kernel is latest rc4 kernel, and CPU is using QEMU, all check</p>
<h3 id="0x04-æ€»ç»“">0x04 æ€»ç»“</h3>

<p>æœ¬æ–‡ä»‹ç»äº†ä¸€ç§å†…æ ¸çˆ±å¥½è€…å¯ä»¥ä½¿ç”¨çš„å†…æ ¸è°ƒè¯•è¿è¡Œæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ— éœ€å°†å†…æ ¸å®‰è£…åˆ° /boot å¹¶ä¸”è¿›è¡Œ reboot åˆ‡æ¢ï¼Œä½¿ç”¨ QEMU + KVM + Serial å°† guest OS çš„è¾“å…¥è¾“å‡ºæ¥ç®¡åˆ° host OS çš„ terminalï¼Œæ–¹ä¾¿æŸ¥çœ‹ï¼Œå¤åˆ¶ä¿¡æ¯å’Œè°ƒè¯•ï¼Œè¯¥æ–¹æ³•ä¹Ÿå¯ä»¥éªŒè¯æˆ‘ä»¬æ„å»ºçš„å†…æ ¸æ˜¯å¦èƒ½å¤Ÿåœ¨ç°å­˜çš„ Linux Distribution ä¸Šå¯åŠ¨æˆåŠŸï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å°† root filesystem image mount åˆ° host OS å¯¹å…¶ä¸­çš„æ–‡ä»¶è¿›è¡Œ manipulateã€‚</p>

<h3 id="0x05-åè®°">0x05 åè®°</h3>

<p>æ–‡ä¸­ä»‹ç»çš„æ–¹æ³•æ˜¯ä¸ @tonyluj è®¨è®ºåå¾—åˆ°çš„æ–¹æ¡ˆï¼Œæœ¬æ–‡å‚è€ƒäº† Arch Linux Wiki, QEMU man page ä»¥åŠ tldp.orgï¼Œåœ¨æ­¤åŠ ä»¥è¯´æ˜ã€‚<br />
è·ç¦»æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« å·²ç»æœ‰å¾ˆä¹…äº†ï¼Œè¿™ä¹‹ä¸­ç»å†äº†å¾ˆå¤šäº‹æƒ…ï¼Œç°åœ¨æ€»ç®—å¯ä»¥é™ä¸‹æ¥ç»§ç»­ç ”ç©¶å†…æ ¸ï¼Œå†™æ–‡ç« å’Œåšå®¢äº†ï¼Œä¹‹åä¹Ÿä¼šç»§ç»­æ’°å†™ Kernel Develop / Linux ç›¸å…³çš„æ–‡ç« ï¼Œçœ‹äº†ä¸‹æ—¶é—´ä¹Ÿå¿«è¦è¿‡æ˜¥èŠ‚äº†ï¼Œæœ€åæå‰ç¥å¤§å®¶æ˜¥èŠ‚å¿«ä¹ï¼</p>

<hr />

<p><a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/category/linux/archlinux">archlinux</a>, <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/category/kernel">Kernel</a>, <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/category/linux">Linux</a> <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/tag/archlinux">archlinux</a>, <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/tag/kernel">kernel</a>, <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/tag/linux">linux</a>, <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/tag/qemu">qemu</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<ol>
  <li>
    <p><img src="https://web.archive.org/web/20210514134020im_/https://secure.gravatar.com/avatar/3e3c1cb94b9ad3551cd9d43f2e52e105?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514134020/https://blog.lilydjwg.me/">ä¾äº‘</a></strong> says: 
<a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/linux/running-arch-linux-with-customized-kernel-in-qemu.html#comment-516">January 31, 2019 at 10:15 pm</a>
ä½ ä¹Ÿå¼„è¿™ä¸ªäº†å‘€ã€‚æˆ‘å½“åˆæ˜¯ç›´æ¥åœ¨ kvm è™šæ‹Ÿæœºé‡Œè£…è‡ªå·±æ‰“åŒ…çš„ linux-lily å†…æ ¸æ¥ç€ï¼Œä¸ºäº†æµ‹è¯•æ‰“çš„åŒ…æ˜¯ä¸æ˜¯å¥½çš„ã€‚
<a href="https://web.archive.org/web/20210514134020/https://blog.lilydjwg.me/2014/7/15/arch-kvm-in-arch.52548.html">https://blog.lilydjwg.me/2014/7/15/arch-kvm-in-arch.52548.html</a></p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514134020im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/linux/running-arch-linux-with-customized-kernel-in-qemu.html#comment-518">January 31, 2019 at 10:46 pm</a>
 wwï¼Œ åŸæ¥ç™¾åˆå–µæ—©å°±å¼„è¿‡å•¦ï¼Œçªè¿™è¾¹æ˜¯å‡†å¤‡ç”¨æ¥ç ”ç©¶å†…æ ¸å†™ä»£ç æµ‹è¯•ç”¨ï¼Œä»¥å‰éƒ½æ˜¯ç”¨æˆ‘çš„å°æœ¬æœ¬ç›´æ¥å¯åŠ¨ï¼Œé‚£æ ·æ„Ÿè§‰å¤ªè´¹åŠ²äº†ï¼Œç„¶å buildroot çš„æ–¹æ¡ˆæˆ‘è¿˜æ²¡ææ˜ç™½ï¼Œäºæ˜¯å°±é€‰ç”¨äº†è¿™æ ·ä¸€ä¸ªæ–¹æ¡ˆï¼Œç›®å‰æ¥è¯´æ„Ÿè§‰è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ï¼Œç­‰æˆ‘ä»€ä¹ˆæ—¶å€™ææ¸…æ¥š buildroot æˆ‘å†æ€»ç»“ä¸‹ä»–çš„ä½¿ç”¨æ–¹æ³•</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514134020im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
<a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/linux/running-arch-linux-with-customized-kernel-in-qemu.html#comment-520">February 1, 2019 at 10:41 am</a>
David Gao ä¹Ÿå®‰åˆ©æˆ‘äº†virt-manager æˆ‘ç”¨æ¥è·‘ Win10 äº†ï¼ˆ</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514134020im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
<a href="https://web.archive.org/web/20210514134020/https://void-shana.moe/linux/running-arch-linux-with-customized-kernel-in-qemu.html#comment-520">February 1, 2019 at 10:41 am</a>
David Gao ä¹Ÿå®‰åˆ©æˆ‘äº†virt-manager æˆ‘ç”¨æ¥è·‘ Win10 äº†ï¼ˆ</p>
  </li>
</ol>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry><entry><title type="html">proxychains-ng åŸç†è§£æ</title><link href="https://void-shana.moe//posts/proxychains-ng" rel="alternate" type="text/html" title="proxychains-ng åŸç†è§£æ" /><published>2018-08-14T00:00:00+08:00</published><updated>2018-08-14T00:00:00+08:00</updated><id>https://void-shana.moe//posts/proxychains-ng</id><content type="html" xml:base="https://void-shana.moe//posts/proxychains-ng"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="august-14-2018"><a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html" title="5:04 pm">August 14, 2018</a></h5>
<p><a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comments">12 comments</a></p>

<p>Preface
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>æèµ· proxychainsÂ ç›¸ä¿¡å¤§å®¶éƒ½å¹¶ä¸é™Œç”Ÿï¼Œè¿™ä¸ªç¨‹åºå¯ä»¥æ–¹ä¾¿çš„è®©ä½ åœ¨ç»ˆç«¯ä½¿ç”¨ SOCKS5, SOCKS4, HTTP ç­‰åè®®ä»£ç†ç½‘ç»œè®¿é—®ï¼Œè€Œä¸éœ€è¦ä¸ºäº†è½¬æ¢ SOCKS5 åè®®å†æ­å»ºä¸€ä¸ª HTTP çš„ä»£ç†æ¥ä½¿ç”¨ http_proxy, https_proxy è¿™äº› Shell å†…ç½®çš„ç¯å¢ƒå˜é‡æ¥è®¿é—®ç½‘ç»œäº†ã€‚ä¸è¿‡ proxychainsÂ å¹¶ä¸å¯¹æ‰€æœ‰çš„åº”ç”¨ç¨‹åºæœ‰æ•ˆï¼Œä¸€ä¸ªå…¸å‹çš„æƒ…å†µæ˜¯ Golang ç¼–å†™çš„ ç¨‹åºæ˜¯æ— æ³•ä½¿ç”¨ proxychainsÂ è¿›è¡Œä»£ç†çš„ã€‚åœ¨ä½¿ç”¨ proxychainsÂ çš„æ—¶å€™ä¼šæŠ¥è¿™æ ·çš„é”™è¯¯:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dial tcp 224.0.0.1:80: connect: network is unreachable
</code></pre></div></div>

<p>ä¸‹é¢å°±é€šè¿‡å¯¹ proxychains-ng çš„åŸç†çš„è§£æï¼Œæ¥è§£ç­”è¿™ä¸ªé—®é¢˜ï¼Œå¹¶ä¸”ä¸º golang ç¼–å†™çš„ç¨‹åºæä¾›ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚</p>

<p>Shared Libraries
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>Linux ä¸‹çš„å¾ˆå¤šç¨‹åºéƒ½ä¾èµ–ç€å¤šç§å¤šæ ·çš„<strong>åŠ¨æ€é“¾æ¥åº“(shared library)</strong>ï¼Œä½¿ç”¨åŠ¨æ€é“¾æ¥åº“æ—¢å¯ä»¥èŠ‚çœç£ç›˜çš„ç©ºé—´å¤§å°ï¼ˆä½ ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºä¸ä¼šç‰¹åˆ«å¤§ï¼‰ï¼ŒåŒæ—¶ä¹Ÿä¼šèŠ‚çœç¨‹åºçš„è¿è¡Œå†…å­˜ï¼Œå¤šä¸ªå…±äº«åŠ¨æ€é“¾æ¥åº“çš„è¿›ç¨‹åªéœ€è¦ä¸€ä»½åº“åœ¨å†…å­˜ä¸­ã€‚è‹¥æ˜¯é™æ€é“¾æ¥çš„è¯ï¼Œåˆ™æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½è¦å¸¦ä¸€ä»½åº“ã€‚é€šè¿‡Â ls -l /usr/libÂ (æ ¹æ®å‘è¡Œç‰ˆä¸åŒè·¯å¾„å¯èƒ½ä¼šæœ‰ä¸åŒ)å³å¯çœ‹åˆ°å¾ˆå¤šåŠ¨æ€é“¾æ¥åº“ã€‚</p>

<p>é¦–å…ˆæ¥ä»‹ç»å‡ ä¸ªåŠ¨æ€é“¾æ¥åº“çš„åŸºæœ¬çŸ¥è¯†ï¼Œå¤§å®¶ä¼šå‘ç°è¿™ä¸ªæ–‡ä»¶å¤¹ä¸‹é¢æœ‰å¾ˆå¤šé“¾æ¥ï¼Œæ¯”å¦‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lrwxrwxrwx   1 root root        19 Aug  7 00:22 libzmf-0.0.so -&gt; libzmf-0.0.so.0.0.2                                                                                                                         
lrwxrwxrwx   1 root root        19 Aug  7 00:22 libzmf-0.0.so.0 -&gt; libzmf-0.0.so.0.0.2
</code></pre></div></div>

<p>æœ‰ä¸¤ä¸ªæŒ‡å‘ libzmf-0.0.so.0.0.2 çš„è½¯è¿æ¥è¿™äº›æ–‡ä»¶çš„åå­—å¾ˆç›¸ä¼¼ï¼Œé‚£ä¹ˆå…·ä½“éƒ½ä»£è¡¨ä»€ä¹ˆå‘¢ï¼Œä¸‹é¢å°±æ¥è¿›è¡Œè¯´æ˜ã€‚</p>

<p>å¯¹äºä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“æ¥è¯´ï¼Œæœ‰ä¸‰ä¸ªåå­—ï¼Œåˆ†åˆ«æ˜¯ soname, linkername å’Œ realname</p>

<ul>
  <li>linkername: libxxx.so (æ²¡æœ‰ä»»ä½•ç‰ˆæœ¬å·) åœ¨å®‰è£… library çš„æ—¶å€™å»ºç«‹ï¼Œæ˜¯ä¸€ä¸ªé“¾æ¥åˆ° realname çš„è½¯é“¾æ¥</li>
  <li>soname: libxxx.so.(VER) (å¸¦æœ‰ç‰ˆæœ¬å·) åœ¨å®‰è£… library çš„æ—¶å€™å»ºç«‹ï¼Œæ˜¯ä¸€ä¸ªé“¾æ¥åˆ° realname çš„è½¯é“¾æ¥</li>
  <li>realname: libxxx.so.(VER).(MINOR).[RELEASE] (å¿…é¡»å¸¦æœ‰ç‰ˆæœ¬å·å’Œ minor number, å¯é€‰çš„ä¸ºå¸¦æœ‰ release number) æ˜¯è¯¥ library æœ¬èº«</li>
</ul>

<p>å¯¹äºä¸Šé¢è¿™ä¸ªä¾‹å­æ¥è¯´ libzmf-0.0 çš„ soname å°±æ˜¯ libzmf-0.0.so.0ï¼ŒÂ linkernameÂ æ˜¯ libzmf-0.0.soï¼Œrealname æ˜¯ libzmf-0.0.so.0.0.2</p>

<p>å½“ä¸€ä¸ªç¨‹åºæŒ‡å®šè¦é“¾æ¥çš„åŠ¨æ€é“¾æ¥åº“çš„æ—¶å€™ï¼Œä»–ä»¬æŒ‡å®šçš„æ˜¯è¿™ä¸ªé“¾æ¥åº“çš„ soname, è€Œä¸æ˜¯ realnameÂ è¿™æ ·çš„è€ƒé‡æ˜¯åœ¨é“¾æ¥åº“æ›´æ–° minor number çš„æ—¶å€™ï¼Œä¸éœ€è¦å¯¹è¿™ä¸ªç¨‹åºè¿›è¡Œé‡æ–°é“¾æ¥ï¼Œè‡³äºä¸ºä»€ä¹ˆæ²¡æœ‰ç”¨ linkernameÂ æ˜¯ä¸ºäº† ABI å…¼å®¹æ€§è€ƒè™‘ï¼Œå½“ä¸€ä¸ªåº“å‡çº§å ABI å‘ç”Ÿäº†å˜åŒ–æ—¶ï¼Œä¾èµ–è¿™ä¸ªåº“çš„ç¨‹åºå¿…é¡»è¦é‡æ–°ç¼–è¯‘æ‰èƒ½ä½¿ç”¨ï¼Œå¦åˆ™å°±ä¼šå› ä¸º ABI ä¸å…¼å®¹å¯¼è‡´æ®µé”™è¯¯ç­‰é—®é¢˜å‘ç”Ÿã€‚å› è€Œå½“ä¸€ä¸ªåº“çš„ MAJOR VER NUMBER æ›´æ–°æ—¶ï¼Œè¯´æ˜å®ƒæœ‰ ABI Breaking Change. è€Œå½“ä¸€ä¸ªåº“åªæ˜¯æ›´æ–°äº† MINOR/RELEASE NUMBER çš„æ—¶å€™ è¿™æ—¶æˆ‘ä»¬ä¸éœ€è¦è¿›è¡Œé‡æ–°ç¼–è¯‘ã€‚</p>

<p>Dynamic Loading Progress
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>æœ¬æ–‡é‡ç‚¹åœ¨äºè®²è§£ proxychainsÂ çš„åŸç†ï¼Œå› è€Œå¯¹ loader éƒ¨åˆ†åªæåŠç›¸å…³éƒ¨åˆ†ï¼Œä¸‹è¿°è¿‡ç¨‹å¹¶ä¸æ˜¯å®Œæ•´çš„ç¨‹åºåŠ è½½è¿‡ç¨‹</p>

<p>åœ¨ Linux ä¸Šæ‰€æœ‰åŠ¨æ€é“¾æ¥çš„ç¨‹åºéƒ½ä¼šé“¾æ¥ä¸€ä¸ªÂ ld-linux-xxxx.so(ä¸‹é¢ç®€ç§° ld-linux.so) çš„åŠ¨æ€é“¾æ¥åº“ï¼Œè¿™ä¸ªåŠ¨æ€é“¾æ¥åº“å¾ˆç‰¹æ®Šï¼Œå®ƒä¼šè§£æè¯¥ç¨‹åºæ‰€éœ€çš„ shared librairesÂ ï¼Œå¹¶ä¸”åŠ è½½ä»–ä»¬ä»¥åŠä»–ä»¬å¿…è¦çš„ä¾èµ– æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹æ¯ä¸€ä¸ªåŠ¨æ€é“¾æ¥çš„ç¨‹åºçš„ Dynamic Section äº†è§£åˆ°å…¶ä¾èµ–çš„é“¾æ¥åº“éƒ½æ˜¯ä»€ä¹ˆã€‚æ¯”å¦‚è¿™æ˜¯ curl <strong>ç›´æ¥ä¾èµ–</strong>çš„åŠ¨æ€é“¾æ¥åº“:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â•°â”€(Â´ãƒ»Ï‰ãƒ»)ã¤  readelf -a /usr/bin/curl | grep NEEDED
 0x0000000000000001 (NEEDED)             Shared library: [libcurl.so.4]
 0x0000000000000001 (NEEDED)             Shared library: [libpthread.so.0]
 0x0000000000000001 (NEEDED)             Shared library: [libc.so.6]
</code></pre></div></div>

<p>æ³¨æ„è¿™äº›åªæ˜¯ â€œç›´æ¥ä¾èµ–â€, ld-linux.so è¿˜ä¼šå»è§£æè¿™äº›ä¾èµ–çš„ library çš„ä¾èµ–æ˜¯ä»€ä¹ˆï¼Œæœ€åå¾—åˆ°æˆ‘ä»¬é€šè¿‡ lddÂ çœ‹åˆ°çš„è¾“å‡ºç»“æœ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â•°â”€(Â´ãƒ»Ï‰ãƒ»)ã¤  ldd /usr/bin/curl                                                                                                                                                                          1 â†µ
        linux-vdso.so.1 (0x00007fffb9f6a000)
        libcurl.so.4 =&gt; /usr/lib/libcurl.so.4 (0x00007fd1cbbd6000)
        libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007fd1cbbb5000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fd1cb9f1000)
        libnghttp2.so.14 =&gt; /usr/lib/libnghttp2.so.14 (0x00007fd1cb7cc000)
        libidn2.so.0 =&gt; /usr/lib/libidn2.so.0 (0x00007fd1cb5af000)
        libpsl.so.5 =&gt; /usr/lib/libpsl.so.5 (0x00007fd1cb39f000)
        libssl.so.1.1 =&gt; /usr/lib/libssl.so.1.1 (0x00007fd1cb133000)
        libcrypto.so.1.1 =&gt; /usr/lib/libcrypto.so.1.1 (0x00007fd1cacb6000)
        libgssapi\_krb5.so.2 =&gt; /usr/lib/libgssapi\_krb5.so.2 (0x00007fd1caa68000)
        libkrb5.so.3 =&gt; /usr/lib/libkrb5.so.3 (0x00007fd1ca77f000)
        libk5crypto.so.3 =&gt; /usr/lib/libk5crypto.so.3 (0x00007fd1ca54c000)
        libcom\_err.so.2 =&gt; /usr/lib/libcom\_err.so.2 (0x00007fd1ca348000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0x00007fd1ca12f000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fd1cc0e0000)
        libunistring.so.2 =&gt; /usr/lib/libunistring.so.2 (0x00007fd1c9daf000)
        libdl.so.2 =&gt; /usr/lib/libdl.so.2 (0x00007fd1c9daa000)
        libkrb5support.so.0 =&gt; /usr/lib/libkrb5support.so.0 (0x00007fd1c9b9d000)
        libkeyutils.so.1 =&gt; /usr/lib/libkeyutils.so.1 (0x00007fd1c9999000)
        libresolv.so.2 =&gt; /usr/lib/libresolv.so.2 (0x00007fd1c997e000)

</code></pre></div></div>

<p>å¯¹äºæ¯ä¸€ä¸ª library æ˜¯å¦‚ä½•è§£æåˆ°å…¶è·¯å¾„çš„å…·ä½“è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ man 8Â ld-linuxÂ Â äº†è§£å…·ä½“è¿‡ç¨‹</p>

<h2 id="special-environment-variable-ld_preload">Special Environment Variable: LD_PRELOAD</h2>

<p>åœ¨ ld-linux(8) çš„ Man Page é‡Œ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€ä¸ªç¯å¢ƒå˜é‡çš„è¯´æ˜: LD_PRELOAD</p>

<blockquote>
  <p>A list of additional, user-specified, ELF shared objects to be loaded before all others.</p>

</blockquote>

<p>å½“ secure-execution æ¨¡å¼æ²¡æœ‰å¼€å¯çš„æ—¶å€™ æŒ‡å®š åœ¨ LD_PRELOAD é‡Œçš„ shared library ä¼šæ¯”å…¶ä»–ä»»ä½• shared libray éƒ½å…ˆåŠ è½½. è¿™å°±ç»™æˆ‘ä»¬å»ä¼ªé€ , hook è°ƒç”¨å‡½æ•°æä¾›äº†é€”å¾„ã€‚</p>

<p>èƒŒæ™¯çŸ¥è¯†é“ºå«åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»“åˆ proxychains-ng çš„ä»£ç ä»‹ç»å…¶åŸç†</p>

<p>Proxychains-ng çš„åŸç†
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>ç®€å•æ¥è¯´, proxychains-ng å°±æ˜¯ hook äº† libc é‡Œæä¾›çš„åŸºæœ¬ç½‘ç»œé€šè®¯å‡½æ•°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//â•°â”€(Â´ãƒ»Ï‰ãƒ»)ã¤  cat libproxychains.c  | grep SETUP
#define SETUP\_SYM(X) do { if (! true\_ ## X ) true\_ ## X = load\_sym( # X, X ); } while(0)
        SETUP\_SYM(connect);
        SETUP\_SYM(sendto);
        SETUP\_SYM(gethostbyname);
        SETUP\_SYM(getaddrinfo);
        SETUP\_SYM(freeaddrinfo);
        SETUP\_SYM(gethostbyaddr);
        SETUP\_SYM(getnameinfo);
        SETUP\_SYM(close);
        SETUP\_SYM(\_\_xnet\_connect);

</code></pre></div></div>

<p>è¿™äº›åŒ…åœ¨ SETUP_SYM é‡Œçš„å‡½æ•°(åœ¨ SOLARIS ä¸­ connect æ˜¯ __xnet_connect)ä¼šè¢« proxychains è¿›è¡Œ hookï¼Œ ç„¶åé€šè¿‡å†…ç½®çš„ hook å‡½æ•°è¿›è¡Œåç»­ä»£ç†æ“ä½œã€‚</p>

<p>æˆ‘ä»¬æŸ¥çœ‹ <a href="https://web.archive.org/web/20210514123224/https://github.com/rofl0r/proxychains-ng/blob/1c8f8e4e7e31e64131f5f5e031f216b557f7b5ed/src/libproxychains.c#L442">src/libproxychains.c</a>Â å¯ä»¥å‘ç°ï¼Œè¿™ä¸ª libproxychains.c å«æœ‰ connect, sendto, â€¦ è¿™äº›å‡½æ•°, è€Œä¸”å‡½æ•°çš„ç­¾åå’Œ connect(3) sendto(3)â€¦ çš„éƒ½ä¸€æ ·</p>

<p>è¿™å°±æ˜¯ proxychainsÂ çš„åŸç†æ‰€åœ¨ï¼Œproxychains å°†è¿™äº›å‡½æ•°é‡å†™ä¸€ä»½ï¼Œå¹¶ä¸” export libproxychains ä¸º shared library. å½“è¯¥ Library è¢« preload (è®¾ç½®åœ¨ LD_PRELOAD) é‡Œçš„æ—¶å€™ï¼Œåˆ™åœ¨ç¨‹åºè°ƒç”¨ connect , close ç­‰ç½‘ç»œç›¸å…³çš„ libc å‡½æ•°çš„æ—¶å€™ï¼Œå°±ä¼šè¢« proxychainsÂ æ¥ç®¡ã€‚</p>

<p>æˆ‘ä»¬åœ¨ä»£ç é‡Œè¿˜èƒ½çœ‹åˆ°å¾ˆå¤šçš„ true_xxx å‡½æ•°, ä»–ä»¬åªæœ‰å‡½æ•°è°ƒç”¨æ²¡æœ‰å®šä¹‰, åœ¨ src/core.h ä¸­å®šä¹‰è¿™äº›ç¬¦å·ä»å¤–éƒ¨å¼•ç”¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// src/core.h
extern connect\_t true\_connect;

</code></pre></div></div>

<p>ä¸ºäº†è¿›ä¸€æ­¥ç†è§£ proxychains æˆ‘ä»¬éœ€è¦å¼„æ¸…æ¥š è¿™ä¸ª true_xxx ä»ä½•è€Œæ¥, å› ä¸ºè¿™äº›å‡½æ•°è¢«é’©å­å‡½æ•°ä»¬å±¡æ¬¡è°ƒç”¨ã€‚æˆ‘ä»¬ç°åœ¨å°±å›åˆ° SETUP_SYM è¿™ä¸ªå®çš„å®šä¹‰ä¸Šæ¥</p>

<p>SETUP_SYM è¿™ä¸ªå®å°±æ˜¯ true_xxx ç³»åˆ—å‡½æ•°çš„è§£æçš„å…³é”®</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define SETUP\_SYM(X) do { if (! true\_ ## X ) true\_ ## X = load\_sym( # X, X ); } while(0)

</code></pre></div></div>

<p>æˆ‘ä»¬ä»¥ connect ä¸ºä¾‹ï¼Œå±•å¼€ä¸€ä¸‹è¿™ä¸ªå®:Â SETUP_SYM(connect) è¢«å±•å¼€ä¸º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> do { if (! true\_connect ) true\_connect = load\_sym( "connect", connect ); } while(0);

</code></pre></div></div>

<p>è¿™é‡Œ å® invoke äº† load_sym å‡½æ•°, è¯¥å‡½æ•°<a href="https://web.archive.org/web/20210514123224/https://github.com/rofl0r/proxychains-ng/blob/1c8f8e4e7e31e64131f5f5e031f216b557f7b5ed/src/libproxychains.c#L83">å¦‚ä¸‹</a>Â :</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static void* load\_sym(char* symname, void* proxyfunc) {

	void *funcptr = dlsym(RTLD\_NEXT, symname);

	if(!funcptr) {
		fprintf(stderr, "Cannot load symbol '%s' %s\n", symname, dlerror());
		exit(1);
	} else {
		PDEBUG("loaded symbol '%s'" " real addr %p  wrapped addr %p\n", symname, funcptr, proxyfunc);
	}
	if(funcptr The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog) proxyfunc) {
		PDEBUG("circular reference detected, aborting!\n");
		abort();
	}
	return funcptr;
}
</code></pre></div></div>

<p>load_sym è°ƒç”¨äº† dlsym å¹¶ä¸”å°† dlsym è¿”å›å€¼è¿”å›ï¼Œç„¶åé€šè¿‡ä¸Šé¢çš„å®æˆ‘ä»¬å°±çŸ¥é“ true_xxx å°±ä¼šå¾—åˆ°è¿™ä¸ªè¿”å›çš„åœ°å€ ä¹Ÿå°±æ˜¯å‡½æ•°åœ°å€ã€‚å¦ä¸€é—®é¢˜å°±æ˜¯ï¼Œè¿™ä¸ªè¿”å›çš„åœ°å€æ„å‘³ä»€ä¹ˆï¼Ÿç›¸ä¿¡å¾ˆå¤šäººå·²ç»çŒœåˆ°äº†ï¼Œtrue_xxx è¿™äº›å‡½æ•°å°±åº”è¯¥æ˜¯æŒ‡å‘é‚£äº›æ²¡æœ‰è¢« hook çš„åŸå§‹ç½‘ç»œå‡½æ•°çš„ã€‚æˆ‘ä»¬ç°åœ¨æŸ¥çœ‹ dlsym çš„å…·ä½“è°ƒç”¨çš„å«ä¹‰ã€‚é€šè¿‡ dlsym(3) æˆ‘ä»¬çŸ¥é“äº†ï¼Œ dlsym çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«ä¸º dlopen æ‰“å¼€çš„ handle, ä»¥åŠè¦è§£æçš„ symbol nameã€‚è€ŒÂ  RTLD_NEXT å’Œ RTLD_DEFAULT æ˜¯ä¸¤ä¸ª pseudo-handleã€‚æˆ‘ä»¬è¿™é‡Œè´´ä¸€ä¸‹ RTLD_NEXT çš„è§£é‡Šçš„å…¨æ–‡</p>

<blockquote>
  <p>RTLD_NEXT</p>

  <p>Find the next occurrence of the desired symbol in the search order after the current object. This allows one to provide a wrapper around a function in another shared object, so that,</p>

  <p>for example, the definition of a function in a preloaded shared object (see LD_PRELOAD in ld.so(8)) can find and invoke the â€œrealâ€ function provided in another shared object (or for</p>

  <p>that matter, the â€œnextâ€ definition of the function in cases where there are multiple layers of preloading).</p>

</blockquote>

<p>å¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ª pseudo-handle ä¼šé€šè¿‡è§£æå½“å‰çš„ library search path æ‰¾åˆ° <strong>ç¬¬äºŒä¸ª</strong>symbol name ç­‰äº symname çš„å‡½æ•°ï¼Œmanpage é‡Œè¿˜è´´å¿ƒçš„ç»™å‡ºäº†ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œå°±æ˜¯åœ¨è¿™ç§ LD_PRELOAD çš„æƒ…å†µä¸‹æƒ³è¦åŠ è½½ â€œrealâ€ å‡½æ•°çš„æ—¶å€™ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿çš„è¿›è¡ŒåŠ è½½ã€‚</p>

<p>æˆ‘ä»¬å†æ¥æŸ¥çœ‹ä¸€ä¸‹ hooked connect å‡½æ•°çš„<a href="https://web.archive.org/web/20210514123224/https://github.com/rofl0r/proxychains-ng/blob/1c8f8e4e7e31e64131f5f5e031f216b557f7b5ed/src/libproxychains.c#L459">å…·ä½“é€»è¾‘</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	if(!((fam  The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog) AF\_INET || fam The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog) AF\_INET6) &amp;&amp; socktype The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog) SOCK\_STREAM))
		return true\_connect(sock, addr, len);
</code></pre></div></div>

<p>é€šè¿‡è¿™ä¸ªåˆ¤æ–­å¯ä»¥çœ‹åˆ°ï¼Œå½“è¯¥é“¾æ¥ä¸æ»¡è¶³ TCP é“¾æ¥çš„æ¡ä»¶çš„æ—¶å€™ï¼Œæ˜¯ä¼šå»è°ƒç”¨ libc çš„ connect å‡½æ•°ç»§ç»­ä¸‹å»</p>

<p><a href="https://web.archive.org/web/20210514123224/https://github.com/rofl0r/proxychains-ng/blob/1c8f8e4e7e31e64131f5f5e031f216b557f7b5ed/src/libproxychains.c#L499">è¿™é‡Œ</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	ret = connect\_proxy\_chain(sock,
				  dest\_ip,
				  htons(port),
				  proxychains\_pd, proxychains\_proxy\_count, proxychains\_ct, proxychains\_max\_chain);
</code></pre></div></div>

<p>å°±æ˜¯ proxychains å°†é“¾æ¥è½¬åˆ°äº†è‡ªå·±çš„ SOCKS é“¾æ¥é€»è¾‘é‡Œçš„è°ƒç”¨ã€‚è¿™ä¹‹åçš„ä¸€åˆ‡å°±éš proxychains æ“ä½œäº†ã€‚</p>

<p>çœ‹åˆ°è¿™é‡Œç›¸ä¿¡å¤§å®¶å¯¹ proxychains å¦‚ä½•åšåˆ°è®©å…¶ä»–ç¨‹åºèƒ½å¤Ÿä»£ç†é“¾æ¥æœ‰ä¸€å®šè®¤è¯†äº†ã€‚é‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªå°é—®é¢˜æ²¡æœ‰è§£ç­”ï¼Œåœ¨ ArchLinux å’Œå…¶ä»–ä¸€äº›å‘è¡Œç‰ˆä¸Šä½¿ç”¨ proxychains çš„æ—¶å€™æˆ‘ä»¬ä¹Ÿæ²¡æœ‰æ‰‹åŠ¨è®¾ç½® LD_PRELOAD è¿™ä¸ªç¯å¢ƒå˜é‡ï¼Œä»–æ˜¯å¦‚ä½•è¢«è®¾ç½®çš„å‘¢? è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å»çœ‹Â <a href="https://web.archive.org/web/20210514123224/https://github.com/rofl0r/proxychains-ng/blob/1c8f8e4e7e31e64131f5f5e031f216b557f7b5ed/src/main.c#L139">https://github.com/rofl0r/proxychains-ng/blob/1c8f8e4e7e31e64131f5f5e031f216b557f7b5ed/src/main.c#L139</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define LD\_PRELOAD\_ENV "LD\_PRELOAD"
/* all historic implementations of BSD and linux dynlinkers seem to support
   space as LD\_PRELOAD separator, with colon added only recently.
   we use the old syntax for maximum compat */
#define LD\_PRELOAD\_SEP " "
#endif
	char *old\_val = getenv(LD\_PRELOAD\_ENV);
	snprintf(buf, sizeof(buf), LD\_PRELOAD\_ENV "=%s/%s%s%s",
	         prefix, dll\_name,
	         /* append previous LD\_PRELOAD content, if existent */
	         old\_val ? LD\_PRELOAD\_SEP : "",
	         old\_val ? old\_val : "");
	putenv(buf);
	execvp(argv[start\_argv], &amp;argv[start\_argv]);
	perror("proxychains can't load process....");
</code></pre></div></div>

<p>è¿™é‡Œé€šè¿‡ putenv è®¾ç½®äº† LD_PRELOAD çš„ç¯å¢ƒå˜é‡ï¼Œç„¶åæ‰§è¡Œäº† execvp è°ƒç”¨å‘½ä»¤è¡Œåé¢æŒ‡å®šçš„ç¨‹åºã€‚</p>

<p>é€šè¿‡ä¸Šè¿° code reading æˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®º: <strong>proxychains æ˜¯é€šè¿‡ LD_PRELOAD è®©è‡ªå·±åœ¨å…¶ä»–æ‰€æœ‰ shared library ä¹‹å‰è¢«è§£æ, å¹¶å¯¼å‡º libc çš„ç½‘ç»œåŠŸèƒ½å‡½æ•° connect, close, sendto, â€¦ ç­‰å‡½æ•°, é€šè¿‡æ­¤æ–¹æ³• hook libc API , æ¥è¾¾åˆ°è®©å…¶ä»–çš„ç¨‹åºèƒ½å¤Ÿé€šè¿‡å…¶è¿›è¡Œ SOCKS5 proxy è®¿é—®çš„æ•ˆæœ</strong></p>

<p>é‚£ä¹ˆæˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹å§~ æˆ‘ä»¬æ¥ hook ä¸€ä¸‹ open å‡½æ•°çœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆäº‹æƒ…</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*
 * Try to hook open function and disguise the system
 *
 */

#include &lt;stdio.h&gt;
#include &lt;errno.h&gt;
#include &lt;sys/socket.h&gt;

int open(const char *path, int oflag, ...) {
    printf("Hooked open!\n");
    return 1;
}

</code></pre></div></div>

<p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‚æ•°è¿›è¡Œç¼–è¯‘</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -fPIE -c open.c &amp;&amp; gcc -shared -o libopen.so open.o

</code></pre></div></div>

<p>æˆ‘ä»¬è®© open æ’å®šè¿”å› fdÂ = 0 å³ä¸ºè¿›ç¨‹é»˜è®¤æ‰“å¼€çš„æ ‡å‡†è¾“å…¥ (/dev/pts) æˆ‘ä»¬æ‰§è¡ŒÂ LD_PRELOAD=./libopen.so cat /usr/bin/vimÂ ç¨‹åºå…ˆæ˜¯è¾“å‡ºäº†ä¸€è¡Œ â€œHooked openâ€ ç„¶åå°± block åœ¨äº†é‚£é‡Œï¼Œå¥½åƒåœ¨ç­‰å¾…è¯»å…¥è¾“å…¥ä¸€æ ·ï¼Œè€Œè¿™ä¸ªæ“ä½œçš„åŸå§‹è¡Œä¸ºåº”è¯¥æ˜¯ cat å‡ºæ¥ /usr/bin/vim è¿™ä¸ª binary file ç„¶åå¯¼è‡´ terminal ä¹±ç (é€ƒ å› è€Œæˆ‘ä»¬ç°åœ¨å¯ä»¥è¯´ï¼Œæˆ‘ä»¬æˆåŠŸçš„ hook äº† libc çš„å‡½æ•° \w/ æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥è¯•è¯•æŠŠä¸Šè¿°ä»£ç çš„è¿”å›å€¼ä¿®æ”¹ä¸ºå¤§äº2çš„å€¼ï¼Œç„¶åçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>

<p>Why Some Programs (e.g. Golang) Cannot Use It?
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>é€šè¿‡ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“äº†ï¼Œå¾ˆå¤šçš„ golang ç¨‹åºéƒ½æ˜¯é™æ€é“¾æ¥çš„ç¨‹åºï¼Œå½“ç„¶ä¸æ¶‰åŠåˆ°ä»»ä½• shared library preload, å¯¹äºè¿™äº›ç¨‹åºæ¥è¯´æˆ‘ä»¬æ²¡æœ‰åŠæ³•è®©ä»–ä»¬ä½¿ç”¨ proxychains.</p>

<p>ä½†æ˜¯æœ€åˆçš„è¿™ä¸ªå¥‡æ€ªçš„æŠ¥é”™æ˜¯ä»€ä¹ˆ?</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dial tcp 224.0.0.1:80: connect: network is unreachable
</code></pre></div></div>

<p>æˆ‘ä»¬ grep 224 å‘ç°è¿™ä¸ªçš„ç¡®å‡ºç°åœ¨äº† proxychains-ng çš„ä»£ç ä¸­ï¼Œè€Œä¸”è¿˜æ˜¯ä¸€ä¸ª DNS ç›¸å…³çš„å˜é‡, æˆ‘ä»¬å¯ä»¥çŒœæµ‹ å¯¹äºæ¶‰åŠç½‘ç»œè¯·æ±‚çš„golangç¨‹åºï¼Œå¯èƒ½æœ‰ä¸€éƒ¨åˆ†å‡½æ•°è¢« proxychains hook äº†(Thanks to <a href="https://web.archive.org/web/20210514123224/https://ekyu.moe/">@Equim</a>)ã€‚ä¸ºäº†éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³ï¼Œæˆ‘ä»¬ç»™ proxychains çš„æ¯ä¸€ä¸ª Hook çš„å‡½æ•°åŠ ä¸Šè°ƒè¯•è¾“å‡ºï¼Œä¸‹é¢æ”¾å‡ºä¸€ä¸ª demo ç¨‹åºï¼Œåˆ†åˆ«ä½¿ç”¨ golang çš„ http.Get å’Œ net.Dial ä¸¤ä¸ªæ–¹å¼å‘ myip.ipip.net è¯·æ±‚è‡ªå·±çš„ IP åœ°å€</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>package main

import (
	"bufio"
	"fmt"
	"io/ioutil"
	"net"
	"net/http"
)

func \_dial() {
	conn, err := net.Dial("tcp", "myip.ipip.net:80")
	if err != nil {
		fmt.Printf("dial error: %s\n", err)
		return
	}

	reqstr := "GET / HTTP/1.1\r\nHost: myip.ipip.net\r\nUser-Agent: curl/7.61.0\r\nAccept: */*\r\n\r\n"
	\_, err = fmt.Fprintf(conn, reqstr)
	if err != nil {
		fmt.Printf("read error: %s\n", err)
		return
	}
	b := make([]byte, 100000)
	\_, err = bufio.NewReader(conn).Read(b)
	if err != nil {
		fmt.Printf("read error: %s\n", err)
		return
	}

	fmt.Printf("%s\n", b)
}

func \_http() {
	resp, err := http.Get("http://myip.ipip.net")
	if err != nil {
		fmt.Printf("http.get: %s", err)
		return
	}
	defer resp.Body.Close()
	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		fmt.Printf("readall: %s", err)
		return
	}
	fmt.Printf("%s", body)
}

func main() {
	println("DIAL")
	\_dial()
	println("HTTP")
	\_http()
}

</code></pre></div></div>

<p>æˆ‘ä»¬ä½¿ç”¨ go build ä¸Šé¢çš„ä»£ç  -&gt; demo ç„¶å é€šè¿‡å¢åŠ äº†è°ƒè¯•ä¿¡æ¯çš„ Proxychains æ‰§è¡Œ demo å¾—åˆ°å¦‚ä¸‹è¾“å‡º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â•°â”€(Â´ãƒ»Ï‰ãƒ»)ã¤  ./proxychains4 -q ~/playground/go/go\_connect/go\_connect\_gc
DIAL
DBG: getaddrinfo
...
DBG: freeaddrinfo
dial error: dial tcp 224.0.0.1:80: connect: network is unreachable
HTTP
DBG: getaddrinfo
...
DBG: freeaddrinfo
http.get: Get http://myip.ipip.net: dial tcp 224.0.0.1:80: connect: network is unreachable%
</code></pre></div></div>

<p>æˆ‘ä»¬å‘ç°ï¼Œè¿™ä¸ª demo ç¨‹åºçš„ getaddrinfo å’Œ freeaddrinfo è¢« hook åˆ°äº† proxychains å…¶ä»–å‡½æ•°æ²¡æœ‰ã€‚å› è€Œæˆ‘ä»¬çš„çŒœæƒ³å¾—åˆ°äº†éªŒè¯ï¼Œå…·ä½“å¯ä»¥å»å‚è€ƒ golang source code (è¿™é‡Œæš‚æ—¶ä¸è¿›è¡Œè®¨è®º)</p>

<p>A Way For Golang Programs to Use Proxychains
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ <a href="https://web.archive.org/web/20210514123224/https://golang.org/doc/install/gccgo">gccgo</a></p>

<p>æˆ‘ä»¬å…ˆæ¥çœ‹æ•ˆæœ</p>

<p>ä¸ä½¿ç”¨ proxychains ç›´æ¥è¿è¡Œ ç¼–è¯‘å¾—åˆ°çš„ demo</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DIAL
HTTP/1.1 200 OK
Date: Tue, 14 Aug 2018 13:09:06 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 67
Connection: keep-alive
X-Via-JSL: dca9b80,-
Set-Cookie: \_\_jsluid=xxxxxxxxxxxxxxxxxxxxxxxxxxx; max-age=31536000; path=/; HttpOnly
X-Cache: bypass

å½“å‰ IPï¼š*.*.*.*  æ¥è‡ªäºï¼šä¸­å›½ XXXXXXXXXXXXXXXXXXX

HTTP
å½“å‰ IPï¼š*.*.*.*  æ¥è‡ªäºï¼šä¸­å›½ XXXXXXXXXXXXXXXXXXX

</code></pre></div></div>

<p>ä½¿ç”¨ proxychains ä»£ç†å</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DIAL
HTTP/1.1 200 OK
Date: Tue, 14 Aug 2018 13:10:09 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 73
Connection: keep-alive
Set-Cookie: \_\_cfduid=xxxxxxxxxxxxxxxxxxxxxxx; expires=Wed, 14-Aug-19 13:10:09 GMT; path=/; domain=.ipip.net; HttpOnly
Server: cloudflare
CF-RAY: 4xxxxxxxxxxxxxxx-NRT

å½“å‰ IPï¼š*.*.*.*  æ¥è‡ªäºï¼šæ—¥æœ¬  XXXXXXXXXXXXXXXXXX

HTTP 
å½“å‰ IPï¼š*.*.*.*  æ¥è‡ªäºï¼šæ—¥æœ¬ XXXXXXXXXXXXXXXXXX
</code></pre></div></div>

<p>å¯ä»¥çœ‹å‡ºï¼Œè¿™æ¬¡ proxychains ç”Ÿæ•ˆäº†! Hooray</p>

<p>é‚£ä¹ˆä¸ºä»€ä¹ˆç”Ÿæ•ˆäº†å‘¢?</p>

<p>æˆ‘ä»¬å¯¹æ¯”ä¸¤ä¸ªä¸åŒ compiler ç¼–è¯‘å‡ºæ¥çš„ go binary çš„ shared library å¯ä»¥å‘ç°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â•°â”€(Â´ãƒ»Ï‰ãƒ»)ã¤  ldd go\_connect\_shared go\_connect\_gc 
go\_connect\_shared:
        linux-vdso.so.1 (0x00007ffdcdf00000)
        libgo.so.13 =&gt; /usr/lib/libgo.so.13 (0x00007f368872e000)
        libm.so.6 =&gt; /usr/lib/libm.so.6 (0x00007f36885a9000)
        libgcc\_s.so.1 =&gt; /usr/lib/libgcc\_s.so.1 (0x00007f368858f000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007f36883cb000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007f3689fe6000)
        libz.so.1 =&gt; /usr/lib/libz.so.1 (0x00007f36881b4000)
        libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007f3688193000)
go\_connect\_gc:
        linux-vdso.so.1 (0x00007ffe4bf5f000)
        libpthread.so.0 =&gt; /usr/lib/libpthread.so.0 (0x00007fb99f7d6000)
        libc.so.6 =&gt; /usr/lib/libc.so.6 (0x00007fb99f612000)
        /lib64/ld-linux-x86-64.so.2 =&gt; /usr/lib64/ld-linux-x86-64.so.2 (0x00007fb99f858000)

</code></pre></div></div>

<p>ä»–ä»¬ä¸¤ä¸ªéƒ½ link äº† libc(å†…å«æœ‰ connect å‡½æ•°) ä¸ºä»€ä¹ˆä¸€ä¸ªä¼šæ¥å— proxy ä¸€ä¸ªä¸èƒ½å‘¢? çŒœæµ‹å¯ä»¥æ˜¯, connect å‡½æ•°åœ¨ gc compiler ç‰ˆçš„ go ä¸­è°ƒç”¨çš„ä¸æ˜¯ libc çš„ connect, è€Œåœ¨ gccgo é‡Œåˆ™æ˜¯è°ƒç”¨äº†è¿™ä¸ª æˆ‘ä»¬éœ€è¦é€šè¿‡é˜…è¯»æºç æ¥å¼„æ¸…æ¥š connect å‡½æ•°æ˜¯æ¥è‡ªå“ªé‡Œçš„ã€‚</p>

<h2 id="gcgo-compilerä¸‹çš„è°ƒç”¨">GC(Go Compiler)ä¸‹çš„è°ƒç”¨</h2>

<p>æˆ‘ä»¬å…ˆæ¥çœ‹ connect åœ¨ gc (æˆ‘ä»¬ç†ŸçŸ¥çš„é»˜è®¤ go compiler) ä¸‹ connect çš„è°ƒç”¨é“¾è·¯:</p>

<p>åœ¨ &lt;go_src&gt;/src/syscall ä¸‹æœ‰ä¸€ç³»åˆ—çš„ syscall æ–‡ä»¶, å¯¹äº Linux 64 bit æˆ‘ä»¬ä»…éœ€è¦çœ‹Â src/syscall/syscall_linux_amd64.go è¿™ä¸ªæ–‡ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬å‘ç°äº†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//sys	Statfs(path string, buf *Statfs\_t) (err error)
//sys	SyncFileRange(fd int, off int64, n int64, flags int) (err error)
//sys	Truncate(path string, length int64) (err error)
//sys	accept(s int, rsa *RawSockaddrAny, addrlen *\_Socklen) (fd int, err error)
//sys	accept4(s int, rsa *RawSockaddrAny, addrlen *\_Socklen, flags int) (fd int, err error)
//sys	bind(s int, addr unsafe.Pointer, addrlen \_Socklen) (err error)
//sys	connect(s int, addr unsafe.Pointer, addrlen \_Socklen) (err error)
//sys	fstatat(fd int, path string, stat *Stat\_t, flags int) (err error) = SYS\_NEWFSTATAT
//sysnb	getgroups(n int, list *\_Gid\_t) (nn int, err error)
//sysnb	setgroups(n int, list *\_Gid\_t) (err error)
//sys	getsockopt(s int, level int, name int, val unsafe.Pointer, vallen *\_Socklen) (err error)
//sys	setsockopt(s int, level int, name int, val unsafe.Pointer, vallen uintptr) (err error)
//sysnb	socket(domain int, typ int, proto int) (fd int, err error)
//sysnb	socketpair(domain int, typ int, proto int, fd *[2]int32) (err error)
//sysnb	getpeername(fd int, rsa *RawSockaddrAny, addrlen *\_Socklen) (err error)
//sysnb	getsockname(fd int, rsa *RawSockaddrAny, addrlen *\_Socklen) (err error)
//sys	recvfrom(fd int, p []byte, flags int, from *RawSockaddrAny, fromlen *\_Socklen) (n int, err error)
</code></pre></div></div>

<p>è¿™æ ·ä¸€æ®µå«æœ‰ connect çš„ç­¾åçš„æ³¨é‡Šï¼Œæ¯ä¸€è¡Œçš„ //sys //sysnb ä¼šè¢« perl è„šæœ¬ src/syscall/mksyscall.pl ç»™å±•å¼€ï¼Œ connect å±•å¼€åæ˜¯è¿™æ ·çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>func connect(s int, addr unsafe.Pointer, addrlen \_Socklen) (err error) {
        \_, \_, e1 := Syscall(SYS\_CONNECT, uintptr(s), uintptr(addr), uintptr(addrlen))
        if e1 != 0 {
                err = errnoErr(e1)
        }
        return
}
</code></pre></div></div>

<p>æŸ¥çœ‹ Syscall çš„å®ç° æˆ‘ä»¬è·Ÿè¸ªåˆ°äº†Â src/syscall/asm_linux_amd64.s å†…çš„ä»£ç </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TEXT Â·Syscall(SB),NOSPLIT,$0-56
	CALL	runtimeÂ·entersyscall(SB)
	MOVQ	a1+8(FP), DI
	MOVQ	a2+16(FP), SI
	MOVQ	a3+24(FP), DX
	MOVQ	$0, R10
	MOVQ	$0, R8
	MOVQ	$0, R9
	MOVQ	trap+0(FP), AX	// syscall entry
	SYSCALL
	CMPQ	AX, $0xfffffffffffff001
	JLS	ok
	MOVQ	$-1, r1+32(FP)
	MOVQ	$0, r2+40(FP)
	NEGQ	AX
	MOVQ	AX, err+48(FP)
	CALL	runtimeÂ·exitsyscall(SB)
	RET
ok:
	MOVQ	AX, r1+32(FP)
	MOVQ	DX, r2+40(FP)
	MOVQ	$0, err+48(FP)
	CALL	runtimeÂ·exitsyscall(SB)
	RET
</code></pre></div></div>

<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯é€šè¿‡ç›´æ¥è°ƒç”¨ syscall è¿›è¡Œäº†ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œéä½¿ç”¨äº† libc æä¾›çš„ connect å‡½æ•°ã€‚å› è€Œæˆ‘ä»¬åœ¨è¿™ç§æƒ…å†µä¸‹æ˜¯æ— æ³•è®© connect è¢« proxychains ç»™ hook çš„</p>

<h2 id="gccgo-ä¸‹çš„è°ƒç”¨">GCCGO ä¸‹çš„è°ƒç”¨</h2>

<p>æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ gccgo å¯¹ connect çš„è°ƒç”¨é“¾è·¯:</p>

<p>åœ¨ gccgo/libgo/go/syscall ä¸‹æˆ‘ä»¬æŸ¥çœ‹æ–‡ä»¶ socket_posix.go å¯ä»¥çœ‹åˆ°</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//sys   bind(fd int, sa *RawSockaddrAny, len Socklen\_t) (err error)
//bind(fd \_C\_int, sa *RawSockaddrAny, len Socklen\_t) \_C\_int

//sys   connect(s int, addr *RawSockaddrAny, addrlen Socklen\_t) (err error)
//connect(s \_C\_int, addr *RawSockaddrAny, addrlen Socklen\_t) \_C\_int

</code></pre></div></div>

<p>åŒæ ·ï¼Œè¿™æ®µä»£ç ä¹Ÿä¼šè¢«ä¸€ä¸ª mksyscall.awk çš„å®å±•å¼€ä¸º:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Automatically generated wrapper for connect/connect
//extern connect
func c\_connect(s \_C\_int, addr *RawSockaddrAny, addrlen Socklen\_t) \_C\_int
func connect(s int, addr *RawSockaddrAny, addrlen Socklen\_t) (err error) {
        Entersyscall()
        \_r := c\_connect(\_C\_int(s), addr, Socklen\_t(addrlen))
        var errno Errno
        setErrno := false
        if \_r &lt; 0 {
                errno = GetErrno()
                setErrno = true
        }
        Exitsyscall()
        if setErrno {
                err = errno
        }
        return
}

</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°, è¿™é‡Œä½¿ç”¨äº† extern directive å°†å‡½æ•° c_connect å¼•ç”¨æŒ‡å‘äº†å¤–éƒ¨çš„ connect ç¬¦å·,Â  é€šè¿‡æŸ¥çœ‹ libgo çš„ä¾èµ–å…³ç³»(ldd) æˆ‘ä»¬å‘ç° libgo ä¾èµ– libc, libc æä¾›äº† connect å› è€Œ gccgo ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºçš„ connect æ˜¯é€šè¿‡ libc è°ƒç”¨ï¼Œè€Œä¸æ˜¯å†…éƒ¨è‡ªè¡Œè§£å†³äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ proxychains æ¥è¿›è¡Œ hookã€‚</p>

<h2 id="éªŒè¯">éªŒè¯</h2>

<p>æœ€åå†æ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬çš„è¿™ä¸ªç»“è®ºã€‚Â  å¯¹äºæŸ¥çœ‹ shared lib çš„ç›¸å…³å†…éƒ¨è¿‡ç¨‹ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªç¥å¥‡çš„ç¯å¢ƒå˜é‡ LD_DEBUG, æˆ‘ä»¬ä½¿ç”¨ LD_DEBUG=bindings æ¥å±•ç¤ºå‡ºæ¯ä¸€ä¸ªç¬¦å·çš„ bind è¿‡ç¨‹ï¼ŒæŸ¥çœ‹ä¸¤ä¸ªä¸åŒçš„ go compiler ç¼–è¯‘å‡ºçš„ç¨‹åºåœ¨ symbol resolution æ—¶æœ‰ä»€ä¹ˆä¸åŒã€‚ï¼ˆéƒ½å·²ç»ä½¿ç”¨ LD_PRELOAD preload äº† libproxychains4.so )</p>

<p><img src="https://web.archive.org/web/20210514123224im_/https://void-shana.moe/wp-content/uploads/2018/08/gcc-1-1024x292.png" alt="" />For GCCGO
<img src="https://web.archive.org/web/20210514123224im_/https://void-shana.moe/wp-content/uploads/2018/08/gc-1-1024x374.png" alt="" />For GC
æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œåœ¨ gccgo ç¼–è¯‘çš„ç‰ˆæœ¬ä¸­ï¼Œ libgo éœ€è¦çš„å¤–éƒ¨ symbol connect è¢« bind åˆ°äº† GLIBC connect è€Œåœ¨ gc ç¼–è¯‘çš„ç‰ˆæœ¬ä¸­åˆ™ä¸å­˜åœ¨è¿™æ ·çš„ binding. å› è€Œæˆ‘ä»¬å¾—å‡ºç»“è®º gccgo ç¼–è¯‘çš„ä»£ç å¯ä»¥è¢« proxychain hook</p>

<p>Reference
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<ul>
  <li>ld-linux man page</li>
  <li>dlsym(3) man page</li>
  <li>http://tldp.org/HOWTO/Program-Library-HOWTO/shared-libraries.html</li>
  <li>https://github.com/rofl0r/proxychains-ng</li>
</ul>

<p>Misc
The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<p>é—ç•™é—®é¢˜: åœ¨æŸ¥çœ‹ LD_DEBUG=bindings çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿™æ ·ä¸€æ®µå¥‡æ€ªçš„ bind:Â binding file /usr/lib/libproxychains4.so [0] to /usr/lib/libpthread.so.0 [0]: normal symbol `connectâ€™ proxychains çš„ connect ç«Ÿç„¶ bind åˆ°äº† libpthread ä¸Šï¼Œè¿™è®©æˆ‘å¾ˆè´¹è§£ï¼Œå°è¯•äº† LD_DEBUG çœ‹ curl çš„ binding ä¹Ÿæ˜¯æœ€ååˆ°äº† libpthread ä¸Šï¼Œè¿™é‡Œå°±è®©æˆ‘äº§ç”Ÿäº†ä¸€ä¸ªæ‚¬è€Œæœªè§£çš„é—®é¢˜: è«é proxychains ä¸ä»…ä»… hook äº† libc è¿˜ hook äº† libpthread? æˆ‘æŸ¥çœ‹äº† LD_DEBUG=1 curl xxx.cn çš„è¾“å‡ºï¼Œå‘ç°æ‰€æœ‰çš„ connect symbol éƒ½æ˜¯è§£æåˆ°äº† libpthread.so ä¸Šï¼Œä¹Ÿè®¸ï¼Œæ‰€æœ‰çš„ connect éƒ½æ²¡æœ‰èµ° libc è€Œæ˜¯èµ°äº† libpthread?z è¿™å°±æ˜¯å¦ä¸€ä¸ªé—®é¢˜äº†ã€‚</p>

<p>åè®°: å› ä¸ºæœ€è¿‘åœ¨å‡†å¤‡å‡ºå›½ç•™å­¦ï¼Œå¤‡è€ƒç”³è¯·äº‹æƒ…å¤šå¾—å¾ˆå¿™ï¼Œå‡ ä¹æ²¡æœ‰å¤šå°‘æ—¶é—´æ¥ç ”ç©¶æŠ€æœ¯ï¼Œå› è€Œåšå®¢æç½®çš„æ—¶é—´è¿œæ¯” 3 ä¸ªæœˆé•¿ï¼Œç”šè‡³æœ‰çš„æœ‹å‹ç•™è¨€è¯´åšä¸»å·²ç»å‡‰äº†ï¼Œåœ¨æ­¤å¯¹å¤§å®¶çš„å…³æ³¨è¡¨ç¤ºæ„Ÿè°¢ï¼Œå› ä¸ºå¾ˆå¤šäº‹æƒ…å¯¼è‡´äº†åšå®¢æ²¡æœ‰æ›´æ–°ã€‚åœ¨å¤‡è€ƒç»“æŸååšå®¢è¿˜ä¼šä¿æŒä»¥å‰çš„è¿›åº¦æŒç»­æ›´æ–°çš„ã€‚åŒæ—¶æ„Ÿè°¢ <a href="https://web.archive.org/web/20210514123224/https://ekyu.moe/">@Equim</a> åœ¨æ’°å†™æœ¬æ–‡æ—¶æä¾›çš„ç§ç§å¸®åŠ©ï¼Œå…³äºå¥¹è¯´çš„å¦ä¸€ä¸ªé—®é¢˜æˆ‘åœ¨è¿™é‡Œæ²¡æœ‰è®²åˆ°ï¼Œä¹Ÿæ˜¯å’Œ proxychains æœ‰å…³çš„ä¸€ä¸ªé—®é¢˜ï¼Œé“¾æ¥åœ¨è¿™é‡Œ:Â <a href="https://web.archive.org/web/20210514123224/https://hackerone.com/reports/361269">https://hackerone.com/reports/361269</a> æ„Ÿå…´è¶£çš„å„ä½å¯ä»¥å»çœ‹çœ‹</p>

<p>ç„¶åæˆ‘å°±è¦ç»§ç»­å»å‡†å¤‡ GRE äº†(x</p>

<hr />

<p><a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/category/linux/c">C</a>, <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/category/linux/kernel-linux">Kernel</a>, <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/category/linux">Linux</a> <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/tag/c">C</a>, <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/tag/kernel">kernel</a>, <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/tag/linux">linux</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<ol>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/13b998737e96dd10135326cacc26985c?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>ZackXu</strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-443">August 14, 2018 at 5:07 pm</a>
å¨œå¨œæ›´æ–°äº†ï¼</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-446">August 15, 2018 at 10:20 am</a>
 ç»ˆäºæ›´æ–°äº†(x</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/1896080d53de450a79795654ceac2dbb?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514123224/https://thunix.org/~neo_chen/">Neo_Chen</a></strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-444">August 14, 2018 at 8:53 pm</a>
çµ‚æ–¼æ›´æ–°äº†ï¼Œè€¶ï¼</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-447">August 15, 2018 at 10:21 am</a>
 æœ€è¿‘å¥½å¿™QvQ</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/e466883dea9a8b501f9788066cd021de?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514123224/https://ikk.me/">kookxiang</a></strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-445">August 15, 2018 at 9:59 am</a>
å¤å¨œå¤§ä½¬ï¼è·ªäº†</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-448">August 15, 2018 at 10:22 am</a>
 kk æ‰æ˜¯å¤§ä½¬! æˆ‘æ˜¯èŒæ–°!</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-450">August 15, 2018 at 10:50 pm</a>
ç°åœ¨ä¸æ˜¯è‰ç¨¿äº†å‘€ï¼Œæ˜¯å› ä¸ºå½“æ—¶æ‰‹æ®‹ç‚¹é”™äº†(</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/64718fe14af5b212ad2428ce59affcb2?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514123224/https://huihui.moe/">ç°ç°</a></strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-461">August 20, 2018 at 12:53 pm</a>
å¥½è€¶ï¼åšä¸»çƒ­äº†ï¼</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-462">August 20, 2018 at 12:57 pm</a>
 å¥½è€¶æ˜¯ç°ç°! æ‰‘(</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/43fdc497850cead58be4e6219c7d96e8?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514123224/https://a-wing.top/">a-wing</a></strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-489">September 27, 2018 at 9:11 am</a>
å¤å¨œå§å§å¥½æ£’ï½</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-490">September 27, 2018 at 9:20 am</a>
 å¥½è€¶ï¼Œæ˜¯å¤å¨œå¦¹å¦¹/</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/3e3c1cb94b9ad3551cd9d43f2e52e105?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514123224/https://blog.lilydjwg.me/">ä¾äº‘</a></strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-517">January 31, 2019 at 10:37 pm</a>
libpthread.so ç¡®å®åŒ…æ‹¬äº†ä¸€ä»½ connectï¼Œä»¥åŠå…¶ä»–äºŒä¸‰åä¸ªå¸¸è§å‡½æ•°ã€‚åœ¨ glibc çš„ glibc/nptl/Makefile æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å‡½æ•°æ˜¯ä¸ºäº†å…¼å®¹æ€§æ‰å­˜åœ¨äº libpthread.so é‡Œçš„ã€‚</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123224im_/https://secure.gravatar.com/avatar/3e3c1cb94b9ad3551cd9d43f2e52e105?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong><a href="https://web.archive.org/web/20210514123224/https://blog.lilydjwg.me/">ä¾äº‘</a></strong> says: 
<a href="https://web.archive.org/web/20210514123224/https://void-shana.moe/linux/proxychains-ng.html#comment-517">January 31, 2019 at 10:37 pm</a>
libpthread.so ç¡®å®åŒ…æ‹¬äº†ä¸€ä»½ connectï¼Œä»¥åŠå…¶ä»–äºŒä¸‰åä¸ªå¸¸è§å‡½æ•°ã€‚åœ¨ glibc çš„ glibc/nptl/Makefile æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°ï¼Œè¿™äº›å‡½æ•°æ˜¯ä¸ºäº†å…¼å®¹æ€§æ‰å­˜åœ¨äº libpthread.so é‡Œçš„ã€‚</p>
  </li>
</ol>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry><entry><title type="html">Kernel Bootup Page Table Initialize Process(x86\_64)</title><link href="https://void-shana.moe//posts/kernel-bootup-page-table-initialize-processx86_64" rel="alternate" type="text/html" title="Kernel Bootup Page Table Initialize Process(x86\_64)" /><published>2017-11-23T00:00:00+08:00</published><updated>2017-11-23T00:00:00+08:00</updated><id>https://void-shana.moe//posts/kernel-bootup-page-table-initialize-processx86_64</id><content type="html" xml:base="https://void-shana.moe//posts/kernel-bootup-page-table-initialize-processx86_64"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="november-23-2017"><a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html" title="2:21 am">November 23, 2017</a></h5>
<p><a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html#comments">3 comments</a></p>

<p>This article will provide detailed information about the kernel bootup page table setup.</p>

<p>In a briefÂ view, the kernel setup page table in three steps:</p>

<ol>
  <li>Setup the 4GB identity mapping</li>
  <li>Setup 64bit mode page table early_top_pgt</li>
  <li>Setup 64bit mode page table init_top_pgt</li>
</ol>

<p>The last two steps are both higher mapping: Map the 512MB physical address to virtual address 0xffff80000000 â€“ 0xffff80000000 + 512MB.</p>

<p>Next, we will talk about the details. We will use the 4.14 version code to explain the process.</p>

<p><em>You need to know the IA32e paging mechanism and relocation to read the article. The Intel manual has a good explaination of IA32e paging</em></p>

<p><a href="https://web.archive.org/web/20210514134902/https://github.com/torvalds/linux/blob/v4.14/arch/x86/boot/compressed/head_64.S">https://github.com/torvalds/linux/blob/v4.14/arch/x86/boot/compressed/head_64.S</a></p>

<h2 id="before-decompression">Before decompression</h2>

<p>When the kernel is being loaded, it is either decompressed by a third-party bootloader like GRUB2 or by theÂ kernel itself. Now we will talk about the second condition. The code started from arch/x86/boot/header.SÂ .Â It is in 16bit real mode at the time.Â Then in codeÂ arch/x86/boot/compressed/head_64.SÂ  We setup the first page table in 32bit mode. We need this page table to take us to do take us to 64bit mode.</p>

<p>The following code is the set-up process</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * Prepare for entering 64 bit mode
 */

	/* Load new GDT with the 64bit segments using 32bit descriptor */
	addl	%ebp, gdt+2(%ebp)
	lgdt	gdt(%ebp)

	/* Enable PAE mode */
	movl	%cr4, %eax
	orl	$X86\_CR4\_PAE, %eax
	movl	%eax, %cr4

 /*
  * Build early 4G boot pagetable
  */
	/*
	 * If SEV is active then set the encryption mask in the page tables.
	 * This will insure that when the kernel is copied and decompressed
	 * it will be done so encrypted.
	 */
	call	get\_sev\_encryption\_bit
	xorl	%edx, %edx
	testl	%eax, %eax
	jz	1f
	subl	$32, %eax	/* Encryption bit is always above bit 31 */
	bts	%eax, %edx	/* Set encryption mask for page tables */
1:

	/* Initialize Page tables to 0 */
	leal	pgtable(%ebx), %edi
	xorl	%eax, %eax
	movl	$(BOOT\_INIT\_PGT\_SIZE/4), %ecx
	rep	stosl

	/* Build Level 4 */
	leal	pgtable + 0(%ebx), %edi
	leal	0x1007 (%edi), %eax
	movl	%eax, 0(%edi)
	addl	%edx, 4(%edi)

	/* Build Level 3 */
	leal	pgtable + 0x1000(%ebx), %edi
	leal	0x1007(%edi), %eax
	movl	$4, %ecx
1:	movl	%eax, 0x00(%edi)
	addl	%edx, 0x04(%edi)
	addl	$0x00001000, %eax
	addl	$8, %edi
	decl	%ecx
	jnz	1b

	/* Build Level 2 */
	leal	pgtable + 0x2000(%ebx), %edi
	movl	$0x00000183, %eax
	movl	$2048, %ecx
1:	movl	%eax, 0(%edi)
	addl	%edx, 4(%edi)
	addl	$0x00200000, %eax
	addl	$8, %edi
	decl	%ecx
	jnz	1b

	/* Enable the boot page tables */
	leal	pgtable(%ebx), %eax
	movl	%eax, %cr3
</code></pre></div></div>

<p>Notice that from the comment above. %ebx contain the address where we move kernel to make a safe decompression. Which means we should treat %ebx as an offset to the compiled binary. The compiled binary start at 0. So we fix-up the difference to reach the real physical address.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	/* Build Level 4 */
	leal	pgtable + 0(%ebx), %edi
	leal	0x1007 (%edi), %eax
	movl	%eax, 0(%edi)
	addl	%edx, 4(%edi)
</code></pre></div></div>

<p>The above code setup Top level page directory. This only set the lowest page directory entry to (1007 + pgtable). This is a pointer to the next level page table. And next level page table start at 0x1000 + pgtable. The last line adds %edx to 4+%edi will set encryption masks if SEV is active. Currently, we can omit this line.</p>

<p>Then we look at the next level.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	/* Build Level 3 */
	leal	pgtable + 0x1000(%ebx), %edi
	leal	0x1007(%edi), %eax
	movl	$4, %ecx
1:	movl	%eax, 0x00(%edi)
	addl	%edx, 0x04(%edi)
	addl	$0x00001000, %eax
	addl	$8, %edi
	decl	%ecx
	jnz	1b
</code></pre></div></div>

<p>Here, we can see we set up four entries. and each entry point to another page directory.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	/* Build Level 2 */
	leal	pgtable + 0x2000(%ebx), %edi
	movl	$0x00000183, %eax
	movl	$2048, %ecx
1:	movl	%eax, 0(%edi)
	addl	%edx, 4(%edi)
	addl	$0x00200000, %eax
	addl	$8, %edi
	decl	%ecx
	jnz	1b
</code></pre></div></div>

<p>This is the last level of page directory, these entry will point to a physical page frame directly. Now letâ€™s take a look at the code. It sets up 2048 entries. Each entry with a Page Flag R/W = 1 U/S = 0 PS = 1. This means the page is read / write by kernel only and its size is 2MB. Each PTE(Page Table Entry) is a 8 Byte block data. So one page can contain at most 512 entries. Here kernel setup 4 pages of Level 2 Page Directory. The following image show the current page table structure.</p>

<p>In total we have 2048 * 2MB = 4GB physical address, identity mapped to 0 â€“ 4GB linear address.</p>

<p><img src="https://web.archive.org/web/20210514134902im_/https://void-shana.moe/wp-content/uploads/2017/11/aaa-e1511368338472-1024x768.jpg" alt="" /></p>

<p>Â </p>

<p>Then we use a longÂ return to switch to 64bit mode.</p>

<p><img src="https://web.archive.org/web/20210514134902im_/https://void-shana.moe/wp-content/uploads/2017/11/Screenshot_20171123_003421-1024x503.png" alt="" /></p>

<p>Kernel push the startup_64 and CS register to stack, then perform a long return to enter 64bit mode.Â  And then after copy the compressed kernel, we jump to symbol relocated</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * Jump to the relocated address.
 */
	leaq	relocated(%rbx), %rax
	jmp	*%rax
</code></pre></div></div>

<p>In the relocated code, we do the kernel decompression.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/*
 * Do the extraction, and jump to the new kernel..
 */
	pushq	%rsi			/* Save the real mode argument */
	movq	%rsi, %rdi		/* real mode address */
	leaq	boot\_heap(%rip), %rsi	/* malloc area for uncompression */
	leaq	input\_data(%rip), %rdx  /* input\_data */
	movl	$z\_input\_len, %ecx	/* input\_len */
	movq	%rbp, %r8		/* output target address */
	movq	$z\_output\_len, %r9	/* decompressed length, end of relocs */
	call	extract\_kernel		/* returns kernel location in %rax */
	popq	%rsi
</code></pre></div></div>

<p>The decompressed kernel is compiled at high address(we takeÂ ffffffff81000000 for example). But now we donâ€™t have the correct page table to do the mapping. Fortunately, the <strong>extract_kernel</strong> function returns the physical address of the decompressed kernel. (Which is %ebp, equals to %ebx). After decompression, %rax contains the kernel physical start address. We jump there to perform the further setup.</p>

<h2 id="start-execution-in-vmlinux">Start execution in vmlinux</h2>

<p>We now arrived at arch/x86/kernel/head_64.S. Before we continue, we must notice two things first.</p>

<ul>
  <li>After decompression, the kernel is placed at physical address %rbp (If we do not set CONFIG_RELOCATABLE itâ€™s equal to 0x1000000</li>
</ul>

<p>).</p>
<ul>
  <li>After decompression, we now in the kernel code compiled with the virtual addressÂ ffffffff81000000(as we mentioned above).</li>
</ul>

<p>So here is a big pitfall. We cannot access ANY of the symbols in vmlinux currently. Because we only have a basic identity mapping now. But we need to visit the variables. How can we make it? The kernel uses a trick here, I will show it below</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static void \_\_head *fixup\_pointer(void *ptr, unsigned long physaddr)
{
	return ptr - (void *)\_text + (void *)physaddr;
}

</code></pre></div></div>

<p>This function fixup the symbol virtual address to the real physical address.</p>

<p><strong>â€œCurrent Valid Addrâ€ = â€œVirtual Hi Addrâ€ â€“ â€œKernel Virtual Address Base Addrâ€ + â€œ%rax Extracted kernel physical addressâ€.</strong></p>

<p>Now we continue reading the arch/x86/kernel/head_64.SÂ  assembly code, this is where we landed from arch/x86/compressed/head_64.S</p>

<p>The enrty is startup_64:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>startup\_64:
	/*
	 * At this point the CPU runs in 64bit mode CS.L = 1 CS.D = 0,
	 * and someone has loaded an identity mapped page table
	 * for us.  These identity mapped page tables map all of the
	 * kernel pages and possibly all of memory.
	 *
	 * %rsi holds a physical pointer to real\_mode\_data.
	 *
	 * We come here either directly from a 64bit bootloader, or from
	 * arch/x86/boot/compressed/head\_64.S.
	 *
	 * We only come here initially at boot nothing else comes here.
	 *
	 * Since we may be loaded at an address different from what we were
	 * compiled to run at we first fixup the physical addresses in our page
	 * tables and then reload them.
	 */

	/* Set up the stack for verify\_cpu(), similar to initial\_stack below */
	leaq	(\_\_end\_init\_task - SIZEOF\_PTREGS)(%rip), %rsp

	/* Sanitize CPU configuration */
	call verify\_cpu

	/*
	 * Perform pagetable fixups. Additionally, if SME is active, encrypt
	 * the kernel and retrieve the modifier (SME encryption mask if SME
	 * is active) to be added to the initial pgdir entry that will be
	 * programmed into CR3.
	 */
	leaq	\_text(%rip), %rdi
	pushq	%rsi
	call	\_\_startup\_64
	popq	%rsi

	/* Form the CR3 value being sure to include the CR3 modifier */
	addq	$(early\_top\_pgt - \_\_START\_KERNEL\_map), %rax
	jmp 1f
</code></pre></div></div>

<p>In this article, we talk about self loading, instead of using a third party 64bit bootloader like GRUB. So as the comment said, we come here fromÂ arch/x86/boot/compressed/head_64.S. If we config the kernel with CONFIG_RELOCATABLE, the kernel wonâ€™t run at the place we compiled, page table fixup need to be performed. The page table is fixed in <strong>__startup_64</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>unsigned long \_\_head \_\_startup\_64(unsigned long physaddr,
				  struct boot\_params *bp)
{
	unsigned long load\_delta, *p;
	unsigned long pgtable\_flags;
	pgdval\_t *pgd;
	p4dval\_t *p4d;
	pudval\_t *pud;
	pmdval\_t *pmd, pmd\_entry;
	int i;
	unsigned int *next\_pgt\_ptr;

	/* Is the address too large? */
	if (physaddr &gt;&gt; MAX\_PHYSMEM\_BITS)
		for (;;);

	/*
	 * Compute the delta between the address I am compiled to run at
	 * and the address I am actually running at.
	 */
	load\_delta = physaddr - (unsigned long)(\_text - \_\_START\_KERNEL\_map);

	/* Is the address not 2M aligned? */
	if (load\_delta &amp; ~PMD\_PAGE\_MASK)
		for (;;);

	/* Activate Secure Memory Encryption (SME) if supported and enabled */
	sme\_enable(bp);

	/* Include the SME encryption mask in the fixup value */
	load\_delta += sme\_get\_me\_mask();

	/* Fixup the physical addresses in the page table */

	pgd = fixup\_pointer(&amp;early\_top\_pgt, physaddr);
	pgd[pgd\_index(\_\_START\_KERNEL\_map)] += load\_delta;

	if (IS\_ENABLED(CONFIG\_X86\_5LEVEL)) {
		p4d = fixup\_pointer(&amp;level4\_kernel\_pgt, physaddr);
		p4d[511] += load\_delta;
	}

        /* Omit some fixup code for simplicity */

	return sme\_get\_me\_mask();
}

</code></pre></div></div>

<p>We compute the load_delta, and fixup the early_top_pgt. Now we just assume we donâ€™t configure the kernel with CONFIG_RELOCATABLE. Then we can look at the page table built at compile time. First we look at the top level <strong>early_top_pgt.</strong>It set only the last entry point to level3 page table. which means only virtual address start with 0xff8000000000 will be valid.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NEXT\_PAGE(early\_top\_pgt)
	.fill	511,8,0
#ifdef CONFIG\_X86\_5LEVEL
	.quad	level4\_kernel\_pgt - \_\_START\_KERNEL\_map + \_PAGE\_TABLE\_NOENC
#else
	.quad	level3\_kernel\_pgt - \_\_START\_KERNEL\_map + \_PAGE\_TABLE\_NOENC
#endif
</code></pre></div></div>

<p>Now we look at the next level (We do not use 5 Level Paging).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NEXT\_PAGE(level3\_kernel\_pgt)
	.fill	L3\_START\_KERNEL,8,0
	/* (2^48-(2*1024*1024*1024)-((2^39)*511))/(2^30) = 510 */
	.quad	level2\_kernel\_pgt - \_\_START\_KERNEL\_map + \_KERNPG\_TABLE\_NOENC
	.quad	level2\_fixmap\_pgt - \_\_START\_KERNEL\_map + \_PAGE\_TABLE\_NOENC
</code></pre></div></div>

<p>This level we have two entries, one for kernel address space. One for fixmap address space, fixmap address space is used for IO mapping, DMA, etc. Now we just look at the fixmap address space. Itâ€™s at index 510. in binary mode 0b111111110. Combine with the top level we get a smaller linear address space. Only address start from 0xffff80000000 is valid.</p>

<p>Then itâ€™s the last level page directory. <strong>level2_kernel_pgt</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NEXT\_PAGE(level2\_kernel\_pgt)
	/*
	 * 512 MB kernel mapping. We spend a full page on this pagetable
	 * anyway.
	 *
	 * The kernel code+data+bss must not be bigger than that.
	 *
	 * (NOTE: at +512MB starts the module area, see MODULES\_VADDR.
	 *  If you want to increase this then increase MODULES\_VADDR
	 *  too.)
	 */
	PMDS(0, \_\_PAGE\_KERNEL\_LARGE\_EXEC,
		KERNEL\_IMAGE\_SIZE/PMD\_SIZE)
</code></pre></div></div>

<p>This level is a mapping to physical address 0 â€“ 512MB (it maps more than that, but we only need 512MB) So we get the current mapping then.</p>

<p><strong>Linear: 0xffff80000000 â€“ 0xffff80000000 + 512MB The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a>&gt; Physical: 0 â€“ 512MB</strong></p>

<p>You can use a gdb to print the page table and debug it in your own. Here is a simple â€œit works!â€ script for parsing the page directory entry</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/usr/bin/python

import argparse

def main():
    parser = argparse.ArgumentParser(description='Page Table Entry Decoder\n Convert into human-friendly mode')
    parser.add\_argument('value', type=str)
    args = parser.parse\_args()
    value = (int(args.value, 16))
    P = value &amp; 0x0000000000000001
    if not P:
        print("PE = 0, page not present")
        return
    else:
        print("PE = 1")

    RW = value &amp; 0x0000000000000002
    if not RW:
        print("R/W = 0, Only Read access")
    else:
        print("R/W = 1, Read/Write access")

    US = value &amp; 0x0000000000000004
    if not US:
        print("U/S = 0, only for kernel access")
    else:
        print("U/S = 1, user/kernel access")
    
    PS = (value &amp; 0x0000000000000080) &gt;&gt; 7
    PHY = ((value &gt;&gt; 12) &amp; 0x000ffffffffff) &lt;&lt; 12

    print("PS = {:d}".format(PS))
    print("PHYADDR = {:x}".format(PHY))


if \_\_name\_\_ The content is recoverd from Wordpress Blog, for more details please check [HERE](recover-my-blog) '\_\_main\_\_':
    main()

</code></pre></div></div>

<p>Kernel load the early_top_pgt into cr3 using the following code</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    addq	$(early\_top\_pgt - \_\_START\_KERNEL\_map), %rax
    ...
    addq	phys\_base(%rip), %rax
    movq	%rax, %cr3
</code></pre></div></div>

<p>The current page table structure is shown below:</p>

<p><img src="https://web.archive.org/web/20210514134902im_/https://void-shana.moe/wp-content/uploads/2017/11/pasted-image-0-e1511372882463.png" alt="" /></p>

<p>Now we are free to visit any kernel symbol without to force convert the address using <strong>fixup_address</strong>or something else. We can go further to the init/main.c code.</p>

<p>We use a long return to get to get to x86_64_start_kernel</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	pushq	$.Lafter\_lret	# put return address on stack for unwinder
	xorq	%rbp, %rbp	# clear frame pointer
	movq	initial\_code(%rip), %rax
	pushq	$\_\_KERNEL\_CS	# set correct cs
	pushq	%rax
</code></pre></div></div>

<p><strong>initial_code</strong> here is defined as <strong>x86_64_start_kernel</strong>.</p>

<p>Â </p>

<h2 id="moving-to-initmainc">Moving to init/main.c</h2>

<p>We are now at arch/x86/kernel/head64.cÂ and in functionÂ <strong>x86_64_start_kernel</strong></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asmlinkage \_\_visible void \_\_init x86\_64\_start\_kernel(char * real\_mode\_data)
{
	/*
	 * Build-time sanity checks on the kernel image and module
	 * area mappings. (these are purely build-time and produce no code)
	 */
	BUILD\_BUG\_ON(MODULES\_VADDR &lt; \_\_START\_KERNEL\_map);

        /* Omit some initialization code for simplicity */

	/* set init\_top\_pgt kernel high mapping*/
	init\_top\_pgt[511] = early\_top\_pgt[511];

	x86\_64\_start\_reservations(real\_mode\_data);
}
</code></pre></div></div>

<p>We set up <strong>init_top_pgt[511]</strong> same as <strong>early_top_pgt[511]</strong>Â Â <strong>. init_top_pgt</strong> is the final kernel page table. From <strong>x86_64_start_reservations</strong>we get to <strong>start_kernel</strong>This is a function located at init/main.c</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asmlinkage \_\_visible void \_\_init start\_kernel(void)
{
        /* Omit some code for simplicity */

	boot\_cpu\_init();
	page\_address\_init();
	pr\_notice("%s", linux\_banner);
	setup\_arch(&amp;command\_line);

        /* Omit some code for simplicity */

	rest\_init();
}
</code></pre></div></div>

<p>After calling <strong>setup_arch</strong>, CR3 is loaded with init_top_pgt. Then the kernel page table will not change. I wonder if there is a change to switch kernel page table from 2MB size physical page to 4KB physical page, but it seems that the CR3 remained unchanged, and I examined the page entries, they remain unchanged, too. Even the code has executed into <strong>rest_init</strong> then do_idle</p>

<p>The following function is a simple debug function to output the current CR3 register since GDB cannot get the CR3 register value, I just print it out to see when it changed.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>asmlinkage \_\_visible unsigned long shana\_debug\_cr3(void) {
    unsigned long cr3\_value = 0xffffffff;
    asm volatile("mov %%cr3, %0"
            : "=r"(cr3\_value));
    printk("shana\_debug\_cr3: %x", cr3\_value);
    return cr3\_value;
}
</code></pre></div></div>

<p>Â </p>

<hr />

<p><a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/category/kernel">Kernel</a>, <a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/category/linux">Linux</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<ol>
  <li>
    <p><img src="https://web.archive.org/web/20210514134902im_/https://secure.gravatar.com/avatar/5aa864692767e0d284fc73adc5c9f83d?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>068089dy</strong> says: 
<a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html#comment-346">November 25, 2017 at 10:48 am</a>
ä¸æ˜è§‰å‰</p>

    <ol>
      <li><img src="https://web.archive.org/web/20210514134902im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: 
 <a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html#comment-347">November 25, 2017 at 10:57 am</a>
 å°±æ˜¯ linux å†…æ ¸çš„é¡µè¡¨è®¾ç½®è¿‡ç¨‹å•¦ï½ x86_64 çš„</li>
    </ol>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514134902im_/https://secure.gravatar.com/avatar/2567491c82a9e1fd9bb32a00682d83a3?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>Theo</strong> says: 
<a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html#comment-616">May 26, 2019 at 10:11 pm</a>
è¯·é—®è¯´init_top_pgtå°±æ˜¯æœ€ç»ˆé¡µè¡¨ï¼Œä½†æ˜¯æˆ‘åœ¨Systems.mapé‡Œé¢çœ‹åˆ°å®ƒçš„åœ°å€æ˜¯ffffffff83a00000ï¼Œå¯ç›´æ¥æ‰‹åŠ¨èµ°cr3é¡µè¡¨é‡Œé¢ç¿»è¯‘å¾—åˆ°çš„åœ°å€å´éƒ½æ˜¯å½¢å¦‚0xffff880003c01067è¿™æ ·çš„åœ°å€ï¼Œå¹¶ä¸æ˜¯Systems.mapè¿™äº›åœ°å€ï¼Œè¯·é—®ä½ å½“æ—¶çš„0xffff80000000 â€“ 0xffff80000000 + 512MBè¿™ä¸ªèŒƒå›´æ˜¯æ€ä¹ˆå¾—åˆ°çš„å‘¢ï¼Ÿ</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514134902im_/https://secure.gravatar.com/avatar/2567491c82a9e1fd9bb32a00682d83a3?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>Theo</strong> says: 
<a href="https://web.archive.org/web/20210514134902/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html#comment-616">May 26, 2019 at 10:11 pm</a>
è¯·é—®è¯´init_top_pgtå°±æ˜¯æœ€ç»ˆé¡µè¡¨ï¼Œä½†æ˜¯æˆ‘åœ¨Systems.mapé‡Œé¢çœ‹åˆ°å®ƒçš„åœ°å€æ˜¯ffffffff83a00000ï¼Œå¯ç›´æ¥æ‰‹åŠ¨èµ°cr3é¡µè¡¨é‡Œé¢ç¿»è¯‘å¾—åˆ°çš„åœ°å€å´éƒ½æ˜¯å½¢å¦‚0xffff880003c01067è¿™æ ·çš„åœ°å€ï¼Œå¹¶ä¸æ˜¯Systems.mapè¿™äº›åœ°å€ï¼Œè¯·é—®ä½ å½“æ—¶çš„0xffff80000000 â€“ 0xffff80000000 + 512MBè¿™ä¸ªèŒƒå›´æ˜¯æ€ä¹ˆå¾—åˆ°çš„å‘¢ï¼Ÿ</p>
  </li>
</ol>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry><entry><title type="html">Kernel Driver btusb Overview</title><link href="https://void-shana.moe//posts/kernel-driver-btusb-overview" rel="alternate" type="text/html" title="Kernel Driver btusb Overview" /><published>2017-11-02T00:00:00+08:00</published><updated>2017-11-02T00:00:00+08:00</updated><id>https://void-shana.moe//posts/kernel-driver-btusb-overview</id><content type="html" xml:base="https://void-shana.moe//posts/kernel-driver-btusb-overview"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="november-2-2017"><a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/kernel-driver-btusb-overview.html" title="1:59 pm">November 2, 2017</a></h5>
<p><a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/kernel-driver-btusb-overview.html#respond">0 Comment</a></p>

<p>Function</p>

<h3 id="btusb_probe">btusb_probe</h3>

<p>btusb_probe is use for hot plug-in for bluetooth usb generic controller, here will explain the function in detail.</p>

<p>First is an interface check mechanism</p>

<p>This special condition is used for supporting apple Macbook 12,8 (2015 early). According to the normal specification, the main interface for USB is 0, and audio (isochronous) is 1, but apple made a change on it, changing the main interface to 2 and audio to 3. The â€œ<strong>bInterfaceNumber !=2</strong> â€ is for checking hardware for the special case in Apple series product. The macro <strong>BTUSB_IFNUM_2</strong> is a <em>driver_info</em> flag, for Macbook devices, this flag will be set, else it will be 0. See the <strong>btusb_table</strong> for detail.</p>

<p>Then do further check on blacklist devices, some of the blacklist device is because there are specific driver (e.g bcmxxxx) for the device, so they do not use the generic one called btusb. Some of them just because they are not supported, and other reasons.(Not sure what reason are there)</p>

<p>Â </p>

<p>Then we allocate memory for structure btusb_data, use this to store data for the USB interface. Also we need to check the memory remained for the allocation. Then we do the real work: set up currrent interface endpoints for interrupt and bulk <strong>(Why only these two?)</strong> It go through all the endpoint in the current interface. We get the current_altsetting to get a list of current active(available) endpoints.</p>

<p>Â </p>

<p><strong>usb_endpoint_is_int_in</strong> and <strong>usb_endpoint_is_bulk_out</strong>, <strong>usb_endpoint_is_bulk_in</strong> are functions use to know what type of the endpoint is it. These info is use to set up driver data at the end of the call. If none of inter_ep, bulk_tx_ep or bulk_rx_ep is set, it will also result in No Device Error(<strong>ENODEV</strong>)</p>

<p>This part of code is used for URB generation. URB is short for â€œUSB Request Blockâ€ According to the Bluetooth v5.0 Specification, When sending an Control URB to AMP, the bRequest field should be 0x2b. Shown in the figure below.</p>

<p>Â </p>

<p>Currently, for the interface to work with kernel to perform different operations. The driver itself need to be convert to device structure. Use the function named <strong>interface_to_usbdev</strong> Here is a quote from Linux Device Driver 3 :</p>

<p><em>A USB device driver commonly has to convert data from a given</em> <em>struct</em> <em>usb_interface</em> <em>structure into a</em> <em>struct</em> <em>usb_device</em> <em>structure that the USB core needs for a wide range of function calls. To do this, the function interface_to_usbdev is provided. Hopefully, in the future, all USB calls that currently need a</em> <em>struct</em> <em>usb_device</em> <em>will be converted to take a</em> <em>struct</em> <em>usb_interface</em> <em>parameter and will not require the drivers to do the conversion.</em></p>

<p>Â </p>

<p>Then we continue with the initialize process.</p>

<p>Â </p>

<p>Here we init the workqueue, <strong>data-&gt;work</strong> and <strong>data-&gt;waker</strong> these are shared workqueue offered by kernel. (Default Shared workqueue). We call <strong>schedule_work(data-&gt;work)</strong> in <strong>btusb_notify</strong> function to submit a job into workqueue and <strong>data-&gt;wake</strong>r is also controlled by other functions</p>

<p>Then these init_usb_anchor calls. In my view, is just a sort of data queue, URB request will be queued(anchored) in certain queue, then processed in serial. Then init the spinlock for the device(interface)</p>

<p>Â </p>

<p>Another special case, for Intel bluetooth usb generic driver, kernel will use special recv handler functions, for other USB generic bluetooth driver, kernel just use the common one.</p>

<p>Then do a lot of device specific set-up, we skip the code and go to the Â isochronous setup process.</p>

<p>Â </p>

<p>Â </p>

<p>Here, the <strong>usb_driver_claim_interface</strong> is used for set up more than one interface binding to the current device driver. It also happens when this is a isochronous or acm(?) interface, here itâ€™s a isochronous interface</p>

<p>Finally we call <strong>hci_register_dev to register</strong> it , this is one of the function in the Bluetooth Host Controller Interface core function series, from file net/bluetooth/hci/hci_core.c. After that, we set the interface data to intf</p>

<hr />

<p><a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/category/linux/c">C</a>, <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/category/kernel">Kernel</a>, <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/category/linux">Linux</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<p>Post navigation
â€”â€”â€”â€”â€”
<a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html">NEXT<br />
Kernel Bootup Page Table Initialize Process(x86_64)</a>
<a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/building-your-own-live-streaming-site-using-nginx-rtmp-video-js.html">PREVIOUS 
Building your own live streaming site using Nginx RTMP &amp; video.js</a></p>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry><entry><title type="html">Building your own live streaming site using Nginx RTMP &amp;amp; video.js</title><link href="https://void-shana.moe//posts/building-your-own-live-streaming-site-using-nginx-rtmp-video-js" rel="alternate" type="text/html" title="Building your own live streaming site using Nginx RTMP &amp;amp; video.js" /><published>2017-09-12T00:00:00+08:00</published><updated>2017-09-12T00:00:00+08:00</updated><id>https://void-shana.moe//posts/building-your-own-live-streaming-site-using-nginx-rtmp-video-js</id><content type="html" xml:base="https://void-shana.moe//posts/building-your-own-live-streaming-site-using-nginx-rtmp-video-js"><![CDATA[<p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p>

<h5 id="september-12-2017"><a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/linux/building-your-own-live-streaming-site-using-nginx-rtmp-video-js.html" title="10:27 pm">September 12, 2017</a></h5>
<p><a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments  <a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/linux/building-your-own-live-streaming-site-using-nginx-rtmp-video-js.html#comments">1 comment</a></p>

<p>As I said in <a href="https://web.archive.org/web/20210514123546/https://twitter.com/VOID_133/status/906175711211167745">twitter</a>Â I will update my blog at least once a week, so now I am writing this weekâ€™s blog (Although this article doesnâ€™t contain too much technical detail) I just built my personal live server, for the trail version on bilibili is expired. And I donâ€™t want to send sensitive personal data to that platform, so I decided to build one on my own.</p>

<p>Previously I built a live stream service using my raspberry pi, and only use the most simple configuration of nginx, and it does not play very well. Now I have bought a shiny new VPS from CAT.NET with my partner onion, itâ€™s awesomely fast and fluent, so I use this server to build my live stream service, including a frontend to play the stream.</p>

<p>The tutorial is here:Â <a href="https://web.archive.org/web/20210514123546/https://docs.peer5.com/guides/setting-up-hls-live-streaming-server-using-nginx/">https://docs.peer5.com/guides/setting-up-hls-live-streaming-server-using-nginx/</a></p>

<p>The following guide will show how to build one stream server on Archlinux (Yes, archilnux ONLY, but compatible with many other distro), Just follow the basic steps:</p>

<h3 id="setting-up-the-rtmp-streaming-server-with-hls">Setting up the RTMP Streaming Server with HLS</h3>

<ol>
  <li>Install <code class="language-plaintext highlighter-rouge">nginx-rtmp</code>Â from AUR (nginx-mainline + nginx-rtmp-module may also works, but I have problems when compiling the module using makepkg)</li>
  <li>If you have previous nginx configuration, install nginx-rtmp will conflict with nginx, just remove it, no worry about the configuration file you wrote, it will be stored at /etc/nginx/nginx.conf.pacsave</li>
  <li>If you have a previous installation of nginx, after install <code class="language-plaintext highlighter-rouge">nginx-rtmp</code>Â  exec the command <code class="language-plaintext highlighter-rouge">mv /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old</code>Â and <code class="language-plaintext highlighter-rouge">mv /etc/nginx/nginx.conf.pacsave /etc/nginx/nginx.conf</code></li>
  <li>Then restart the nginx server and reload the daemon <code class="language-plaintext highlighter-rouge">systemctl daemon-reload</code>Â  &amp;&amp;Â <code class="language-plaintext highlighter-rouge">systemctl restart nginx.conf</code></li>
  <li>This restart shouldnâ€™t generate any error except you have error in your previous nginx config</li>
  <li>Then <strong>create the rtmp.conf file</strong> (or whatever you name it)Â  example configuration can be found <a href="https://web.archive.org/web/20210514123546/https://github.com/arut/nginx-rtmp-module/wiki/Examples">here</a></li>
</ol>

<p>Here is my rtmp.conf, remember to include it in nginx.conf OUTSIDE the http block like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
 ...
}

include rtmp.conf
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rtmp {
        server {
                

                max\_connections 100;
                chunk\_size 4096;
                ping 30s;
                notify\_method get;

                application my\_live {
                        live on;
                        hls on;
                        hls\_path /tmp/hls;
                        hls\_fragment 3s;
                        hls\_playlist\_length 60s;

                }
        }
}

</code></pre></div></div>

<p>Then you can use <a href="https://web.archive.org/web/20210514123546/https://obsproject.com/">OBS</a> or anything else to push to the livestream, in this example, you should push to</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rtmp://example.com/my\_live
</code></pre></div></div>

<p>In the key field just write something e.g: test</p>

<p>Remember to <code class="language-plaintext highlighter-rouge">mkdir /tmp/hls</code>Â before using the live stream</p>

<p>Â </p>

<h3 id="setting-up-the-live-streamdata-service">Setting up the Live StreamÂ data service</h3>

<p>We need hls.js or videojs with hls supported, I choose the latter one.</p>

<p>create a config in /etc/nginx/sites-available</p>

<p>e.g: live.void-shana.moe.conf</p>

<p>put these lines in the config file</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen 80;

    location /stream {
        # Disable cache
        add\_header Cache-Control no-cache;

        # CORS setup
        add\_header 'Access-Control-Allow-Origin' '*' always;
        add\_header 'Access-Control-Expose-Headers' 'Content-Length';

        # allow CORS preflight requests
        if ($request\_method = 'OPTIONS') {
            add\_header 'Access-Control-Allow-Origin' '*';
            add\_header 'Access-Control-Max-Age' 1728000;
            add\_header 'Content-Type' 'text/plain charset=UTF-8';
            add\_header 'Content-Length' 0;
            return 204;
        }

        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
        }

        alias /tmp/hls;
    }
}
</code></pre></div></div>

<p>Then when you visit https://example.com/stream/test.m3u8 you will get the live stream playlist of live named â€œtestâ€.</p>

<p>This *.m3u8 file is a text file that describes every segment to play (segments are named in <name>-<id>.ts format), here is a sample file</id></name></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#EXTM3U         
#EXT-X-VERSION:3                 
#EXT-X-MEDIA-SEQUENCE:0          
#EXT-X-TARGETDURATION:8          
#EXT-X-DISCONTINUITY             
#EXTINF:8.333,  
test-0.ts       
#EXTINF:8.333,  
test-1.ts       
#EXTINF:8.334,  
test-2.ts
</code></pre></div></div>

<p>The videojs / hls.js will recognize format and parse it, fetch *.ts segments from server then play it one by one, making it looks like a live stream.</p>

<h3 id="create-a-webpage-to-show-it">Create a webpage to show it</h3>

<p>I use videojs with hls support for this, just take a look at view-source://live.void-shana.moe/ you can get a video player that works.</p>

<p>SeeÂ https://github.com/videojs/videojs-contrib-hls#getting-started for more details</p>

<p>Â </p>

<h3 id="screenshot">Screenshot</h3>

<p><img src="https://web.archive.org/web/20210514123546im_/https://void-shana.moe/wp-content/uploads/2017/09/Spectacle.E22359-1024x640.png" alt="" /></p>

<h3 id="todo">TODO</h3>

<p>I didnâ€™t find any credential configuration when setting up rtmp stream, this will make it dangerous when someone know my rtmp URI. Bad guy can push nasty live stream / video to my site, currently the URI is complex, and cannot be fetched from frontend (I only expose the hls interface). Future will try to support auth</p>

<p>Â </p>

<p>If you have problems when setting up the live stream service &amp; frontend, just feel free to comment below, I am glad to help</p>

<hr />

<p><a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/category/linux/archlinux">archlinux</a>, <a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/category/linux">Linux</a> <a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/tag/rtmp">rtmp</a>, <a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/tag/video">video</a></p>

<hr />
<h2 id="historical-comments">Historical Comments</h2>
<ol>
  <li>
    <p><img src="https://web.archive.org/web/20210514123546im_/https://secure.gravatar.com/avatar/fe0faba4dbcdeaec3e701acf14cd47fc?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>Mohammed</strong> says: 
<a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/linux/building-your-own-live-streaming-site-using-nginx-rtmp-video-js.html#comment-388">April 26, 2018 at 8:00 pm</a>
thanks for the article .. i can help in auth</p>
  </li>
  <li>
    <p><img src="https://web.archive.org/web/20210514123546im_/https://secure.gravatar.com/avatar/fe0faba4dbcdeaec3e701acf14cd47fc?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>Mohammed</strong> says: 
<a href="https://web.archive.org/web/20210514123546/https://void-shana.moe/linux/building-your-own-live-streaming-site-using-nginx-rtmp-video-js.html#comment-388">April 26, 2018 at 8:00 pm</a>
thanks for the article .. i can help in auth</p>
  </li>
</ol>]]></content><author><name></name></author><summary type="html"><![CDATA[The content is recoverd from Wordpress Blog, for more details please check HERE]]></summary></entry></feed>