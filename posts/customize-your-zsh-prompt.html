<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Customize Your Zsh Prompt</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Customize Your Zsh Prompt" /><meta name="twitter:description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/customize-your-zsh-prompt"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Customize Your Zsh Prompt</h1><time>June 2, 2019</time> <span>[ ]</span></div><div class="divider"></div><p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p><h5 id="june-2-2019"><a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html" title="2:35 pm">June 2, 2019</a></h5><p><a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comments">4 comments</a></p><h2 id="screenshot">Screenshot</h2><p><img src="https://web.archive.org/web/20210514143128im_/https://img.vim-cn.com/e6/78d4e48a5339575a8227fa866adcb765b8b641.png" alt="This image has an empty alt attribute; its file name is 78d4e48a5339575a8227fa866adcb765b8b641.png" /></p><p>You may need “good network condition” to preview this anime</p><p><img src="https://web.archive.org/web/20210514143128im_/https://img.vim-cn.com/e6/78d4e48a5339575a8227fa866adcb765b8b641.png" alt="" />Screenshot for my zsh prompt Instructions ————</p><p>I choose to use zsh <strong>promptinit</strong> system to write my own themes, which can be easily managed by zsh <code class="language-plaintext highlighter-rouge">prompt</code></p><h3 id="before-you-start">Before you start</h3><p>the <code class="language-plaintext highlighter-rouge">promptinit</code> uses autoload mechanism to load the theme file, so first we need to ensure the theme file <strong>locates inside fpath</strong>, if not, we should add the path containing your theme file into <code class="language-plaintext highlighter-rouge">fpath</code> array, just like the following (suggest my theme is in ~/.zsh/themes):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fpath=(~/.zsh/themes $fpath)
</code></pre></div></div><p><strong>Remember to put this line before any fpath &amp; autoload modification, e.g: if you are using grml-zsh-config, it’s recommended to put this line into ~/.zsh.pre</strong></p><p>And then you should set the theme file name to <code class="language-plaintext highlighter-rouge">prompt_&lt;theme&gt;_setup</code>, this will be recognized by the zsh promptinit system. Then create a function named <code class="language-plaintext highlighter-rouge">prompt_&lt;theme&gt;_setup</code> inside your theme file. Your theme file now should have a basic skeleton like this (e.g: your theme name is moe).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prompt\_moe\_setup () {

}

prompt\_moe\_setup [[email protected]](/web/20210514143128/https://void-shana.moe/cdn-cgi/l/email-protection)
</code></pre></div></div><p>According to the <a href="#References">manpage</a> [1], You can declare the following functions for your prompt theme:</p><ul><li>prompt_<theme>\_precmd: Add it into precmd hook(`add-zsh-hook precmd prompt_<theme>_precmd`) to enable theme precmd</theme></theme></li></ul><blockquote><p>Quick reference to hook functions: zsh has some defined hook functions, such as <code class="language-plaintext highlighter-rouge">precmd</code>, <code class="language-plaintext highlighter-rouge">preexec</code>, etc, you can define an array with the string “_functions” append, such as <code class="language-plaintext highlighter-rouge">precmd_functions</code>, You can try <code class="language-plaintext highlighter-rouge">echo $precmd_functions</code> to see what’s the content inside. And all the elements inside the array will be treated as functions, execute with the same context and argument as the basic function. If the function not found, just siliently ignore it, and continue to next one. for more information please refer to the <a href="#References-(1)">zsh doc functions section</a> [2]</p></blockquote><ul><li>prompt_<theme>\_preview: Enable prompt preview via `prompt -p`</theme></li><li>prompt_<theme>\_help: Enable help command via `prompt -h`</theme></li></ul><h3 id="customize-the-ps-rps">Customize the PS, RPS</h3><p>By convention, themes use for <code class="language-plaintext highlighter-rouge">PS1</code>, <code class="language-plaintext highlighter-rouge">PS2</code>, <code class="language-plaintext highlighter-rouge">RPS1</code>, etc. instead of <code class="language-plaintext highlighter-rouge">PROMPT</code>, <code class="language-plaintext highlighter-rouge">RPROMPT</code>. As the example above, inside <code class="language-plaintext highlighter-rouge">prompt_moe_setup</code> we can define <code class="language-plaintext highlighter-rouge">PS1</code>, <code class="language-plaintext highlighter-rouge">PS2</code>, etc. But what are <code class="language-plaintext highlighter-rouge">PS1</code>, <code class="language-plaintext highlighter-rouge">PS2</code>, <code class="language-plaintext highlighter-rouge">RPS1</code>?</p><ul><li>PS1: The primary prompt string, displays just before the command input.</li><li>PS2: When your command is not finished in one line, it will display in the next following lines until your command is finsihed (e.g.: write a multi-line while loop in zsh)</li><li>RPS1: It will display at the right hand side when PS1 is displayed. (For me, a right hand side RPS1 is useful to display error code information)</li></ul><p>There are also other prompt parameters(officially called parameters by zsh, but I think maybe variable is more intuitive) such as <code class="language-plaintext highlighter-rouge">PS3</code>,<code class="language-plaintext highlighter-rouge">PS4</code>, etc. but we don’t really use it in common. For all the prompt variables, they all accept the same prompt escape sequence. The following are some commonly used escape sequence:</p><ul><li><code class="language-plaintext highlighter-rouge">%/</code> <code class="language-plaintext highlighter-rouge">%~</code>: Current working dir, Try them to see the difference.</li><li><code class="language-plaintext highlighter-rouge">%m</code> <code class="language-plaintext highlighter-rouge">%M</code>: machine host name, either in short or full format.</li><li><code class="language-plaintext highlighter-rouge">%B</code> <code class="language-plaintext highlighter-rouge">%b</code>: Begin / end <strong>bold</strong> text mode.</li><li><code class="language-plaintext highlighter-rouge">%n</code>: $USERNAME variable</li></ul><p>For a full escape sequence reference please refer to the zsh-manual <a href="#References">Propmt Expansion</a> [3]. To debug your prompt string, you can simply use <code class="language-plaintext highlighter-rouge">print -rP &lt;STRING&gt;</code> to see the effect of your prompt, no need to reload zsh each time.</p><p>A trick of displaying error code information: I use <code class="language-plaintext highlighter-rouge">%(?..%F{red}\(?%f)</code> to display the error code in )RPS1, it will only show a red error code when the error code is not 0. The form <code class="language-plaintext highlighter-rouge">%(?.&lt;true-text&gt;.&lt;false-text&gt;)</code> is a conditional substring, means when the exit status of the last command is not 0, it will display the <code class="language-plaintext highlighter-rouge">&lt;false-text&gt;</code> else display <code class="language-plaintext highlighter-rouge">&lt;true-text&gt;</code>, we just leave the <code class="language-plaintext highlighter-rouge">&lt;true-text&gt;</code> blank so it won’t display anything when the command exit without any error.</p><h3 id="enable-version-control-info">Enable version control info</h3><p>It might be good to display the git info (or other vcs) along with your prompt. zsh has a powerful module vcs_info that can help you with this need.</p><p>For a quick start, you need to add the following lines into your theme file. (Still use the example above)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>prompt\_opts=(subst percent)

function prompt\_moe\_precmd() {
    vcs\_info
}

</code></pre></div></div><p>Then append <code class="language-plaintext highlighter-rouge">\(vcs_info_msg_0_</code> into your prompt. Be careful that you should append the plain text <code class="language-plaintext highlighter-rouge">\)vcs_info_msg_0</code> instead of this variable, since the variable will be evaluated only when it is declared, while the plain mode is subjected to <a href="#References">Parameter Expansion</a> [3], that is, it will be evaluated each time the text displays. The following line is an example of adding vcs_info to your PS1:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS1="$PS1 \$vcs\_info\_msg\_0\_"

</code></pre></div></div><p>You might want also customize the <code class="language-plaintext highlighter-rouge">$vcs_info_msg_0_</code> prompt, such as changing the color, add / remove information displayed. You can achieve this with <code class="language-plaintext highlighter-rouge">zstyle</code>. Following are a list of common options:</p><ul><li><code class="language-plaintext highlighter-rouge">zstyle ':vcs_info:*' formats &lt;STRING&gt;</code>: Set the normal vcs_info format string(when you are not in rebase, merge or other actions it will display this one), you can get the current value by <code class="language-plaintext highlighter-rouge">zstyle | grep vcs_info -B1</code>.</li><li><code class="language-plaintext highlighter-rouge">zstyle ':vcs_info:*' actionformats &lt;STRING&gt;</code>: Set the vcs_info string when in rebase, merge or other actions.</li><li><code class="language-plaintext highlighter-rouge">zstyle 'vcs_info:*' check-for-changes true/false</code>: Enable / Disable checking for the uncommitted changes in current workdir, and if there are uncommitted changes it will display either %u (for unstaged changes) or %c (for staged changes). These to escape sequences can be also configured by <code class="language-plaintext highlighter-rouge">zstyle</code></li><li><code class="language-plaintext highlighter-rouge">zstyle ':vcs_info:*' unstagedstr &lt;STRING&gt;</code>: Set the string to display for %u</li></ul><p>Note that we use “:vcs_info:*” above to match for all kinds of vcs systems as long as all repos to give them the settings. If you want to set different options for specified repos / vcs (e.g: Disable the check-for-changes for kernel repo since it’s too big and cause delay), see the example below:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>zstyle ':vcs\_info:*:*:latest-linux-kernel' check-for-changes false

</code></pre></div></div><p>This will only disable check for unstaged change for repo with root directory named “latest-linux-kernel”.</p><p>About a full reference about vcs_info usage and configuration, see <a href="#References">zsh documentation for vcs_info</a> [4]</p><h3 id="async-zsh-prompt">Async Zsh Prompt</h3><p>Although the vcs_info is useful, you may already found lags when turn on the the <code class="language-plaintext highlighter-rouge">check-for-changes</code> option, esp. in large repos. It’s annoying that the prompt doesn’t display instantly after we press enter. One option is to disable the <code class="language-plaintext highlighter-rouge">check-for-changes</code> option for these huge repos, however it’s just a workaround.</p><p>Fortunately, we have async zsh job support which can solve the problem. There are different kinds of async plugin we can use in zsh, for this blog we will use <a href="#References">zsh-async</a> [5].</p><p>zsh-async supports async jobs as well as callback handlers. Along with ZLE (<a href="#References">Zsh Line Editor</a> [6]) command <code class="language-plaintext highlighter-rouge">zle reset-prompt</code> we can achieve the async update of <code class="language-plaintext highlighter-rouge">PS1</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function prompt\_moe\_setup() {
    # Other codes ...    
    async\_start\_worker vcs\_updater\_worker
    async\_register\_callback vcs\_updater\_worker do\_update
}

function do\_update() {
    vcs\_info
    zle reset-prompt
}

function prompt\_moe\_precmd() {
    async\_job vcs\_updater\_worker
}


</code></pre></div></div><p>And then you have your async vcs_info now! But the code above is somehow glitchy, An optimized one can be found here: <a href="https://web.archive.org/web/20210514143128/https://gist.github.com/VOID001/588347b0ef4b3a14759579e8bf6acb23#file-prompt_moe_setup-L48">https://gist.github.com/VOID001/588347b0ef4b3a14759579e8bf6acb23#file-prompt_moe_setup-L48</a> (Still have some glitches but it’s currently fine for me)</p><p>The code above does the following things:</p><ul><li>In executing hook precmd, it starts an empty async task, which will return immediately.</li><li>After the async job finished, it will execute the callback function: <code class="language-plaintext highlighter-rouge">do_update</code>.</li><li>In <code class="language-plaintext highlighter-rouge">do_update</code>, we call vcs_info to update the $vcs_info_msg_0_ (Note this will not block the prompt or any interaction with current prompt). Then we use <code class="language-plaintext highlighter-rouge">zle reset-prompt</code> to reload current prompt.</li></ul><h2 id="ending">Ending</h2><p>Writing bash/zsh script is somehow painful for me so I previously stick to oh-my-zsh for a long time. However the zsh completion and git-prompt-info is so slow that always bother me. So I tried to switch to <code class="language-plaintext highlighter-rouge">grml-zsh-config</code> and define a custom prompt for me, what I found suprising is that writing (simple) zsh scripts are not as difficult as I think thanks to the well-documented zsh manpage and online manual. So I wrote this article as a “Zsh Theme Creation Quick Start Guide” for those who are dissatisfied with the oh-my-zsh themes and want to have a chance to create your own theme.</p><p>Thanks for <a href="https://web.archive.org/web/20210514143128/https://blog.lilydjwg.me/">@lilydjwg</a> for giving me lots of help when writing the theme. Thanks for @swordfeng for providing me with cute sample theme.</p><h2 id="references">References</h2><ul><li><strong>(1)</strong> zshall(1) manual page: “PROMPT THEMES”</li><li><strong>(2)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/Functions.html">http://zsh.sourceforge.net/Doc/Release/Functions.html</a></li><li><strong>(3)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/Prompt-Expansion.html#Prompt-Expansion">http://zsh.sourceforge.net/Doc/Release/Prompt-Expansion.html#Prompt-Expansion</a></li><li><strong>(4)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/User-Contributions.html#Version-Control-Information">http://zsh.sourceforge.net/Doc/Release/User-Contributions.html#Version-Control-Information</a></li><li><strong>(5)</strong> <a href="https://web.archive.org/web/20210514143128/https://github.com/mafredri/zsh-async/">https://github.com/mafredri/zsh-async/</a></li><li><strong>(6)</strong> <a href="https://web.archive.org/web/20210514143128/http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html#Zsh-Line-Editor">http://zsh.sourceforge.net/Doc/Release/Zsh-Line-Editor.html#Zsh-Line-Editor</a></li></ul><hr /><p><a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/category/linux/archlinux">archlinux</a>, <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/category/linux">Linux</a> <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/tag/linux">linux</a>, <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/tag/prompt">prompt</a>, <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/tag/zsh">zsh</a></p><hr /><h2 id="historical-comments">Historical Comments</h2><ol><li><p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/d8fb8dde3de28b1d063f405a6007e1ac?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>naruto-ding</strong> says: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1049">January 13, 2020 at 2:00 am</a> Hello,</p><ol><li><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1052">January 14, 2020 at 3:44 pm</a> Hello naruto-ding, Glad you like it! But I am sorry to tell you that I don’t have enough time to finish that series. That series of video is made when I was a senior student. The neu-os and the video tutorial is for teaching use of the “Linux Operating System” course in my school. After I graduate I have many other things to work and study so I don’t have the time to do that. I tried to ask the current maintainer of neu-os in my previous school to continue publishing some video tutorials but they are also very busy. Making one episode of the series tutorial will take me more than 12 hours – 20 hours or even further, there are a lot of preparation needed such as the slides, the references, the sample code, etc.<br /> However, in the future although I cannot update these OS tutorial videos, I will try to post some short videos (not in series) related to the operating system (such as ext4 file system, linux utility, command-line tools, etc). This kind of video will be less time consuming to made and to watch. Also I think it will provide some useful information for the audience.</li></ol></li><li><p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/d8fb8dde3de28b1d063f405a6007e1ac?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>naruto-ding</strong> says: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1050">January 13, 2020 at 2:10 am</a> I realize the comments under each blog is quite slow. Hope to get the chance to consult with you for daily questions if it doesn’t bother you too much. Maybe your email for further contact. (✿◡‿◡)</p><ol><li><p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1053">January 14, 2020 at 3:46 pm</a> Hello naruto-ding,<br /> You can find my contact information here: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/void">https://void-shana.moe/void</a><br /> Feel free to send me the email/in-site comments/questions about os via github issue <a href="https://web.archive.org/web/20210514143128/https://github.com/VOID001/neu-os">https://github.com/VOID001/neu-os</a>, I will be very happy to exchange thoughts with you.</p></li><li><p><img src="https://web.archive.org/web/20210514143128im_/https://secure.gravatar.com/avatar/5612f7d51961a8e49efb43a5e4cf18a6?s=50&amp;d=identicon&amp;r=g" alt="" /> <strong>VOID001</strong> says: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/linux/customize-your-zsh-prompt.html#comment-1053">January 14, 2020 at 3:46 pm</a> Hello naruto-ding,<br /> You can find my contact information here: <a href="https://web.archive.org/web/20210514143128/https://void-shana.moe/void">https://void-shana.moe/void</a><br /> Feel free to send me the email/in-site comments/questions about os via github issue <a href="https://web.archive.org/web/20210514143128/https://github.com/VOID001/neu-os">https://github.com/VOID001/neu-os</a>, I will be very happy to exchange thoughts with you.</p></li></ol></li></ol><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>