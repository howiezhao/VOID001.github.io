<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Kernel Driver btusb Overview</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Kernel Driver btusb Overview" /><meta name="twitter:description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/kernel-driver-btusb-overview"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Kernel Driver btusb Overview</h1><time>November 2, 2017</time> <span>[ ]</span></div><div class="divider"></div><p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p><h5 id="november-2-2017"><a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/kernel-driver-btusb-overview.html" title="1:59 pm">November 2, 2017</a></h5><p><a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/kernel-driver-btusb-overview.html#respond">0 Comment</a></p><p>Function</p><h3 id="btusb_probe">btusb_probe</h3><p>btusb_probe is use for hot plug-in for bluetooth usb generic controller, here will explain the function in detail.</p><p>First is an interface check mechanism</p><p>This special condition is used for supporting apple Macbook 12,8 (2015 early). According to the normal specification, the main interface for USB is 0, and audio (isochronous) is 1, but apple made a change on it, changing the main interface to 2 and audio to 3. The “<strong>bInterfaceNumber !=2</strong> ” is for checking hardware for the special case in Apple series product. The macro <strong>BTUSB_IFNUM_2</strong> is a <em>driver_info</em> flag, for Macbook devices, this flag will be set, else it will be 0. See the <strong>btusb_table</strong> for detail.</p><p>Then do further check on blacklist devices, some of the blacklist device is because there are specific driver (e.g bcmxxxx) for the device, so they do not use the generic one called btusb. Some of them just because they are not supported, and other reasons.(Not sure what reason are there)</p><p> </p><p>Then we allocate memory for structure btusb_data, use this to store data for the USB interface. Also we need to check the memory remained for the allocation. Then we do the real work: set up currrent interface endpoints for interrupt and bulk <strong>(Why only these two?)</strong> It go through all the endpoint in the current interface. We get the current_altsetting to get a list of current active(available) endpoints.</p><p> </p><p><strong>usb_endpoint_is_int_in</strong> and <strong>usb_endpoint_is_bulk_out</strong>, <strong>usb_endpoint_is_bulk_in</strong> are functions use to know what type of the endpoint is it. These info is use to set up driver data at the end of the call. If none of inter_ep, bulk_tx_ep or bulk_rx_ep is set, it will also result in No Device Error(<strong>ENODEV</strong>)</p><p>This part of code is used for URB generation. URB is short for “USB Request Block” According to the Bluetooth v5.0 Specification, When sending an Control URB to AMP, the bRequest field should be 0x2b. Shown in the figure below.</p><p> </p><p>Currently, for the interface to work with kernel to perform different operations. The driver itself need to be convert to device structure. Use the function named <strong>interface_to_usbdev</strong> Here is a quote from Linux Device Driver 3 :</p><p><em>A USB device driver commonly has to convert data from a given</em> <em>struct</em> <em>usb_interface</em> <em>structure into a</em> <em>struct</em> <em>usb_device</em> <em>structure that the USB core needs for a wide range of function calls. To do this, the function interface_to_usbdev is provided. Hopefully, in the future, all USB calls that currently need a</em> <em>struct</em> <em>usb_device</em> <em>will be converted to take a</em> <em>struct</em> <em>usb_interface</em> <em>parameter and will not require the drivers to do the conversion.</em></p><p> </p><p>Then we continue with the initialize process.</p><p> </p><p>Here we init the workqueue, <strong>data-&gt;work</strong> and <strong>data-&gt;waker</strong> these are shared workqueue offered by kernel. (Default Shared workqueue). We call <strong>schedule_work(data-&gt;work)</strong> in <strong>btusb_notify</strong> function to submit a job into workqueue and <strong>data-&gt;wake</strong>r is also controlled by other functions</p><p>Then these init_usb_anchor calls. In my view, is just a sort of data queue, URB request will be queued(anchored) in certain queue, then processed in serial. Then init the spinlock for the device(interface)</p><p> </p><p>Another special case, for Intel bluetooth usb generic driver, kernel will use special recv handler functions, for other USB generic bluetooth driver, kernel just use the common one.</p><p>Then do a lot of device specific set-up, we skip the code and go to the  isochronous setup process.</p><p> </p><p> </p><p>Here, the <strong>usb_driver_claim_interface</strong> is used for set up more than one interface binding to the current device driver. It also happens when this is a isochronous or acm(?) interface, here it’s a isochronous interface</p><p>Finally we call <strong>hci_register_dev to register</strong> it , this is one of the function in the Bluetooth Host Controller Interface core function series, from file net/bluetooth/hci/hci_core.c. After that, we set the interface data to intf</p><hr /><p><a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/category/linux/c">C</a>, <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/category/kernel">Kernel</a>, <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/category/linux">Linux</a></p><hr /><h2 id="historical-comments">Historical Comments</h2><p>Post navigation ————— <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/kernel-bootup-page-table-initialize-processx86_64.html">NEXT<br /> Kernel Bootup Page Table Initialize Process(x86_64)</a> <a href="https://web.archive.org/web/20210225082831/https://void-shana.moe/linux/building-your-own-live-streaming-site-using-nginx-rtmp-video-js.html">PREVIOUS Building your own live streaming site using Nginx RTMP &amp; video.js</a></p><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>