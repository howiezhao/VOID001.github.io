<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>(Linux 0.11) Draft 6 IA32架构下多任务的硬件支持</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="(Linux 0.11) Draft 6 IA32架构下多任务的硬件支持" /><meta name="twitter:description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/linux-0-11-draft-6-ia32%E6%9E%B6%E6%9E%84%E4%B8%8B%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%9A%84%E7%A1%AC%E4%BB%B6%E6%94%AF%E6%8C%81"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>(Linux 0.11) Draft 6 IA32架构下多任务的硬件支持</h1><time>April 8, 2017</time> <span>[ ]</span></div><div class="divider"></div><p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p><h5 id="april-8-2017"><a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%b3%bb%e7%bb%9f%e5%8e%9f%e7%90%86/linux-0-11-draft-6-ia32%e6%9e%b6%e6%9e%84%e4%b8%8b%e5%a4%9a%e4%bb%bb%e5%8a%a1%e7%9a%84%e7%a1%ac%e4%bb%b6%e6%94%af%e6%8c%81.html" title="11:55 pm">April 8, 2017</a></h5><p><a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments <a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%b3%bb%e7%bb%9f%e5%8e%9f%e7%90%86/linux-0-11-draft-6-ia32%e6%9e%b6%e6%9e%84%e4%b8%8b%e5%a4%9a%e4%bb%bb%e5%8a%a1%e7%9a%84%e7%a1%ac%e4%bb%b6%e6%94%af%e6%8c%81.html#respond">0 Comment</a></p><p>Overview The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p><p>支持多任务的硬件结构为 Task Register (TR) Task State Segment (TSS), LDT 以及 Task Gate。而最核心的，存储任务上下文信息的就是 Task State Segment, 下面对其进行详细的说明</p><h2 id="tss基本数据结构">TSS基本数据结构</h2><ul><li>GDT, LDT</li><li>TSS(Task State Segment)  has its own descriptor called TSS Descriptor</li><li>Structure of 32 bit TSS, store the context and link to previous task, and 3 different privileged Stack</li></ul><p><img src="https://web.archive.org/web/20201020194406im_/https://void-shana.moe/wp-content/uploads/2017/04/aaaaa.png" alt="" /></p><p>下面对一些比较关键的部分进行介绍</p><ul><li>Previous Task Link: 存储的是上一个任务的选择符</li><li>LDT Segment Selector: 存储的是这个Task使用的LDT</li><li>I/O Map Base Address: I/O Map的基地址（要对 I/O Map 是什么进行进一步的解读: I/O Map 包含一个权限Map和一个Interrupt redirect Map)</li></ul><h3 id="tss-描述符的一些说明">TSS 描述符的一些说明</h3><ul><li>TSS Descriptor 用于描述 Task State Segment 的描述符,当选择符的TI Flag被置位的时候（即指向当前LDT)不可以访问TSS, 这种情况下，使用 CALL, JMP 会引发GP#, 使用IRET 会引发#TS(Invalid TSS Exception), TSS Descriptor只能被放在 GDT 中，不可以放在 LDT IDT 中</li><li>下面是TSS描述符的结构</li></ul><p><img src="https://web.archive.org/web/20201020194406im_/https://void-shana.moe/wp-content/uploads/2017/04/aaaaa-1.png" alt="" /></p><p> Type 有两种 1001 1011， 前者表示该TSSD对应的Task处于 inactive 状态下，后者表示该 TSSD 对应的Task正处于Busy状态下</p><p> </p><ul><li>每一个Task只能有一个TSS Descriptor对应</li><li>Task Gate Descriptor  做切换的时候不需要检查 CPL</li></ul><p> </p><h2 id="任务切换过程">任务切换过程</h2><p>任务切换发生在下面几种情况下:</p><ul><li>当前运行的任务 JMP / CALL 了GDT中的一个TSS ， 当 CALL / JMP 以 FAR 模式被调用的时候，如果 Segement Selector 指向的选择符是一个 TSSD, 那么就会发生 Task Switch, 忽略掉 CALL / JMP 的 offset。</li><li>同样的，如果调用 JMP / CALL 而且 Selector 为 GDT / LDT 中的一个 Task Gate Descriptor（任务门描述符）也会发生 Task Switch</li><li>发生中断/异常，且中断向量指向一个Task Gate Descriptor</li><li>IRET 指令被调用且 EFLAGS 寄存器的 NT Flag 被置位</li></ul><p> </p><p>任务切换过程比较繁琐，这里简单说明其过程</p><p> </p><ol><li>获取 TSS 的 Segment Selector， 如果是 JMP / CALL 则是直接给出的， 或者是通过中断指向的 Task Gate Descriptor 给出，如果是 IRET 指令，则查看当前 TSS 的 Previous Task Link (见上图 TSS结构图)获得 Selector</li><li>检查特权级别， 如果是 CALL / JMP 则需要检查特权级别，中断 和 IRET 不需要检查， INT n 指令引发的中断调用，会检查特权级别</li><li>检查 TSS 的合法性，以及其他必要检查</li><li>清除或者设置相应的标志位</li><li>将当前(old)任务状态保存到当前的TSS内,</li><li>如果任务切换不是因为 IRET 引起的，则将新任务的 TSSD 的 Busy 位置位</li><li>装载新的 Task Descriptor(Selector) 到 Task Register</li><li>将新的 Task State Segment(TSS) 中的上下文装入通用寄存器，段寄存器, EIP EFLAGS 等寄存器（见上图 TSS结构)</li><li>上下文(context)已经设置好了，开始执行新的任务(此时的EIP, CS等 寄存器已经是该TSS中给定的寄存器了，之前的任务完全转移走了)</li></ol><p>下一篇文章会对Linux0.11中如何实现任务切换进行介绍</p><hr /><p><a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/category/linux/kernel-linux">Kernel</a>, <a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/category/%e8%ae%a1%e7%ae%97%e6%9c%ba%e7%b3%bb%e7%bb%9f%e5%8e%9f%e7%90%86">计算机系统原理</a> <a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/tag/linux">linux</a>, <a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/tag/os">os</a></p><hr /><h2 id="historical-comments">Historical Comments</h2><p>Post navigation ————— <a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/linux/i3-conky-%e6%89%93%e9%80%a0%e5%ae%9e%e7%94%a8%e7%be%8e%e8%a7%82%e7%9a%84%e6%a1%8c%e9%9d%a2%e7%8e%af%e5%a2%83-w.html">NEXT<br /> i3 + conky 打造实用美观的桌面环境 =w=</a> <a href="https://web.archive.org/web/20201020194406/https://void-shana.moe/linux/linux-0-11-draft-5-%e8%99%9a%e6%8b%9f%e5%86%85%e5%ad%98%e7%ae%a1%e7%90%86mmmemory-c.html">PREVIOUS [Linux 0.11] Draft 5 虚拟内存管理(mm/memory.c)</a></p><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>