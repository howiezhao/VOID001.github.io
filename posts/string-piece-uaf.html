<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>ä¸€ä¸ªç”±é”™è¯¯çš„ä½¿ç”¨ String Piece å¯¼è‡´çš„ Use After Free é—®é¢˜æ’æŸ¥</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="ä¸€ä¸ªç”±é”™è¯¯çš„ä½¿ç”¨ String Piece å¯¼è‡´çš„ Use After Free é—®é¢˜æ’æŸ¥" /><meta name="twitter:description" content="TL;DR"><meta name="description" content="TL;DR"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/string-piece-uaf"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>ä¸€ä¸ªç”±é”™è¯¯çš„ä½¿ç”¨ String Piece å¯¼è‡´çš„ Use After Free é—®é¢˜æ’æŸ¥</h1><time>June 4, 2022</time> <span>[ ]</span></div><div class="divider"></div><h1 id="tldr">TL;DR</h1><ul><li>æ„é€  <code class="language-plaintext highlighter-rouge">StringPiece</code> çš„æ—¶å€™è¦ä¿è¯ä»–åº•å±‚çš„ string ç”Ÿå‘½å‘¨æœŸæ¯” <code class="language-plaintext highlighter-rouge">StringPiece</code> é•¿</li><li>Address Sanitizer is your friend</li><li>From my friend: äººç”Ÿè‹¦çŸ­ï¼Œè¯·ç”¨ Clang</li></ul><h1 id="background">Background</h1><p>StringPiece (or <code class="language-plaintext highlighter-rouge">absl::string_view</code> <code class="language-plaintext highlighter-rouge">std::string_view</code>) ä»–ä»¬éƒ½æ˜¯ä¸ºäº†è®©å¼€å‘è€…å¯ä»¥è®¿é—®è€Œä¸æŒæœ‰(own) ä¸€ä¸ªå­—ç¬¦ä¸²è€Œå‡†å¤‡çš„ä¾¿åˆ© utilityï¼Œä½†æ˜¯é”™è¯¯çš„ä½¿ç”¨ä»–ä»¬å¯èƒ½ä¼šå¯¼è‡´å¾ˆå±é™©çš„å†…å­˜é—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™æ®µä»£ç </p><p>ï¼ˆä»¥ absl::string_view åœ¨ C++14 ä¸Šçš„å®ç°ä¸ºå‡†ï¼‰</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;cstdio&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;utility&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span> <span class="cpf">"absl/strings/string_view.h"</span><span class="cp">
</span>
<span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="o">&gt;</span> <span class="n">StringViewPair</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s1</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">s2</span><span class="p">;</span>
  <span class="n">s1</span> <span class="o">=</span> <span class="s">"Good Morning Evil </span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">s2</span> <span class="o">=</span> <span class="s">"Good Evening Evil </span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
  <span class="n">StringViewPair</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%p %p %p %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s1</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s2</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">"%s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div><p>è¿™æ®µä»£ç çœ‹èµ·æ¥ç¨€æ¾å¹³å¸¸ï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸¤ä¸ª string s1, s2, åœ¨å †ä¸Šåˆ†é…äº†ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç©ºé—´ï¼Œç„¶åä½¿ç”¨è¿™ä¸¤ä¸ª string ä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code class="language-plaintext highlighter-rouge">std::make_pair</code> æ„é€ ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">absl::string_view</code> çš„ pair,</p><p>è¿è¡Œè¿™æ®µä»£ç ï¼Œä¼šå‘ç°è¾“å‡ºçš„å†…å®¹å‡ºç°äº†ä¹±ç /ä¸å®Œæ•´ç­‰é—®é¢˜ï¼Œ</p><div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="o">(</span>ã£ãƒ»Ï‰ãƒ»<span class="o">)</span>ã£ ./demo                                                                                                                                                                                                                                                                                                 remote âš›
XÑ–
</code></pre></div></div><p>è¿™é‡Œçš„è¾“å‡ºå’Œæˆ‘ä»¬çš„å­—ç¬¦ä¸²å®Œå…¨å¯¹ä¸ä¸Šï¼Œæ•é”çš„è¯»è€…å¯èƒ½çœ‹åˆ°è¿™é‡Œå·²ç»æƒ³åˆ°äº†æ˜¯ pair.first / pair.second çš„ data æŒ‡å‘çš„å†…å­˜å‡ºç°äº†é—®é¢˜ï¼Œé‚£æˆ‘ä»¬å…ˆæŠŠå„ä¸ª str çš„ data æŒ‡é’ˆéƒ½æ‰“å‡ºæ¥çœ‹çœ‹ï¼ŒæŒ‰ç…§æˆ‘ä»¬çš„æƒ³æ³•ä»¥åŠ <code class="language-plaintext highlighter-rouge">absl::string_view</code> çš„å®ç°ï¼Œè¿™ä¸ª <code class="language-plaintext highlighter-rouge">StringViewPair</code> åº”è¯¥å­˜äº† s1, s2 çš„åº•å±‚æŒ‡é’ˆï¼Œä½†æ˜¯æ‰“å°å‡ºæ¥çš„å­—ç¬¦ä¸²å´æ˜¯ dirty çš„</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">string_view</span> <span class="p">{</span>
<span class="c1">// ...</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Allocator</span><span class="p">&gt;</span>
  <span class="n">string_view</span><span class="p">(</span>  <span class="c1">// NOLINT(runtime/explicit)</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Allocator</span><span class="o">&gt;&amp;</span> <span class="n">str</span>
          <span class="n">ABSL_ATTRIBUTE_LIFETIME_BOUND</span><span class="p">)</span> <span class="k">noexcept</span>
      <span class="c1">// This is implemented in terms of `string_view(p, n)` so `str.size()`</span>
      <span class="c1">// doesn't need to be reevaluated after `ptr_` is set.</span>
      <span class="c1">// The length check is also skipped since it is unnecessary and causes</span>
      <span class="c1">// code bloat.</span>
      <span class="o">:</span> <span class="n">string_view</span><span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">SkipCheckLengthTag</span><span class="p">{})</span> <span class="p">{}</span>
<span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div><h1 id="debugging">Debugging</h1><p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢çš„ sample ä»£ç ä¸­æ·»åŠ ä¸€è¡Œä»£ç  (ä¸Šé¢çš„ sample ä¸­å·²æ·»åŠ )</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printf</span><span class="p">(</span><span class="s">"%p %p %p %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">s1</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s2</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
</code></pre></div></div><p>åœ¨æˆ‘æœ¬åœ°çš„è¾“å‡ºå¦‚ä¸‹</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x60300000efe0 0x60300000efb0 0x60300000ef80 0x60300000ef50
</code></pre></div></div><p>æˆ‘ä»¬å‘ç° <code class="language-plaintext highlighter-rouge">s1.data()</code> å’Œ <code class="language-plaintext highlighter-rouge">pair.first.data()</code> ä»–ä»¬ä¸¤ä¸ªçš„å†…å­˜åœ°å€å¹¶ä¸ç›¸åŒï¼Œè¿™è¯´æ˜ï¼Œåœ¨ make pair çš„æ—¶å€™ï¼Œå¯èƒ½å‘ç”Ÿäº†å†…å­˜æ‹·è´ï¼Œé€šè¿‡æŸ¥é˜… <a href="https://en.cppreference.com/w/cpp/utility/pair/make_pair">cppreference</a> æˆ‘ä»¬å¾—åˆ°äº†å¦‚ä¸‹çš„è§£é‡Š</p><blockquote><p>The deduced types <code class="language-plaintext highlighter-rouge">V1</code> and <code class="language-plaintext highlighter-rouge">V2</code> are <a href="http://en.cppreference.com/w/cpp/types/decay">std::decay</a><T1>::type and [std::decay](http://en.cppreference.com/w/cpp/types/decay)<T2>::type (the usual type transformations applied to arguments of functions passed by value) unless application of [std::decay](https://en.cppreference.com/w/cpp/types/decay) results in [std::reference_wrapper](http://en.cppreference.com/w/cpp/utility/functional/reference_wrapper)<X> for some type `X`, in which case the deduced type is `X&amp;`.</X></T2></T1></p></blockquote><p>çœ‹èµ·æ¥ï¼Œmake_pair åœ¨è¿›è¡Œç±»å‹æ¨æ–­çš„æ—¶å€™ï¼Œä¼šå°†å‚æ•°ç±»å‹æ¨æ–­åï¼ŒæŒ‰ç…§å€¼çš„æ–¹å¼ä¼ é€’ï¼Œè€ŒéæŒ‰ç…§å¼•ç”¨çš„æ–¹å¼ä¼ é€’ï¼Œå› è€Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå†…å­˜å‘ç”Ÿäº†æ‹·è´</p><p>åˆ†æ C++ å†…å­˜ç›¸å…³é—®é¢˜çš„åˆ©å™¨å°±æ˜¯ <strong>AddressSanitizer</strong> (ASAN), æˆ‘ä»¬æŒ‚ä¸Š ASAN è·‘è¿™ä¸ªç¨‹åºæ¥çœ‹ç»“æœå¦‚ä½•ï¼Œåœ¨æ„å»ºå‚æ•°ä¸­æ·»åŠ  <code class="language-plaintext highlighter-rouge">-fsanitize=address</code> åå†æ¬¡è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼Œå¾—åˆ°äº†å¦‚ä¸‹çš„è¾“å‡º</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x60300000efe0 0x60300000efb0 0x60300000ef80 0x60300000ef50
=================================================================
==2649769==ERROR: AddressSanitizer: heap-use-after-free on address 0x60300000ef80 at pc 0x7f951d7295ce bp 0x7ffde4a9d470 sp 0x7ffde4a9cc20
READ of size 2 at 0x60300000ef80 thread T0
    #0 0x7f951d7295cd  (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8a5cd)
    #1 0x7f951d729d8a in vprintf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ad8a)
    #2 0x7f951d729e47 in __interceptor_printf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ae47)
    #3 0x55c93507994e in main /data04/playground/cpp/string-piece-uaf/main.cc:19
    #4 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
    #5 0x55c935079669 in _start (/data04/playground/cpp/string-piece-uaf/build/demo+0x2669)

0x60300000ef80 is located 0 bytes inside of 20-byte region [0x60300000ef80,0x60300000ef94)
freed by thread T0 here:
    #0 0x7f951d7621f0 in operator delete(void*) (/usr/lib/x86_64-linux-gnu/libasan.so.3+0xc31f0)
    #1 0x55c935079e54 in std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt;::~pair() /usr/include/c++/6/bits/stl_pair.h:194
    #2 0x55c9350798b3 in main /data04/playground/cpp/string-piece-uaf/main.cc:16
    #3 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)

previously allocated by thread T0 here:
    #0 0x7f951d761bf0 in operator new(unsigned long) (/usr/lib/x86_64-linux-gnu/libasan.so.3+0xc2bf0)
    #1 0x7f951d018116 in void std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::_M_construct&lt;char*&gt;(char*, char*, std::forward_iterator_tag) (/usr/lib/x86_64-linux-gnu/libstdc++.so.6+0x120116)
    #2 0x7ffde4a9d5cf  (&lt;unknown module&gt;)
    #3 0x5  (&lt;unknown module&gt;)

SUMMARY: AddressSanitizer: heap-use-after-free (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8a5cd)
Shadow bytes around the buggy address:
  0x0c067fff9da0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9db0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9dc0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9dd0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9de0: fa fa fa fa fa fa fa fa fa fa fd fd fd fa fa fa
=&gt;0x0c067fff9df0:[fd]fd fd fa fa fa 00 00 00 07 fa fa 00 00 00 07
  0x0c067fff9e00: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e10: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e20: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e30: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
  0x0c067fff9e40: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa
Shadow byte legend (one shadow byte represents 8 application bytes):
  Addressable:           00
  Partially addressable: 01 02 03 04 05 06 07
  Heap left redzone:       fa
  Heap right redzone:      fb
  Freed heap region:       fd
  Stack left redzone:      f1
  Stack mid redzone:       f2
  Stack right redzone:     f3
  Stack partial redzone:   f4
  Stack after return:      f5
  Stack use after scope:   f8
  Global redzone:          f9
  Global init order:       f6
  Poisoned by user:        f7
  Container overflow:      fc
  Array cookie:            ac
  Intra object redzone:    bb
  ASan internal:           fe
  Left alloca redzone:     ca
  Right alloca redzone:    cb
==2649769==ABORTING
</code></pre></div></div><p>å¯¹äºä¸ç†Ÿæ‚‰ ASAN çš„è¯»è€…ï¼Œä¸Šé¢çš„è¾“å‡ºæœ€åˆçœ‹å¯èƒ½æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œæˆ‘ä»¬æ¥å…³æ³¨ä¸€ä¸‹é‡ç‚¹éƒ¨åˆ†</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==2649769==ERROR: AddressSanitizer: heap-use-after-free on address 0x60300000ef80 at pc 0x7f951d7295ce bp 0x7ffde4a9d470 sp 0x7ffde4a9cc20
</code></pre></div></div><p>é¦–å…ˆæœ€å‰é¢åˆ—å‡ºäº†è¿›ç¨‹IDï¼Œç„¶åæ˜¯é”™è¯¯çš„ç±»å‹ <code class="language-plaintext highlighter-rouge">heap-use-after-free</code> æ˜¯ä¸€ä¸ªå †ä¸Šå†…å­˜åœ¨é‡Šæ”¾ååˆè¢«ä½¿ç”¨çš„é”™è¯¯ï¼Œå…·ä½“çš„åœ°å€æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œå°±æ˜¯ <code class="language-plaintext highlighter-rouge">pair.first.data()</code> ï¼Œç»§ç»­æŸ¥çœ‹ ASAN çš„è¾“å‡º</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>READ of size 2 at 0x60300000ef80 thread T0
    #0 0x7f951d7295cd  (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8a5cd)
    #1 0x7f951d729d8a in vprintf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ad8a)
    #2 0x7f951d729e47 in __interceptor_printf (/usr/lib/x86_64-linux-gnu/libasan.so.3+0x8ae47)
    #3 0x55c93507994e in main /data04/playground/cpp/string-piece-uaf/main.cc:19
    #4 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
    #5 0x55c935079669 in _start (/data04/playground/cpp/string-piece-uaf/build/demo+0x2669)

</code></pre></div></div><p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆå¿½ç•¥ Stack Trace ä¿¡æ¯ï¼Œæ¥çœ‹ä¸¤ä¸ªå…³é”®ç‚¹</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>READ of size 2 at 0x60300000ef80 thread T0
</code></pre></div></div><p>è¯´æ˜äº†ï¼Œè¿™ä¸€ä¸ª <code class="language-plaintext highlighter-rouge">heap-use-after-free</code> é—®é¢˜çš„è§¦å‘æ˜¯ç”±è¯»å–è¿™ä¸ªå†…å­˜è€Œå¯¼è‡´çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå†…å­˜åœ¨å“ªé‡Œè¢«é‡Šæ”¾äº†</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x60300000ef80 is located 0 bytes inside of 20-byte region [0x60300000ef80,0x60300000ef94)
freed by thread T0 here:
    #0 0x7f951d7621f0 in operator delete(void*) (/usr/lib/x86_64-linux-gnu/libasan.so.3+0xc31f0)
    #1 0x55c935079e54 in std::pair&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt;::~pair() /usr/include/c++/6/bits/stl_pair.h:194
    #2 0x55c9350798b3 in main /data04/playground/cpp/string-piece-uaf/main.cc:16
    #3 0x7f951b9472e0 in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x202e0)
</code></pre></div></div><p>æ ¹æ®è¿™ä¸ª Call Traceï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¯¹åº”åˆ°ï¼Œåœ¨ä»£ç  <code class="language-plaintext highlighter-rouge">main.cc</code> L16 çš„ä½ç½®ï¼Œè¿™ä¸ª basic string ï¼ˆä¹Ÿå°±æ˜¯ <code class="language-plaintext highlighter-rouge">std::string</code> å°±è¢«é‡Šæ”¾æ‰äº†ã€‚</p><h1 id="analyze">Analyze</h1><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹æœ€åˆçš„ä»£ç ç‰‡æ®µï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“äº†, <code class="language-plaintext highlighter-rouge">std::make_pair</code> ä¼š copy ä¸¤ä¸ª string <code class="language-plaintext highlighter-rouge">s1</code> <code class="language-plaintext highlighter-rouge">s2</code>å¹¶ä¸”äº§ç”Ÿä¸€ä¸ª <code class="language-plaintext highlighter-rouge">std::pair&lt;std::string, std::string&gt;</code> å°†ä»–ä»¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç­‰å·å·¦è¾¹çš„ <code class="language-plaintext highlighter-rouge">StringViewPair</code> ï¼Œè€Œç­‰å·å·¦è¾¹çš„ StringViewPair ä¸ own è¿™ä¸¤å—å†…å­˜ï¼Œåªæ˜¯ä¿å­˜ä¸€ä¸ªåˆ°ä»–ä»¬çš„ Referenceï¼Œå› è€Œï¼Œå½“è¿™ä¸ªæ„é€ ç»“æŸåï¼Œç­‰å·å³è¾¹çš„ <code class="language-plaintext highlighter-rouge">std::pair&lt;std::string, std::string&gt;</code> å°±è¢«é‡Šæ”¾æ‰ï¼Œå› è€Œè¿™ä¸¤ä¸ªæ‹·è´å‡ºæ¥çš„ <code class="language-plaintext highlighter-rouge">std::string</code> çš„å†…å­˜ä¹Ÿéšä¹‹è¢«é‡Šæ”¾æ‰ï¼ˆå¦‚ ASAN çš„è¾“å‡ºï¼‰</p><p>å› æ­¤å°±å¯¼è‡´äº† heap use after free é—®é¢˜çš„å‘ç”Ÿ</p><h1 id="solution">Solution</h1><h2 id="1">#1</h2><p>å› ä¸º C++ ä»…èƒ½æ ¹æ®å³å€¼è¿›è¡Œç±»å‹æ¨æ–­ï¼Œä¸åƒ Rust é‚£æ ·èªæ˜ï¼Œå¯ä»¥æ ¹æ®å³å€¼ä»¥åŠè¯¥å˜é‡çš„ä½¿ç”¨æ–¹å¼è¿›è¡Œç±»å‹æ¨æ–­ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„è§£æ³•ä¹‹ä¸€å°±æ˜¯ï¼Œåœ¨ make pair çš„æ—¶å€™ç»™å‡ºç±»å‹</p><div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">StringViewPair</span> <span class="n">pair</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="o">&lt;</span><span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="p">,</span> <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>
</code></pre></div></div><p>è¿™æ ·ï¼Œåœ¨ make pair çš„æ—¶å€™å°±ä¼šå¾—çŸ¥æˆ‘ä»¬éœ€è¦çš„æ˜¯ <code class="language-plaintext highlighter-rouge">std::pair&lt;absl::string_view, absl::string_view&gt;</code> è€Œé <code class="language-plaintext highlighter-rouge">std::pair&lt;std::string, std::string&gt;</code> , ä»è€Œç›´æ¥æ ¹æ®æ‰€ç»™çš„å‚æ•°è°ƒç”¨ <code class="language-plaintext highlighter-rouge">absl::string_view</code> æ„é€ å‡½æ•°ï¼Œå°† s1, s2 è½¬ä¸º <code class="language-plaintext highlighter-rouge">const std::string&amp;</code> ä¼ é€’ç»™æ„é€ å‡½æ•°ï¼Œé¿å…äº†å°† s1 s2 æ‹·è´å‡ºä¸€ä¸ªä¸´æ—¶çš„å­—ç¬¦ä¸²</p><h2 id="2">#2</h2><p>ä½†æ˜¯ä¸Šé¢è¿™ç§æ”¹æ³•ä¼šè®©ä½ çš„ Linter æŠ±æ€¨èµ·æ¥</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build/explicit_make_pair: For C++11-compatibility, omit template arguments from make_pair OR use pair directly OR if appropriate, construct a pair directly
</code></pre></div></div><p>å› è€Œè¿™é‡Œè¿˜æœ‰ä¸€ç§æ›´ä¸ºç¾è§‚çš„æ”¹æ³•ï¼Œå‚è€ƒ cppreference ä¸Šé¢å¯¹äº <code class="language-plaintext highlighter-rouge">make_pair</code> çš„æè¿°ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">std::ref</code> å°†ä¸¤ä¸ªå¯¹è±¡ <code class="language-plaintext highlighter-rouge">s1</code> <code class="language-plaintext highlighter-rouge">s2</code>è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">std::string&amp;</code> ï¼ˆå®é™…ä¸Šæ˜¯è½¬æ¢ä¸º <code class="language-plaintext highlighter-rouge">reference_wrapper&lt;std::string&gt;</code> ï¼‰ï¼Œä»è€Œå®ç°ç›¸åŒçš„æ•ˆæœå¹¶ä¸”é¿å…äº† Linter çš„è­¦å‘Š</p><h1 id="misc">Misc</h1><p>æœ¬æ–‡ä¸­å±•ç°çš„è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯ StringPiece / string_view çš„ä¸€ä¸ªä½¿ç”¨é™·é˜±ï¼Œå¹¶ä¸”ç›®å‰æ²¡æœ‰å¾ˆå¥½çš„ç¼–è¯‘æœŸæ£€æŸ¥å‡ºè¿™ç§é—®é¢˜çš„æ–¹æ³•</p><p><a href="https://github.com/isocpp/CppCoreGuidelines/issues/1038">https://github.com/isocpp/CppCoreGuidelines/issues/1038</a></p><p>Github ä¸Šå¯¹äºæ­¤é—®é¢˜çš„è®¨è®ºï¼Œæœ€ç»ˆæ­¢äº</p><blockquote><p>the use-after-free potential withÂ <code class="language-plaintext highlighter-rouge">string_view</code> Â is accounted for in the Lifetime profile, even if there may be bugs or limitations in preliminary implementations that mean it is not diagnosed.</p></blockquote><p>å› è€Œï¼Œåœ¨ C++ å¼€å‘ä¸­ï¼Œ<strong>å°† address sanitizer æ—¶åˆ»ä¿æŒå¼€å¯ï¼Œæ˜¯å¾ˆé‡è¦çš„</strong>ï¼Œèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å‘ç°å¾ˆå¤šç¼–è¯‘æœŸæ— æ³•æ£€æŸ¥å‡ºçš„é—®é¢˜</p><p>é‚£ä¹ˆåˆ°è¿™é‡Œäº†ï¼Œæœ¬æ–‡è¿˜æœ‰ä¸€ä¸ªç»“è®ºæ²¡æœ‰è§£é‡Š</p><blockquote><p>From my friend: äººç”Ÿè‹¦çŸ­ï¼Œè¯·ç”¨ Clang</p></blockquote><p>å¯¹ä¸€äº›å¥‡æ€ªçš„ GCC Clang è¡¨ç°æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥ç»§ç»­é˜…è¯»ï¼Œå•çº¯æ¥äº†è§£ StringPiece pitfall çš„æœ‹å‹å¯ä»¥åœ¨è¿™é‡Œåœä¸‹äº†ï¼Œä¸‹é¢è¦ä»‹ç»çš„å†…å®¹å¯èƒ½æ¯”è¾ƒé»‘æš—</p><h2 id="darkness-moment">Darkness Moment</h2><p>ä¸ºäº†ç»§ç»­æˆ‘ä»¬çš„æ—…ç¨‹ï¼Œæˆ‘ä»¬éœ€è¦å¤§å®¶æœ‰å¤šç§ç¼–è¯‘å™¨ï¼Œè¿™æ—¶å€™å°±åº”è¯¥æ‹¿å‡º godbolt åœ¨çº¿ç¼–è¯‘å™¨å¹³å°äº†</p><p>å› ä¸ºæˆ‘æ²¡èƒ½å¤Ÿåœ¨ godbolt é‡ŒæˆåŠŸå¼•ç”¨ absl å¹¶æ„å»ºå‡ºäºŒè¿›åˆ¶ï¼Œåœ¨ godbolt é‡Œå°† absl::string_view æ›¿æ¢ä¸ºäº† leveldb çš„ <code class="language-plaintext highlighter-rouge">Slice</code> ï¼Œå› ä¸ºå„ç±» <code class="language-plaintext highlighter-rouge">string_view</code> çš„å®ç°ï¼Œå°¤å…¶æ˜¯æ„é€ å‡½æ•°çš„å®ç°éƒ½å¾ˆç±»ä¼¼ï¼Œå› è€Œæˆ‘ä»¬çš„é—®é¢˜åœ¨ <code class="language-plaintext highlighter-rouge">Slice</code> ä¸Šä¹Ÿå¯ä»¥å¾—åˆ°å¤ç°</p><p><a href="https://godbolt.org/z/rcvs55zfa">https://godbolt.org/z/rcvs55zfa</a></p><p>ä¸Šé¢è¿™ä¸ªé“¾æ¥é‡Œæ”¾äº†ç±»ä¼¼äºæˆ‘ä»¬æœ¬æ–‡ä¸­æè¿°çš„ use after free é—®é¢˜çš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°åœ¨ GCC çš„æŸäº›ç‰¹å®šç‰ˆæœ¬ä¸‹ï¼ŒASAN ç«Ÿç„¶æ²¡æœ‰æŠ¥é”™</p><p><img src="/assets/imgs/string-piece-uaf1.png" alt="" /></p><p>è€Œå½“æˆ‘ä»¬ç¨åŠ ä¿®æ”¹ L117, å»æ‰ â€œ\nâ€ ä¹‹åï¼Œ asan åˆè¾“å‡ºäº†</p><p><img src="/assets/imgs/string-piece-uaf2.png" alt="" /></p><p>ç»è¿‡ä¸€ç•ªæ’æŸ¥ï¼Œå‘ç°ï¼Œæ˜¯ç”±ä¸¤ä¸ªåŸå› å¯¼è‡´çš„</p><ol><li>æŸäº›ç‰ˆæœ¬çš„ GCCï¼ˆå¦‚ 6.3ï¼‰ä¼šå°† <code class="language-plaintext highlighter-rouge">printf("%s\n");</code> åœ¨ç¼–è¯‘æ—¶è½¬å˜ä¸ºå¯¹ <code class="language-plaintext highlighter-rouge">puts</code> çš„è°ƒç”¨(å¯ä»¥æŸ¥çœ‹ godbolt çš„æ±‡ç¼–ä»£ç è¿›è¡Œç¡®è®¤)</li><li>è€Œ 6.3 çš„ GCC çš„ libasan.so æ°å¥½æ²¡æœ‰å¯¹ <code class="language-plaintext highlighter-rouge">puts</code> è¿›è¡Œ hook</li></ol><p>å› è€Œå¯¼è‡´äº†ä¸Šè¿°æƒ…å†µçš„å‘ç”Ÿï¼Œä¹Ÿå°±è¯´æ˜äº† ASAN å¹¶ä¸æ˜¯ä¸‡èƒ½çš„ï¼Œæƒ³è¦é¿å…ä¸€åˆ‡å†…å­˜é—®é¢˜ï¼Œè¿˜æ˜¯è¦é ç¨‹åºå‘˜è‡ªèº«çš„æœ¬äº‹ï¼ˆğŸ¤¦â€â™€ï¸ï¼‰</p><p>åŒæ—¶æˆ‘ä»¬è¿˜æ³¨æ„åˆ°åœ¨ L114 è¡Œæœ‰ä¸€ä¸ªæ³¨é‡Šï¼Œå½“ä½¿ç”¨ GCC ç‰ˆæœ¬ä½äº 5.0 æ—¶ï¼ˆå¦‚ 4.9.3ï¼‰è¿™ä¸ªå­—ç¬¦ä¸²æ ¹æœ¬ä¸ä¼šè¢« Copyï¼Œç»“æœå°±å¯¼è‡´äº† <code class="language-plaintext highlighter-rouge">s1</code> å’Œ <code class="language-plaintext highlighter-rouge">pair.first</code> æŒ‡å‘äº†ç›¸åŒçš„å­—ç¬¦ä¸²åœ°å€ç©ºé—´ã€‚è¿™æ˜¯å› ä¸ºåœ¨ GCC 5.0 ä»¥ä¸‹ï¼Œå¯¹äºå­—ç¬¦ä¸²æ‹·è´çš„ä¼˜åŒ–ï¼ŒGCC ä½¿ç”¨çš„æ˜¯ COWï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå› ä¸ºæˆ‘ä»¬çš„ä»£ç åœ¨åˆ›å»ºäº† <code class="language-plaintext highlighter-rouge">pair.first</code> åæ²¡æœ‰å¯¹å­—ç¬¦ä¸²æœ‰ä»»ä½•å†™æ“ä½œï¼Œå› è€Œä»–ç›´æ¥å’Œ <code class="language-plaintext highlighter-rouge">s1</code> å…±ç”¨äº†å†…å­˜ï¼Œä¹Ÿå°±æ²¡æœ‰ heap-use-after-free è¿™ä¸ªé—®é¢˜äº†ã€‚</p><h1 id="ending">Ending</h1><p>æœ¬æ–‡çš„äº§å‡ºç¦»ä¸å¼€å‡ ä¸ªæœ‹å‹çš„å¸®åŠ©ï¼Œæ„Ÿè°¢ Weiï¼Œå¯æ€œç­‰æœ‹å‹å¸®å¿™ä¸€èµ· Debug å¥‡æ€ªçš„ ASAN ä¸èƒ½ work çš„é—®é¢˜ï¼ˆçœŸçš„ Debug äº†ä¸¤å¤©æ‰æ‰¾å‡ºé—®é¢˜ã€‚ã€‚ï¼Œæœ¬æ¥è¿™ä¸ªåšå®¢åªéœ€è¦åŠå¤©æ—¶é—´å°±å†™å‡ºæ¥äº†ï¼Œç»“æœæäº†ä¸¤å¤©ï¼‰</p><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>