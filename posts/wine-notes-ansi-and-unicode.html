<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Wine Notes AnsiString and Unicode String</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Wine Notes AnsiString and Unicode String" /><meta name="twitter:description" content="Windows下有两种字符的格式 Unicode 和 ANSI, Windows下的很多API(Rtl系列, 之类的) 是需要认清二者的区别的"><meta name="description" content="Windows下有两种字符的格式 Unicode 和 ANSI, Windows下的很多API(Rtl系列, 之类的) 是需要认清二者的区别的"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/wine-notes-ansi-and-unicode"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Wine Notes AnsiString and Unicode String</h1><time>February 12, 2016</time> <span>[ ]</span></div><div class="divider"></div><p>Windows下有两种字符的格式 <strong>Unicode</strong> 和 <strong>ANSI</strong>, Windows下的很多API(Rtl系列, 之类的) 是需要认清二者的区别的</p><div class="divider"></div><h3 id="二者的对比">二者的对比</h3><p>{% highlight C %} #ifndef <strong>STRING_DEFINED</strong> #define <strong>STRING_DEFINED</strong> typedef struct _STRING { USHORT Length; USHORT MaximumLength; PCHAR Buffer; } STRING, *PSTRING; #endif</p><p>typedef STRING ANSI_STRING; {% endhighlight %}</p><p>而<code class="language-plaintext highlighter-rouge">PCHAR</code> 是　<code class="language-plaintext highlighter-rouge">char*</code> 的一个定义 , 因而ANSI_STRING 每一个字符占一个字节(sizeof(char))</p><p>{% highlight C %} #ifndef <strong>UNICODE_STRING_DEFINED</strong> #define <strong>UNICODE_STRING_DEFINED</strong> typedef struct _UNICODE_STRING { USHORT Length; /* bytes <em>/ USHORT MaximumLength; /</em> bytes */ PWSTR Buffer; } UNICODE_STRING, *PUNICODE_STRING; #endif</p><p>typedef const UNICODE_STRING *PCUNICODE_STRING; {% endhighlight %}</p><p>这里的 PWSTR 的定义是 WCHAR*, 即宽字符指针, 查看WCHAR的定义后知, WCHAR为 (unsigned short) 型(16bit char)</p><div class="divider"></div><h3 id="初始化wchar-的时候要用下面这种形式进行初始化">初始化WCHAR 的时候要用下面这种形式进行初始化:</h3><p>{% highlight C %} WCHAR sample_1[] = L”Example”; WCHAR sample_2[] = {‘E’, ‘x’, ‘a’, ‘m’, ‘p’, ‘l’, ‘e’, 0}; {% endhighlight %}</p><p>一定要注意第二种形式最后的 <code class="language-plaintext highlighter-rouge">0</code></p><div class="divider"></div><h3 id="wchar-char-之间的转换">WCHAR, char 之间的转换</h3><p>二者之间的转换可以通过两个函数来完成, 先将char的字符串转为 <code class="language-plaintext highlighter-rouge">ANSI_STRING</code>, 然后将<code class="language-plaintext highlighter-rouge">ANSI_STRING</code>,转为<code class="language-plaintext highlighter-rouge">UNICODE_STRING</code>, 从而<code class="language-plaintext highlighter-rouge">UNICODE_STRING</code>中的<code class="language-plaintext highlighter-rouge">Buffer</code>即为转换后的结果</p><p>参考Sebastian Lackner 的<a href="http://pastebin.com/raw/m43tkLdT">Sample</a></p><p>通过 <code class="language-plaintext highlighter-rouge">RtlInitAnsiString</code> 将 <code class="language-plaintext highlighter-rouge">filename</code> 的内容写入一个<code class="language-plaintext highlighter-rouge">ANSI_STRING</code> <code class="language-plaintext highlighter-rouge">dospath</code> 内, 然后调用 <code class="language-plaintext highlighter-rouge">RtlAnsiStringToUnicodeString</code> 并且设置 <code class="language-plaintext highlighter-rouge">AllocateDestinationString</code> 为 TRUE, 让这个函数自行分配内存给dospathW, 要注意这种方式分配的内存要用 <code class="language-plaintext highlighter-rouge">RtlFreeUnicodeString</code> 手动回收</p><div class="divider"></div><h3 id="wine-下打印wchar">Wine 下打印WCHAR</h3><p>使用函数 wine_dbgstr_* 系列函数, 这里使用 wine_dbgstr_w, 打印宽字符</p><h3 id="防止内存泄露"><em>防止内存泄露</em></h3><ul><li>使用<code class="language-plaintext highlighter-rouge">RtlInitAnsiString</code>创建的字符串不需要手动Free</li><li>使用<code class="language-plaintext highlighter-rouge">RtlAnsiStringToUnicodeString</code>, 并且<code class="language-plaintext highlighter-rouge">AllocateDestinationString</code>为<code class="language-plaintext highlighter-rouge">TRUE</code>的话需要手动释放内存</li><li>使用<code class="language-plaintext highlighter-rouge">wine_nt_to_unix_filename</code>得到的<code class="language-plaintext highlighter-rouge">ANSI_STRING</code>需要手动释放内存</li></ul><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>