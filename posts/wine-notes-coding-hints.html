<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Wine Notes -- Coding Hints</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Wine Notes -- Coding Hints" /><meta name="twitter:description" content="About Coding Style(Habit)"><meta name="description" content="About Coding Style(Habit)"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/wine-notes-coding-hints"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Wine Notes -- Coding Hints</h1><time>February 12, 2016</time> <span>[ ]</span></div><div class="divider"></div><h2 id="about-coding-stylehabit">About Coding Style(Habit)</h2><ul><li>代码风格模仿上下文的代码风格, 比如 wpcap.c 内所有的if语句风格都是if<space>(exp), 那么新写的代码也要是这个风格</space></li><li>一定要使用恰当的变量类型, 例如<code class="language-plaintext highlighter-rouge">int status</code>要改为<code class="language-plaintext highlighter-rouge">NTSTATUS status</code>之类的</li><li>在<code class="language-plaintext highlighter-rouge">TRACE</code> 的前后加入空行,增加代码的可读性</li><li>在修改某一个bug的时候, 要保证将引起这个bug的所有代码, 以及和这个bug相关的所有代码修改掉, 多用grep</li><li>ok 宏测试到的参数就不需要trace输出了</li><li>函数定义一定要含有调用惯例(Coding Conventions) CDECL STDCALL..</li><li>函数参数类型不要用 LP* P* 同时变量名也不要以p开头, 变量名常用全小写字母</li><li>spec 文件里的 ordinal number 忽略掉 用 @ 代替, 现在已经不关心 ordinal number 了</li><li>TRACE 信息要尽量少(?)</li><li>if while for 后面加 空格 再加 “()”</li><li>if内只有一个语句的话不要加大括号</li><li>给代码块和代码块之间加上一定的空行使得代码可读性更好</li></ul><h2 id="about-error-handling">About Error Handling</h2><ul><li>在自己编写的函数中, 调用其他的函数出现错误的时候, 要注意处理错误, 需要在Win下写testcase进行对比</li><li>错误处理的时候, 注意设置好返回值, 以及Errorcode, SetLastError用于设定ErrorCode</li><li>不要用十六进制数字表示错误, 用定义好的宏来表示 (e.g. 不要用 <code class="language-plaintext highlighter-rouge">0x3</code> 用 <code class="language-plaintext highlighter-rouge">ERROR_PATH_NOTFOUND</code>)</li><li>不需要关注代码成功运行的时候错误代码是什么, 在代码运行正确的时候不会去考虑错误代码的问题</li><li>不要自己做NTSTATUS -&gt; ERROR Code 的映射, 直接使用函数 <code class="language-plaintext highlighter-rouge">RtlNtStatusToDosError</code> 即可</li><li>注意Calling Convention 要对应上</li></ul><h2 id="about-memory">About Memory</h2><ul><li>当程序SEGFAULT的时候, 注意检查是否出现了 Double-free 的情况</li><li>自己写的代码要注意避免memory leak, 所有手动分配的内存都要记得收回, 同时要注意WinAPI的说明, 有的函数也需要手动收回内存</li><li>使用HeapAlloc而不是malloc分配内存, 使用HeapFreee而不是free释放内存</li><li>HeapAlloc 分配内存之后检查内存分配是否成功</li><li>每一个return PATH 之前都要将内存Free掉</li><li>不需要分配内存就能解决的问题就不要进行内存分配</li></ul><h2 id="handle-build-warning">Handle Build Warning</h2><ul><li>如果是下面这个错错误: {% highlight shell %} In file included from wpcap.c:26:0: ../../include/ntstatus.h:331:0: warning: “STATUS_FLOAT_UNDERFLOW” redefined #define STATUS_FLOAT_UNDERFLOW ((NTSTATUS) 0xC0000093)</li></ul><p>In file included from ../../include/windef.h:266:0, from ../../include/windows.h:37, from ../../include/winsock.h:110, from ../../include/winsock2.h:47, from wpcap.c:22: ../../include/winnt.h:607:0: note: this is the location of the previous definition #define STATUS_FLOAT_UNDERFLOW ((DWORD) 0xC0000093) {% endhighlight %}</p><p>那么用下面的方法来解决: 将<code class="language-plaintext highlighter-rouge">#include "ntstatus.h"</code>放在include最上面, 然后紧跟着 <code class="language-plaintext highlighter-rouge">#define WIN32_NO_STATUS</code></p><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>