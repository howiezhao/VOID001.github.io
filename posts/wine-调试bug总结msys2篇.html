<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Wine 调试bug总结(MSYS2篇)</title><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@" /><meta name="twitter:title" content="Wine 调试bug总结(MSYS2篇)" /><meta name="twitter:description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="description" content="The content is recoverd from Wordpress Blog, for more details please check HERE"><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"><link rel="icon" href="/assets/favicon.png"><link rel="apple-touch-icon" href="/assets/touch-icon.png"><link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css"><link rel="stylesheet" href="/assets/core.css"><link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet"><link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/styles/github.min.css" rel="stylesheet"><link rel="canonical" href="/posts/wine-%E8%B0%83%E8%AF%95bug%E6%80%BB%E7%BB%93msys2%E7%AF%87"><link rel="alternate" type="application/atom+xml" title="VOID001's WOWO" href="/feed.xml" /> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga( 'create', 'UA-73703130-2', 'auto' ); ga( 'send', 'pageview' ); </script></head><body><aside class="logo"> <a href="/"> <img src="/assets/avatar.jpeg" class="gravatar"> </a> <span class="logo-prompt">Back to Home</span></aside><div class="footer-flex" style="margin-bottom: 4px"> Thinking, Coding, Improving</div><div class="footer-flex" style="color: #333333"> <a href="http://github.com/VOID001"><i class="fa-brands fa-lg fa-github"></i></a> <span style="margin: 4px"></span> <a href="https://t.me/s/void001_fav"><i class="fa-brands fa-lg fa-telegram"></i></a> <span style="margin: 4px"></span> <a href="/feed"><i class="fa-solid fa-lg fa-rss"></i></a></div><script src="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.1.1/js/fontawesome.min.js"></script><main> <noscript><style> article .footnotes { display: block; }</style></noscript><article><div class="center"><h1>Wine 调试bug总结(MSYS2篇)</h1><time>August 22, 2015</time> <span>[ ]</span></div><div class="divider"></div><p>The content is recoverd from Wordpress Blog, for more details please check <a href="recover-my-blog">HERE</a></p><h5 id="august-22-2015"><a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/linux/wine-%e8%b0%83%e8%af%95bug%e6%80%bb%e7%bb%93msys2%e7%af%87.html" title="10:22 am">August 22, 2015</a></h5><p><a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/author/void001" title="View all posts by VOID001">VOID001</a> Comments <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/linux/wine-%e8%b0%83%e8%af%95bug%e6%80%bb%e7%bb%93msys2%e7%af%87.html#respond">0 Comment</a></p><p>我将如何调试MSYS2中的某个开源程序的bug的过程总结下来,提供给需要的人</p><p>1.配置好环境</p><p>– 获得wine-staging的源码</p><ul><li><p>clone最新的wine代码</p></li><li><p>clone wine-staging的代码</p></li><li><p>在wine-staging下使用 patchinstall.sh脚本 将wine-staging的改动应用到wine的代码树上</p></li></ul><p>– 编译并安装wine</p><ul><li><p>安装编译wine需要的库文件(参见Winehq的官方资料)</p></li><li><p>configure并且编译安装代码</p></li></ul><p>2.利用自己配置好的环境重现bug 注意一定要下载正确版本的代码进行编译3.下载要debug的软件安装的源码并且编译成有符号表的程序 在 gdb下调试 利用step in 和 next 等命令 ,找出bug发生的地方(就是出现fault 的那个点)</p><p>-在MSYS2下git clone不可以用 因此需在Linux下进行某些代码的clone 然后再makepkg的时候i记得加上 –noextract 参数</p><p>– 学习PKGBUILD的语法和写法</p><p>– 学习makepkg 等指令 ( 如果不能通过checksum checkpgp 就用 –skippgpcheck 和 –skipchecksums 跳过)</p><p>4.阅读该程序的源代码 , 从bug发生的点向上找, 找出问题所在 , 定位到函数内, ( 如果bug是因为SIGSEGV , 那么找出哪个变量的访问发生了SIGSEGV, 并且确定出何时这个变量不能被access了)</p><p>5.通过搜集到的信息写出POSIX C 的测试样例 重现此bug (此时应该结合Google man page 以及各种资料 找出你要使用的函数的用法,以及作用)</p><p>7.进一步研究自己写好的测试样例, 用 RELAY日志把程序运行时的系统日志收集到</p><p>–  根据要记录的日志的模块的不同 WINEDEBUG后加不同的参数 , 不过所有的都要 WINEDEBUG=+relay,+tid,+server , 而且要注意 server加上后 ,先执行</p><p>wineserver -k 然后再启动你要调试的程序 ,server的日志只有在第一个wine的进程启动时,启动server才会记录 , 关于这些参数的意义 +relay表示输出relay日志 , +tid表示打印日志的时候带有线程号 , +server表示i记录下server的详细日志</p><p>– 得到日志之后 需要对日志进行处理,才能获得有用的信息 ,处理方法如下</p><ul><li><p>先grep “Starting process” (大小写自己确认一下) 然后找到你运行的程序的名字 ,然后找到进程号</p></li><li><p>grep那个进程号,将结果存下来</p></li><li><p> 根据你修复的bug不同 ,可能有不同的特点 ,比如特殊的参数 或者特殊的字符串(如打开的文件的名字) 找到与这个bug关系密切的系统函数 , 大致理解这个bug是由什么样的系统调用产生的.</p></li><li><p>关于如何读relay的日志 , 参考Wine -Developer manual</p></li><li><p>将关键的行提取出来,形成一个新的日志 ,并且整理出调用关系 .</p></li></ul><p>6.进一步将调用的细节确定下来</p><p>– 编译安装MSYS2-runtime的代码,要有 -g 参数 (如果编译完成不了的话,甚至源码无法get到的话 ,请看第三步)</p><ul><li><p>编译安装的几个细节 ,首先PKGBUILD里的options一定要有debug, runtime的代码库要自己先clone好 同时要注意使用noextract , 编译好pkg文件之后 将两个.pkg.tar.xz文件一起安装 用 pacman -U .pkg.tar.xz 即可,也可以到PKG文件（名称记不清楚）里修改，把git的地址修改成自己本地的源码</p></li><li><p>安装好之后需要重启一下 MSYS2 ,然后 对程序进行单步调试, step in 到MSYS2-runtime的代码 , 找出和这个bug有关的系统调用,然后 整理出来整个系统调用的详细脉络,包括每次调用的参数</p></li></ul><p>(这里要注意一点: 如果某个参数是一个指针 ,要记录下来这个指针指向的内容的各个参数 , 而不是仅仅记录这个地址)</p><p>7.写出WinAPI版本的测试用例</p><ul><li>根据6收集到的足够的信息 , 然后可以开始写样例了~</li><li>根据收集到的信息写好样例( 最好将所有16进制的数都写成英文宏定义的形式)</li><li>在Windows上和Linux上进行样例的测试 . 检测一致性</li></ul><hr /><p><a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/category/linux">Linux</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/category/wine">wine</a> <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/c-linux">C. Linux</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/kernel">kernel</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/laravel">Laravel</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/php">PHP</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/python">Python</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/shell">Shell</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/web">Web</a>, <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/tag/wine">wine</a></p><hr /><h2 id="historical-comments">Historical Comments</h2><p>Post navigation ————— <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/uncategorized/csapp-linking-%e5%ad%a6%e4%b9%a0%e6%80%bb%e7%bb%93.html">NEXT<br /> CSAPP Linking 学习总结</a> <a href="https://web.archive.org/web/20210120184254/https://void-shana.moe/acmalgo/cf-543a-writing-code-%e5%ae%8c%e5%85%a8%e8%83%8c%e5%8c%85%e9%97%ae%e9%a2%98.html">PREVIOUS CF 543A Writing Code 完全背包问题</a></p><script src="https://giscus.app/client.js" data-repo="VOID001/VOID001.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMzI0MDI4NQ==" data-category="Announcements" data-category-id="DIC_kwDOAfs03c4COSSU" data-mapping="pathname" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="light" data-lang="en" data-loading="lazy" crossorigin="anonymous" async> </script></article><div class="back"> <a href="/">Back</a></div><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/11.5.0/highlight.min.js"></script> <script>hljs.highlightAll();</script></main></body></html>